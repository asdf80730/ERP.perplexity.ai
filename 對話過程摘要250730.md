好的，我理解了。雖然功能還未完全完善，但現階段整理和回顧是非常重要的。

我將為您提供詳細的對話過程摘要、完整的當前規格表（包括表格欄位、運作流程、與使用者對話注意事項），並且會**直接提供完整的程式碼，不作任何省略**。

---

### **對話過程總結**

我們的對話從最初的 Google Apps Script 庫存管理系統開發需求開始，逐步細化了前端 UI/UX，並最終嘗試實現更友好的批量操作。

1.  **初始需求確認與基礎架構搭建：**
    *   您需要一個基於 Google Sheet 的庫存管理系統。
    *   系統應包含：庫存查詢、地點管理、產品管理、新增交易、交易記錄功能。
    *   強調了手機友善、快速響應、操作直覺的需求。
    *   我提供了首個 `Code.gs` (後端) 和 `index.html` (前端) 版本，具備基礎增查功能和反應式設計。

2.  **UI/UX 優化 (第一階段)：**
    *   針對手機版，將導航改為下拉選單。
    *   增加了表單輸入框和按鈕的尺寸，提升觸控體驗。
    *   統一了 UI 樣式，使用了 Tailwind CSS CDN。
    *   針對新增地點、產品、交易，建議使用**模態框 (Modal)** 替代直接在主頁面操作，以改善數據錄入流程。
    *   模態框內部支持**批量暫存**，即用戶可以連續新增多個地點/產品/交易，然後一次性確認提交。
    *   此階段增加了 `processModalBatchOperations` 後端函數，用於接收模態框的批量新增請求。
    *   我提供了包含這些改進的 `index.html` 和 `Code.gs` 更新。

3.  **UI/UX 優化 (第二階段) - 批量刪除與同步機制調整：**
    *   您提出刪除功能應改為**批量操作**，而非每行一個刪除按鈕。
    *   我提出了在「地點管理」和「產品管理」頁面引入**編輯模式**：點擊「編輯/刪除」按鈕後，表格顯示核取方塊供用戶勾選。
    *   勾選後，點擊「確認刪除」將選中的項目加入 `pendingOperations`（前端暫存）。
    *   最初的設計是讓用戶再點擊主頁面底部的「同步資料到 Google Sheet」按鈕來提交這些 `pendingOperations`。
    *   我提供了實現批量刪除前端 UI 的 `index.html` 更新。

4.  **UI/UX 優化 (第三階段) - 移除全域同步按鈕：**
    *   您提出既然新增操作已是模態框內提交即同步，批量刪除也已暫存，那麼主頁面的「同步資料到 Google Sheet」按鈕可以移除。
    *   我同意並將流程調整為：當用戶點擊批量刪除的「確認刪除」按鈕後，**直接觸發後端同步**，無需額外的全域同步按鈕。
    *   我提供了移除全域同步按鈕，並讓批量刪除直接觸發同步的 `index.html` 更新，並提示了 `Code.gs` 中 `processBatchOperations` 函數的必要性。

**當前存在的問題：**

根據您的反饋：「功能不正常」。這可能指的是：
*   **批量刪除後未同步成功？**
*   **UI 狀態未正確更新？**
*   **錯誤處理或提示不足？**
*   **刪除後數據沒有正確從庫存中移除？** (這是比較複雜的業務邏輯，我們只實現了從 master data 中刪除，沒有聯動更新 inventory。)

這些都屬於調試和完善階段需要解決的問題。

---

### **當前規格表**

#### **1. 系統功能模組與運作流程**

**總體目標：** 建立一個基於 Google Sheet 的簡易庫存管理系統，提供直覺且手機友善的 Web 介面。

**模組列表：**

*   **1.1 庫存查詢 (Inventory Query)**
*   **1.2 地點管理 (Location Management)**
*   **1.3 產品管理 (Product Management)**
*   **1.4 新增交易 (Transaction Entry)**
*   **1.5 交易記錄 (Transaction History)**

**詳細運作流程：**

**1. 系統初始化與數據載入：**
    *   用戶首次打開 Web App 或刷新頁面時，前端 (JavaScript) 會通過 `google.script.run` 調用後端 (Apps Script) 的 `getAllInitialData()` 函數。
    *   `getAllInitialData()` 函數從 Google Sheet 的 "Locations"、"Products"、"Inventory" 和 "Transactions" 工作表中讀取所有數據。
    *   後端將數據組合成一個 JSON 對象返回給前端。
    *   前端 `initializeAppData()` 函數接收數據，並將其緩存在全局變數 `appData` 中 (`appData.locations`, `appData.products`, `appData.inventory`, `appData.transactions`)。
    *   同時，根據這些數據填充所有下拉選單（例如：庫存查詢的地點/品牌/類別，新增交易的產品/地點）。
    *   默認顯示「庫存查詢」Tab，並觸發一次庫存查詢（即 `queryInventory()`）。

**2. Tab 切換：**
    *   用戶點擊導航欄的 Tab 按鈕（或手機上的下拉選單）切換模組。
    *   `switchTab()` 函數負責：
        *   隱藏當前活躍 Tab，顯示目標 Tab。
        *   更新導航按鈕的活躍狀態。
        *   在切換到「地點管理」或「產品管理」時，**會重置其編輯模式**，確保核取方塊和刪除按鈕狀態正確。
        *   觸發目標 Tab 的數據顯示（例如：`filterLocations()`, `filterProducts()`, `filterTransactions()`, `queryInventory()`）。

**3. 庫存查詢 (Inventory Query)：**
    *   **輸入：** 用戶可選擇地點、產品品牌、產品類別進行篩選。
    *   **操作：** 點擊「查詢庫存」按鈕觸發 `queryInventory()`。
    *   **前端處理：** `queryInventory()` 函數根據用戶選擇的篩選條件，從前端緩存的 `appData.inventory` 數據中進行過濾。
    *   **顯示：** 將過濾後的庫存數據（包括產品ID、名稱、品牌、類別、地點名稱、數量）顯示在表格中。

**4. 地點管理 (Location Management) / 產品管理 (Product Management)：**
    *   **搜索/篩選：** 文本輸入框實時篩選顯示的列表 (`filterLocations()`, `filterProducts()`)。
    *   **新增：**
        *   點擊「新增地點/產品」按鈕，打開一個模態框。
        *   用戶在模態框內輸入信息，點擊「新增 (暫存於此視窗)」按鈕，將數據暫存於 `modalPendingLocations` 或 `modalPendingProducts` 數組中，並顯示在模態框內部的表格。
        *   用戶可以重複新增多個條目。
        *   點擊模態框內的「確認新增」按鈕觸發 `confirmModalLocations()` / `confirmModalProducts()`。
        *   **同步：** 這些函數會調用後端 `processModalBatchOperations()`，將暫存的新增數據提交到 Google Sheet。成功後，重新載入所有數據並關閉模態框。
    *   **批量刪除：**
        *   點擊「編輯/刪除」按鈕，進入編輯模式：表格每行左側出現核取方塊，同時「編輯/刪除」按鈕變為「確認刪除」和「取消編輯」。
        *   用戶勾選一個或多個要刪除的項目。
        *   點擊「取消編輯」：退出編輯模式，不做任何刪除操作。
        *   點擊「確認刪除」按鈕：
            *   收集所有被勾選的項目 ID。
            *   將這些 ID 儲存到 `pendingOperations.deleteLocationIds` 或 `pendingOperations.deleteProductIds`。
            *   **同步：** 立刻調用 `syncDeleteOperations()` 函數。
            *   `syncDeleteOperations()` 會向後端發送包含這些 ID 的請求，執行實際的刪除操作。
            *   同步過程中，會顯示「正在刪除...」的提示信息，並禁用按鈕。
            *   成功刪除後，後端會返回最新數據，前端會重新載入數據，退出編輯模式，並清除提示信息。

**5. 新增交易 (Transaction Entry)：**
    *   **新增：**
        *   點擊「新增交易」按鈕，打開一個模態框。
        *   用戶在模態框內選擇交易類型、產品、地點，輸入數量和備註。
        *   點擊「新增 (暫存於此視窗)」按鈕，將數據暫存於 `modalPendingTransactions` 數組中，並顯示在模態框內部的表格。
        *   用戶可以重複新增多個交易。
        *   點擊模態框內的「確認新增」按鈕觸發 `confirmModalTransactions()`。
        *   **同步：** 這些函數會調用後端 `processModalBatchOperations()`，將暫存的新增交易數據提交到 Google Sheet。成功後，重新載入所有數據並關閉模態框。

**6. 交易記錄 (Transaction History)：**
    *   **搜索/篩選：** 文本輸入框實時篩選顯示的列表 (`filterTransactions()`)，可根據類型、產品、地點、備註進行搜索。
    *   **顯示：** 顯示所有交易記錄，包括交易ID、類型、產品名稱、地點名稱、數量、時間戳、備註。數據源為 `appData.transactions`。

#### **2. 表格欄位定義 (Google Sheet Schemas)**

**a. Locations (地點)**
*   `LocationID` (String): 地點唯一標識符 (由 Apps Script 自動生成，前綴 "L")
*   `LocationName` (String): 地點名稱 (例如: "倉庫", "店面", "貨架A")

**b. Products (產品)**
*   `ProductID` (String): 產品唯一標識符 (由 Apps Script 自動生成，前綴 "P")
*   `ProductName` (String): 產品名稱 (例如: "筆記型電腦", "滑鼠", "鍵盤")
*   `Brand` (String): 品牌 (例如: "Dell", "Logitech", "Razer")
*   `Category` (String): 類別 (例如: "電子產品", "辦公用品", "配件")

**c. Inventory (庫存)**
*   `InventoryID` (String): 庫存記錄唯一標識符 (由 Apps Script 自動生成，前綴 "I")
*   `ProductID` (String): 產品唯一標識符 (外鍵，鏈接到 Products 表)
*   `LocationID` (String): 地點唯一標識符 (外鍵，鏈接到 Locations 表)
*   `Quantity` (Number): 該產品在該地點的數量

**d. Transactions (交易)**
*   `TransactionID` (String): 交易記錄唯一標識符 (由 Apps Script 自動生成，前綴 "T")
*   `Timestamp` (String): 交易時間戳 (格式例如: "2023/10/27 14:30:00")
*   `Type` (String): 交易類型 ("In" 入庫, "Out" 出庫)
*   `ProductID` (String): 產品唯一標識符 (外鍵)
*   `LocationID` (String): 地點唯一標識符 (外鍵)
*   `Quantity` (Number): 交易數量
*   `Notes` (String): 備註 (可選)

#### **3. 與使用者對話應注意的事**

在與實際使用者交流時，由於這是一個仍在開發中的應用，需要特別注意以下幾點：

1.  **明確告知狀態：**
    *   **「功能不完善」：** 直接告知使用者「目前系統仍在測試與開發階段，部分功能可能存在問題或不符合最終預期。」
    *   **「數據同步」：**
        *   對於新增操作（地點、產品、交易），強調「數據在您點擊『確認新增』後會即時同步到後台」。
        *   對於刪除操作，強調「選中並點擊『確認刪除』後，數據會立即從後台移除」。
    *   **「界面響應」：** 告知使用者在執行新增/刪除操作時，界面可能會短暫顯示「正在處理...」或按鈕禁用，這是正常現象，請耐心等待。

2.  **收集詳細反饋：**
    *   **錯誤復現步驟：** 當使用者報告「功能不正常」時，務必追問具體的復現步驟、看到什麼錯誤訊息、預期行為是什麼。
    *   **截圖/錄屏：** 如果可能，請使用者提供錯誤發生時的截圖或簡短錄屏，這對調試非常有幫助。
    *   **用戶期望：** 詢問他們對每個功能的最終期望，這有助於後續的功能完善和優化。

3.  **數據安全提醒：**
    *   由於這是直接操作 Google Sheet，提醒使用者「請勿直接在 Google Sheet 中修改 ID 欄位，否則可能導致數據錯亂」。
    *   對於敏感數據，強調目前系統並未實現用戶身份驗證和權限管理，僅適用於信任環境或個人使用。

4.  **未實現功能說明：**
    *   **庫存自動更新：** **特別重要！** 目前系統的交易記錄只會新增，但不會自動更新 `Inventory` 表中的 `Quantity`。請明確告知使用者，並說明這是未來需要實現的功能。例如：「目前的交易記錄只做日誌用途，庫存總量需要手動調整或等待後續功能更新。」
    *   **庫存刪除關聯：** 目前刪除產品或地點，不會自動刪除或更新 `Inventory` 表中相關的記錄。這可能導致 `Inventory` 表中存在無效的 `ProductID` 或 `LocationID`。這也需要告知使用者。
    *   **編輯功能：** 目前只有新增和刪除，沒有直接的編輯功能。

5.  **積極溝通：**
    *   保持開放和積極的態度，讓使用者感受到他們的意見受到重視。
    *   定期匯報進度，即使是很小的改進。

---

### **完整程式碼 (當前版本)**

以下是當前狀態下，完整的 `Code.gs` 和 `index.html` 程式碼。

#### **1. `Code.gs` (Google Apps Script)**

```javascript
const SCRIPT_PROPERTIES_KEY_SS_ID = 'SPREADSHEET_ID'; // 用於儲存試算表 ID 的屬性鍵

const LOCATION_SHEET_NAME = 'Locations';
const PRODUCT_SHEET_NAME = 'Products';
const INVENTORY_SHEET_NAME = 'Inventory';
const TRANSACTION_SHEET_NAME = 'Transactions';

/**
 * 首次運行時調用此函數，設置項目屬性中的試算表 ID。
 * 建議只運行一次，或者在新的 Google Sheet 副本上運行。
 */
function setSpreadsheetId() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  PropertiesService.getScriptProperties().setProperty(SCRIPT_PROPERTIES_KEY_SS_ID, ss.getId());
  Logger.log('Spreadsheet ID set: ' + ss.getId());
  // 創建必要的工作表
  createSheets();
}

/**
 * 確保所有必要的工作表都存在。
 */
function createSheets() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sheetNames = [
    LOCATION_SHEET_NAME,
    PRODUCT_SHEET_NAME,
    INVENTORY_SHEET_NAME,
    TRANSACTION_SHEET_NAME
  ];

  const sheetHeaders = {
    [LOCATION_SHEET_NAME]: ['LocationID', 'LocationName'],
    [PRODUCT_SHEET_NAME]: ['ProductID', 'ProductName', 'Brand', 'Category'],
    [INVENTORY_SHEET_NAME]: ['InventoryID', 'ProductID', 'LocationID', 'Quantity'],
    [TRANSACTION_SHEET_NAME]: ['TransactionID', 'Timestamp', 'Type', 'ProductID', 'LocationID', 'Quantity', 'Notes']
  };

  sheetNames.forEach(name => {
    let sheet = ss.getSheetByName(name);
    if (!sheet) {
      sheet = ss.insertSheet(name);
      // 寫入標頭
      if (sheetHeaders[name]) {
        sheet.getRange(1, 1, 1, sheetHeaders[name].length).setValues([sheetHeaders[name]]);
      }
      Logger.log('Created sheet: ' + name);
    }
  });
}

/**
 * 網頁應用程式的入口點。
 * @returns {HtmlOutput}
 */
function doGet() {
  return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setTitle('簡易庫存管理系統')
      .setFaviconUrl('https://www.google.com/s2/favicons?domain=script.google.com'); // 替換為您的應用程式圖標
}

/**
 * 獲取所有初始數據 (地點、產品、庫存、交易)。
 * 在前端初始化時調用。
 * @returns {Object} 包含所有數據的對象。
 */
function getAllInitialData() {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    const locations = getSheetData(ss, LOCATION_SHEET_NAME);
    const products = getSheetData(ss, PRODUCT_SHEET_NAME);
    const inventory = getSheetData(ss, INVENTORY_SHEET_NAME);
    const transactions = getSheetData(ss, TRANSACTION_SHEET_NAME);

    return { locations, products, inventory, transactions };
  } catch (e) {
    Logger.log('Error in getAllInitialData: ' + e.message);
    return { error: true, message: e.message };
  }
}

/**
 * 輔助函數：從指定工作表獲取所有數據，並轉換為對象陣列。
 * @param {GoogleAppsScript.Spreadsheet.Spreadsheet} ss
 * @param {string} sheetName
 * @returns {Array<Object>}
 */
function getSheetData(ss, sheetName) {
  const sheet = ss.getSheetByName(sheetName);
  if (!sheet) {
    Logger.log(`Sheet "${sheetName}" not found.`);
    return [];
  }
  const range = sheet.getDataRange();
  const values = range.getValues();
  if (values.length === 0) {
    return [];
  }
  const headers = values[0];
  const data = [];
  for (let i = 1; i < values.length; i++) {
    const row = values[i];
    const rowObject = {};
    headers.forEach((header, index) => {
      rowObject[header] = row[index];
    });
    data.push(rowObject);
  }
  return data;
}

/**
 * 處理來自前端模態框的批量新增操作。
 * @param {Object} operations 包含 addLocations, addProducts, addTransactions 數組的對象。
 * @returns {Object} 包含 success 狀態和 message，以及所有最新數據的對象。
 */
function processModalBatchOperations(operations) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();

    // 處理新增地點
    if (operations.addLocations && operations.addLocations.length > 0) {
      const locationSheet = ss.getSheetByName(LOCATION_SHEET_NAME);
      const newRows = operations.addLocations.map(loc => {
        const newId = generateUniqueId(locationSheet, 'L', 0); // 假設 LocationID 在第0列
        return [newId, loc.locationName];
      });
      locationSheet.getRange(locationSheet.getLastRow() + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
    }

    // 處理新增產品
    if (operations.addProducts && operations.addProducts.length > 0) {
      const productSheet = ss.getSheetByName(PRODUCT_SHEET_NAME);
      const newRows = operations.addProducts.map(prod => {
        const newId = generateUniqueId(productSheet, 'P', 0); // 假設 ProductID 在第0列
        return [newId, prod.productName, prod.brand || '', prod.category || ''];
      });
      productSheet.getRange(productSheet.getLastRow() + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
    }

    // 處理新增交易
    if (operations.addTransactions && operations.addTransactions.length > 0) {
      const transactionSheet = ss.getSheetByName(TRANSACTION_SHEET_NAME);
      const newRows = operations.addTransactions.map(trans => {
        const newId = generateUniqueId(transactionSheet, 'T', 0); // 假設 TransactionID 在第0列
        const timestamp = new Date().toLocaleString('sv-SE'); // YYYY-MM-DD HH:MM:SS 格式
        return [newId, timestamp, trans.type, trans.productId, trans.locationId, trans.quantity, trans.notes || ''];
      });
      transactionSheet.getRange(transactionSheet.getLastRow() + 1, 1, newRows.length, newRows[0].length).setValues(newRows);
    }

    // 成功後，重新獲取所有數據，以便前端更新緩存
    const latestData = getAllInitialData();
    return { success: true, message: '操作已成功。', data: latestData };

  } catch (e) {
    Logger.log('Error in processModalBatchOperations: ' + e.message);
    return { success: false, message: `操作失敗: ${e.message}` };
  }
}

/**
 * 處理來自前端的批量刪除操作。
 * @param {Object} operations 包含 deleteLocationIds, deleteProductIds 數組的對象。
 * @returns {Object} 包含 success 狀態和 message，以及所有最新數據的對象。
 */
function processBatchOperations(operations) {
  try {
    const ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // 處理批量刪除地點
    if (operations.deleteLocationIds && operations.deleteLocationIds.length > 0) {
      const locationSheet = ss.getSheetByName(LOCATION_SHEET_NAME);
      const data = locationSheet.getDataRange().getValues();
      const header = data[0];
      const locationIdColIndex = header.indexOf('LocationID');
      
      if (locationIdColIndex === -1) {
        throw new Error('地點工作表缺少 "LocationID" 欄位。');
      }

      const rowsToDelete = [];
      // 從底部往上遍歷，這樣刪除行時索引不會錯亂
      for (let i = data.length - 1; i >= 1; i--) { // 從第二行開始 (索引1)
        if (operations.deleteLocationIds.includes(data[i][locationIdColIndex])) {
          rowsToDelete.push(i + 1); // Apps Script 的行數是從1開始
        }
      }

      // 執行刪除
      rowsToDelete.forEach(rowNum => locationSheet.deleteRow(rowNum));
    }

    // 處理批量刪除產品
    if (operations.deleteProductIds && operations.deleteProductIds.length > 0) {
      const productSheet = ss.getSheetByName(PRODUCT_SHEET_NAME);
      const data = productSheet.getDataRange().getValues();
      const header = data[0];
      const productIdColIndex = header.indexOf('ProductID');

      if (productIdColIndex === -1) {
        throw new Error('產品工作表缺少 "ProductID" 欄位。');
      }

      const rowsToDelete = [];
      for (let i = data.length - 1; i >= 1; i--) {
        if (operations.deleteProductIds.includes(data[i][productIdColIndex])) {
          rowsToDelete.push(i + 1);
        }
      }
      rowsToDelete.forEach(rowNum => productSheet.deleteRow(rowNum));
    }

    // 成功後，重新載入所有數據並返回，以便前端一次性更新
    const latestData = getAllInitialData(); 
    return { success: true, message: '操作已成功同步。', data: latestData };

  } catch (e) {
    return { success: false, message: `同步失敗: ${e.message}` };
  }
}

/**
 * 生成一個在指定工作表中獨一無二的 ID。
 * ID 格式為：[前綴][年月日時分秒毫秒][3位隨機字母數字]。
 * @param {GoogleAppsScript.Spreadsheet.Sheet} sheet 目標工作表。
 * @param {string} prefix ID 的前綴 (例如 'L', 'P', 'I', 'T')。
 * @param {number} idColumnIndex 包含 ID 的列的索引 (從 0 開始)。
 * @returns {string} 獨一無二的 ID。
 */
function generateUniqueId(sheet, prefix, idColumnIndex) {
  const existingIds = sheet.getRange(2, idColumnIndex + 1, sheet.getLastRow() - 1, 1).getValues().flat(); // 獲取現有 ID

  let newId;
  let isUnique = false;
  let attempts = 0;
  const MAX_ATTEMPTS = 10; 

  while (!isUnique && attempts < MAX_ATTEMPTS) {
    const now = new Date();
    const year = String(now.getFullYear()).slice(-2); 
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const seconds = String(now.getSeconds()).padStart(2, '0');
    const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
    
    // 生成一個短隨機字符串作為後綴，增加唯一性
    const randomSuffix = Math.random().toString(36).substring(2, 5).toUpperCase(); // 例如：'A1B'

    newId = `${prefix}${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}${randomSuffix}`;
    isUnique = !existingIds.includes(newId);
    attempts++;
    if (!isUnique) {
      Utilities.sleep(1); // 短暫延遲以確保毫秒數變化
    }
  }

  if (!isUnique) {
    // 如果嘗試了多次仍無法生成唯一ID，則拋出錯誤
    throw new Error('無法在多次嘗試後生成唯一的ID，請稍後重試。');
  }

  return newId;
}
```

#### **2. `index.html` (前端 UI)**

```html
<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>簡易庫存管理系統</title>
    <!-- Tailwind CSS v4 JIT Mode CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <style>
        /* General styles not handled by Tailwind, or overrides */
        body {
            font-family: sans-serif;
            background-color: #f3f4f6;
            color: #333;
            font-size: 1.6rem; /* Base font size significantly increased (approx 26px) */
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 30px; /* More padding for overall content */
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 40px; /* Even more margin */
        }
        .header h1 {
            font-size: 3rem; /* Significantly larger main heading (approx 48px) */
            font-weight: bold;
        }
        /* Tab button styles - now primarily for desktop, hidden on mobile by default */
        .tab-button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background-color: transparent;
            font-size: 1.5rem; /* Larger tab buttons */
            color: #4b5563;
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        .tab-button.active {
            border-bottom: 3px solid #3b82f6;
            color: #1f2937;
            font-weight: bold;
        }
        /* Tabs content display control */
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }

        /* Form group labels - ensure readability */
        .form-group label {
            font-size: 1.5rem; /* Larger labels */
            margin-bottom: 12px; /* More space between label and input */
        }

        /* Input, Select, Textarea - significantly larger for touch and readability */
        input[type="text"], 
        input[type="number"], 
        select, 
        textarea {
            font-size: 1.5rem; /* Larger font inside inputs */
            padding: 18px 22px; /* Increased padding for easier tapping */
            height: auto; /* Allow height to adjust */
            line-height: normal; /* Ensure text aligns properly */
        }

        /* Buttons - larger for easier tapping */
        button {
            font-size: 1.5rem; /* Larger button text */
            padding: 18px 30px; /* Larger button area */
            margin-top: 25px; /* More space above button */
        }

        /* Titles for sections (e.g., 庫存查詢, 地點管理) */
        .tab-content h2 {
            font-size: 2.2rem; /* Larger section titles */
            margin-bottom: 25px;
            display: flex; /* Allow content inside h2 to align */
            justify-content: space-between; /* Space out title and button */
            align-items: center; /* Vertically align items */
        }
        /* Special button style for Add button next to title */
        .tab-content h2 button {
            font-size: 1.2rem; /* Smaller button for inline use */
            padding: 10px 20px;
            margin-top: 0; /* Remove top margin */
        }


        .tab-content h3 {
            font-size: 2rem; /* Larger sub-titles */
            margin-top: 40px;
            margin-bottom: 20px;
        }

        /* Basic table styles - ensure good readability */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.5rem; /* Table content font size significantly increased */
            margin-top: 25px;
            margin-bottom: 25px;
        }
        th, td {
            border: 1px solid #e2e8f0;
            padding: 18px; /* Increased padding for better touch targets and readability */
            text-align: left;
        }
        th {
            background-color: #f8f8f8;
            font-size: 1.55rem; /* Larger table header font */
            white-space: nowrap; /* Prevent headers from wrapping too much */
        }
        
        /* Specific select box for mobile nav */
        #mobile-nav-select {
            font-size: 1.5rem;
            padding: 18px 22px;
            margin-bottom: 30px; /* More space below nav */
        }

        /* Message paragraphs (e.g., success/error messages) */
        p.mt-2.text-sm {
            font-size: 1.3rem; /* Increase size for messages */
            margin-top: 15px;
        }

        /* Responsive Design: Hide desktop tabs on small screens, show mobile select */
        @media (max-width: 768px) {
            #desktop-nav-tabs {
                display: none !important; /* Force hide desktop tabs */
            }
            #mobile-nav-select {
                display: block !important; /* Force show mobile select */
            }
        }

        /* Responsive Design: Show desktop tabs on larger screens, hide mobile select */
        @media (min-width: 769px) {
            #desktop-nav-tabs {
                display: flex !important; /* Force show desktop tabs */
            }
            #mobile-nav-select {
                display: none !important; /* Force hide mobile select */
            }
        }

        /* --- Modal Styles --- */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center; /* Center content horizontally */
            align-items: center; /* Vertically align items */
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* Ensures it's centered in the modal container */
            padding: 40px; /* More padding for modal content */
            border: 1px solid #888;
            width: 90%; /* Adjust width as needed */
            max-width: 800px; /* Increased max width for modal content */
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative; /* Needed for close button positioning */
            display: flex; /* Use flexbox for internal layout */
            flex-direction: column; /* Stack children vertically */
        }

        .modal-content h3 {
            margin-top: 0; /* Override default h3 margin */
            margin-bottom: 25px; /* More space after modal title */
            font-size: 2.2rem; /* Larger modal title */
        }

        .modal-content button {
            margin-top: 25px; /* More space above modal buttons */
        }

        .modal-close-button {
            color: #aaa;
            float: right;
            font-size: 48px; /* Larger close button */
            font-weight: bold;
            position: absolute;
            right: 20px;
            top: 10px;
            cursor: pointer;
        }

        .modal-close-button:hover,
        .modal-close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* Specific styles for modal tables */
        .modal-content .modal-section-title {
            font-size: 1.8rem;
            margin-top: 30px;
            margin-bottom: 15px;
            font-weight: bold;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .modal-content table {
            width: 100%;
            border-collapse: collapse;
            font-size: 1.4rem; /* Slightly smaller for modal tables */
            margin-top: 15px;
        }
        .modal-content th, .modal-content td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .modal-content th {
            background-color: #f0f0f0;
        }
        .modal-content .delete-btn-modal {
            font-size: 0.9rem; /* Smaller delete button in modal */
            padding: 4px 8px;
            margin: 0;
            cursor: pointer;
        }

        /* Table specific styles for checkboxes */
        .edit-mode .checkbox-cell {
            display: table-cell; /* Show checkbox cell in edit mode */
        }
        .checkbox-cell {
            width: 40px; /* Fixed width for checkbox column */
            text-align: center;
            display: none; /* Hidden by default */
        }
        .checkbox-cell input[type="checkbox"] {
            transform: scale(1.5); /* Make checkbox larger */
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="text-2xl font-bold">簡易庫存管理系統</h1>
        </div>

        <!-- Mobile Navigation Select - Hidden on Desktop -->
        <select id="mobile-nav-select" class="w-full p-2 mb-4 border border-gray-300 rounded" onchange="switchTab(this.value)">
            <option value="inventory-query">庫存查詢</option>
            <option value="location-management">地點管理</option>
            <option value="product-management">產品管理</option>
            <option value="transaction-entry">新增交易</option>
            <option value="transaction-history">交易記錄</option>
        </select>

        <!-- Desktop Navigation Tabs - Hidden on Mobile -->
        <div id="desktop-nav-tabs" class="justify-center mb-4 border-b-2 border-gray-200">
            <button class="tab-button" onclick="switchTab('inventory-query')">庫存查詢</button>
            <button class="tab-button" onclick="switchTab('location-management')">地點管理</button>
            <button class="tab-button" onclick="switchTab('product-management')">產品管理</button>
            <button class="tab-button" onclick="switchTab('transaction-entry')">新增交易</button>
            <button class="tab-button" onclick="switchTab('transaction-history')">交易記錄</button>
        </div>

        <!-- Inventory Query Tab Content -->
        <div id="inventory-query" class="tab-content active">
            <h2 class="text-xl font-semibold mb-4">庫存查詢</h2>
            <div class="form-group mb-4">
                <label for="queryLocation" class="block text-gray-700 text-sm font-bold mb-2">地點:</label>
                <select id="queryLocation" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- 所有地點 --</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="form-group mb-4">
                <label for="queryProductBrand" class="block text-gray-700 text-sm font-bold mb-2">品牌:</label>
                <select id="queryProductBrand" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- 所有品牌 --</option>
                </select>
            </div>
            <div class="form-group mb-4">
                <label for="queryProductCategory" class="block text-gray-700 text-sm font-bold mb-2">類別:</label>
                <select id="queryProductCategory" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- 所有類別 --</option>
                </select>
            </div>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="queryInventory()">查詢庫存</button>

            <h3 class="text-lg font-semibold mt-6 mb-2">庫存列表</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b">產品ID</th>
                            <th class="py-2 px-4 border-b">產品名稱</th>
                            <th class="py-2 px-4 border-b">品牌</th>
                            <th class="py-2 px-4 border-b">類別</th>
                            <th class="py-2 px-4 border-b">地點名稱</th>
                            <th class="py-2 px-4 border-b">數量</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody">
                        <!-- Inventory data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Location Management Tab Content -->
        <div id="location-management" class="tab-content">
            <h2 class="text-xl font-semibold mb-4">
                <span>地點管理</span>
                <div class="flex space-x-2">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="openAddLocationModal()">新增地點</button>
                    <button id="toggleLocationEditButton" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="toggleEditMode('location')">編輯/刪除</button>
                    <button id="cancelLocationEditButton" class="hidden bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="cancelEditMode('location')">取消編輯</button>
                    <button id="confirmLocationDeleteButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="confirmBatchDelete('location')">確認刪除</button>
                </div>
            </h2>

            <!-- Search/Filter for Locations -->
            <div class="form-group mb-4">
                <label for="locationSearch" class="block text-gray-700 text-sm font-bold mb-2">篩選地點名稱:</label>
                <input type="text" id="locationSearch" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onkeyup="filterLocations()">
            </div>
            
            <h3 class="text-lg font-semibold mt-6 mb-2">地點列表</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200" id="locationsTable">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b checkbox-cell"></th> <!-- Checkbox header -->
                            <th class="py-2 px-4 border-b">地點ID</th>
                            <th class="py-2 px-4 border-b">地點名稱</th>
                        </tr>
                    </thead>
                    <tbody id="locationsTableBody">
                        <!-- Location data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Product Management Tab Content -->
        <div id="product-management" class="tab-content">
            <h2 class="text-xl font-semibold mb-4">
                <span>產品管理</span>
                <div class="flex space-x-2">
                    <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="openAddProductModal()">新增產品</button>
                    <button id="toggleProductEditButton" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="toggleEditMode('product')">編輯/刪除</button>
                    <button id="cancelProductEditButton" class="hidden bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="cancelEditMode('product')">取消編輯</button>
                    <button id="confirmProductDeleteButton" class="hidden bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="confirmBatchDelete('product')">確認刪除</button>
                </div>
            </h2>

            <!-- Search/Filter for Products -->
            <div class="form-group mb-4">
                <label for="productSearch" class="block text-gray-700 text-sm font-bold mb-2">篩選產品名稱/品牌/類別:</label>
                <input type="text" id="productSearch" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onkeyup="filterProducts()">
            </div>
            
            <h3 class="text-lg font-semibold mt-6 mb-2">產品列表</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200" id="productsTable">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b checkbox-cell"></th> <!-- Checkbox header -->
                            <th class="py-2 px-4 border-b">產品ID</th>
                            <th class="py-2 px-4 border-b">產品名稱</th>
                            <th class="py-2 px-4 border-b">品牌</th>
                            <th class="py-2 px-4 border-b">類別</th>
                        </tr>
                    </thead>
                    <tbody id="productsTableBody">
                        <!-- Product data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Transaction Entry Tab Content -->
        <div id="transaction-entry" class="tab-content">
            <h2 class="text-xl font-semibold mb-4">
                <span>新增交易</span>
                <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="openAddTransactionModal()">新增交易</button>
            </h2>

            <p class="mt-4 text-gray-600">在此頁面中新增的交易將會被暫存，直到您點擊「同步資料到 Google Sheet」。</p>
        </div>

        <!-- Transaction History Tab Content -->
        <div id="transaction-history" class="tab-content">
            <h2 class="text-xl font-semibold mb-4">所有交易記錄</h2>

            <!-- Search/Filter for Transactions -->
            <div class="form-group mb-4">
                <label for="transactionHistorySearch" class="block text-gray-700 text-sm font-bold mb-2">篩選交易類型/產品/地點/備註:</label>
                <input type="text" id="transactionHistorySearch" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" onkeyup="filterTransactions()">
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b">交易ID</th>
                            <th class="py-2 px-4 border-b">類型</th>
                            <th class="py-2 px-4 border-b">產品名稱</th>
                            <th class="py-2 px-4 border-b">地點名稱</th>
                            <th class="py-2 px-4 border-b">數量</th>
                            <th class="py-2 px-4 border-b">時間戳</th>
                            <th class="py-2 px-4 border-b">備註</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTableBody">
                        <!-- Transaction data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No more global sync button or sync message -->
        <!-- <div class="text-center mt-8 p-4 bg-gray-100 border border-gray-200 rounded">
            <button id="syncButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded focus:outline-none focus:shadow-outline text-xl" onclick="syncData()">
                同步資料到 Google Sheet (0 個待同步)
            </button>
            <p id="syncMessage" class="mt-2 text-sm text-gray-600"></p>
        </div> -->

    </div>

    <!-- Modals for Add Forms -->
    <!-- Add Location Modal -->
    <div id="addLocationModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeAddLocationModal()">&times;</span>
            <h3>新增地點</h3>
            <div class="form-group mb-4">
                <label for="modalNewLocationName" class="block text-gray-700 text-sm font-bold mb-2">地點名稱:</label>
                <input type="text" id="modalNewLocationName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="addLocationToModalList()">新增 (暫存於此視窗)</button>
            <p id="modalLocationMessage" class="mt-2 text-sm text-red-500"></p>

            <h4 class="modal-section-title">目前暫存地點 (僅在此視窗有效)</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b">地點名稱</th>
                            <th class="py-2 px-4 border-b">操作</th>
                        </tr>
                    </thead>
                    <tbody id="modalLocationsTableBody">
                        <!-- Modal's temporary location data will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="confirmModalLocations()">確認新增</button>
                <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-2" onclick="closeAddLocationModal()">取消 (捨棄暫存)</button>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
    <div id="addProductModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeAddProductModal()">&times;</span>
            <h3>新增產品</h3>
            <div class="form-group mb-4">
                <label for="modalNewProductName" class="block text-gray-700 text-sm font-bold mb-2">產品名稱:</label>
                <input type="text" id="modalNewProductName" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="form-group mb-4">
                <label for="modalNewProductBrand" class="block text-gray-700 text-sm font-bold mb-2">品牌:</label>
                <input type="text" id="modalNewProductBrand" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="form-group mb-4">
                <label for="modalNewProductCategory" class="block text-gray-700 text-sm font-bold mb-2">類別:</label>
                <input type="text" id="modalNewProductCategory" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="addProductToModalList()">新增 (暫存於此視窗)</button>
            <p id="modalProductMessage" class="mt-2 text-sm text-red-500"></p>

            <h4 class="modal-section-title">目前暫存產品 (僅在此視窗有效)</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b">產品名稱</th>
                            <th class="py-2 px-4 border-b">品牌</th>
                            <th class="py-2 px-4 border-b">類別</th>
                            <th class="py-2 px-4 border-b">操作</th>
                        </tr>
                    </thead>
                    <tbody id="modalProductsTableBody">
                        <!-- Modal's temporary product data will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="confirmModalProducts()">確認新增</button>
                <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-2" onclick="closeAddProductModal()">取消 (捨棄暫存)</button>
            </div>
        </div>
    </div>

    <!-- Add Transaction Modal -->
    <div id="addTransactionModal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" onclick="closeAddTransactionModal()">&times;</span>
            <h3>新增交易記錄</h3>
            <div class="form-group mb-4">
                <label for="modalTransactionType" class="block text-gray-700 text-sm font-bold mb-2">交易類型:</label>
                <select id="modalTransactionType" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="In">入庫</option>
                    <option value="Out">出庫</option>
                </select>
            </div>
            <div class="form-group mb-4">
                <label for="modalTransactionProduct" class="block text-gray-700 text-sm font-bold mb-2">產品:</label>
                <select id="modalTransactionProduct" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- 請選擇 --</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="form-group mb-4">
                <label for="modalTransactionLocation" class="block text-gray-700 text-sm font-bold mb-2">地點:</label>
                <select id="modalTransactionLocation" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                    <option value="">-- 請選擇 --</option>
                    <!-- Options will be populated by JS -->
                </select>
            </div>
            <div class="form-group mb-4">
                <label for="modalTransactionQuantity" class="block text-gray-700 text-sm font-bold mb-2">數量:</label>
                <input type="number" id="modalTransactionQuantity" value="1" min="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
            </div>
            <div class="form-group mb-4">
                <label for="modalTransactionNotes" class="block text-gray-700 text-sm font-bold mb-2">備註:</label>
                <textarea id="modalTransactionNotes" rows="3" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline"></textarea>
            </div>
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="addTransactionToModalList()">新增 (暫存於此視窗)</button>
            <p id="modalTransactionMessage" class="mt-2 text-sm text-red-500"></p>

            <h4 class="modal-section-title">目前暫存交易 (僅在此視窗有效)</h4>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200">
                    <thead>
                        <tr>
                            <th class="py-2 px-4 border-b">類型</th>
                            <th class="py-2 px-4 border-b">產品名稱</th>
                            <th class="py-2 px-4 border-b">地點名稱</th>
                            <th class="py-2 px-4 border-b">數量</th>
                            <th class="py-2 px-4 border-b">備註</th>
                            <th class="py-2 px-4 border-b">操作</th>
                        </tr>
                    </thead>
                    <tbody id="modalTransactionsTableBody">
                        <!-- Modal's temporary transaction data will be loaded here -->
                    </tbody>
                </table>
            </div>
            <div class="flex justify-end mt-4">
                <button class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline" onclick="confirmModalTransactions()">確認新增</button>
                <button class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline ml-2" onclick="closeAddTransactionModal()">取消 (捨棄暫存)</button>
            </div>
        </div>
    </div>


    <script>
        // --- Global Data Caching ---
        let appData = {
            locations: [],
            products: [],
            inventory: [],
            transactions: []
        };

        // --- Pending Operations for Batching (global, only for delete operations now) ---
        // This will hold the IDs of items to be deleted by the confirmBatchDelete function
        let pendingOperations = {
            deleteLocationIds: [],
            deleteProductIds: [],
        };

        // --- MODAL-SPECIFIC Temporary Storage ---
        let modalPendingLocations = [];
        let modalPendingProducts = [];
        let modalPendingTransactions = [];

        // --- Edit Mode State (for batch delete) ---
        let isLocationEditMode = false;
        let isProductEditMode = false;

        // NOTE: updateSyncButton is no longer needed as there's no global sync button

        // Helper to generate a unique ID on the frontend (similar to backend logic now)
        function generateFrontendTempId(prefix) {
            const now = new Date();
            const year = String(now.getFullYear()).slice(-2); 
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const milliseconds = String(now.getMilliseconds()).padStart(3, '0');
            
            const randomSuffix = Math.random().toString(36).substring(2, 5).toUpperCase();

            return `${prefix}${year}${month}${day}${hours}${minutes}${seconds}${milliseconds}${randomSuffix}`;
        }

        // Helper to check if an ID is a frontend generated temporary ID (now only for modal list, not main display)
        function isTempId(id, prefix) {
            const expectedLengthAfterPrefix = 15 + 3; 
            if (!id.startsWith(prefix) || id.length !== prefix.length + expectedLengthAfterPrefix) {
                return false;
            }
            const timestampPart = id.substring(prefix.length, prefix.length + 15);
            return /^\d{15}$/.test(timestampPart);
        }

        document.addEventListener('DOMContentLoaded', function() {
            google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
            
            switchTab('inventory-query'); 
            // updateSyncButton(); // No longer needed

            window.onclick = function(event) {
                if (event.target.classList.contains('modal')) {
                    if (event.target.id === 'addLocationModal') closeAddLocationModal();
                    else if (event.target.id === 'addProductModal') closeAddProductModal();
                    else if (event.target.id === 'addTransactionModal') closeAddTransactionModal();
                }
            }
        });

        function initializeAppData(data) {
            appData.locations = data.locations || [];
            appData.products = data.products || [];
            appData.inventory = data.inventory || [];
            appData.transactions = data.transactions || [];

            console.log('App Data Initialized:', appData); 

            populateAllDropdowns();
            
            const currentActiveTabId = document.querySelector('.tab-content.active').id;
            if (currentActiveTabId) {
                if (currentActiveTabId === 'location-management') filterLocations();
                else if (currentActiveTabId === 'product-management') filterProducts();
                else if (currentActiveTabId === 'transaction-history') filterTransactions();
                else if (currentActiveTabId === 'inventory-query') queryInventory();
            }
            // updateSyncButton(); // No longer needed
        }

        function populateAllDropdowns() {
            populateSelect(document.getElementById('queryLocation'), appData.locations, 'LocationID', 'LocationName', '-- 所有地點 --');
            populateUniqueValuesSelect(document.getElementById('queryProductBrand'), appData.products, 'Brand', '-- 所有品牌 --');
            populateUniqueValuesSelect(document.getElementById('queryProductCategory'), appData.products, 'Category', '-- 所有類別 --');

            populateSelect(document.getElementById('modalTransactionProduct'), appData.products, 'ProductID', 'ProductName', '-- 請選擇產品 --');
            populateSelect(document.getElementById('modalTransactionLocation'), appData.locations, 'LocationID', 'LocationName', '-- 請選擇地點 --');
        }

        function populateSelect(selectElement, data, valueKey, textKey, defaultOptionText = '-- 請選擇 --') {
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            if (data && data.length > 0) {
                data.forEach(function(item) {
                    var option = document.createElement('option');
                    option.value = item[valueKey];
                    option.textContent = item[textKey];
                    selectElement.appendChild(option);
                });
            }
        }

        function populateUniqueValuesSelect(selectElement, data, valueKey, defaultOptionText = '-- 請選擇 --') {
            selectElement.innerHTML = `<option value="">${defaultOptionText}</option>`;
            if (data && data.length > 0) {
                const uniqueValues = [...new Set(data.map(item => item[valueKey]).filter(Boolean))]; 
                uniqueValues.sort(); 
                uniqueValues.forEach(value => {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = value;
                    selectElement.appendChild(option);
                });
            }
        }

        function switchTab(tabId) {
            document.querySelectorAll('#desktop-nav-tabs .tab-button').forEach(btn => btn.classList.remove('active'));
            const activeTabButton = document.querySelector(`#desktop-nav-tabs .tab-button[onclick="switchTab('${tabId}')"]`);
            if (activeTabButton) {
                activeTabButton.classList.add('active');
            }

            var tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(function(tab) {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');

            var mobileSelect = document.getElementById('mobile-nav-select');
            mobileSelect.value = tabId;

            // Reset edit mode when switching tabs
            isLocationEditMode = false;
            isProductEditMode = false;
            document.getElementById('locationsTable').classList.remove('edit-mode');
            document.getElementById('productsTable').classList.remove('edit-mode');
            document.getElementById('toggleLocationEditButton').classList.remove('hidden');
            document.getElementById('cancelLocationEditButton').classList.add('hidden');
            document.getElementById('confirmLocationDeleteButton').classList.add('hidden');
            document.getElementById('toggleProductEditButton').classList.remove('hidden');
            document.getElementById('cancelProductEditButton').classList.add('hidden');
            document.getElementById('confirmProductDeleteButton').classList.add('hidden');


            if (tabId === 'location-management') {
                filterLocations(); 
            } else if (tabId === 'product-management') {
                filterProducts(); 
            } else if (tabId === 'transaction-entry') {
                // No table to filter here
            } else if (tabId === 'transaction-history') {
                filterTransactions(); 
            } else if (tabId === 'inventory-query') {
                queryInventory(); 
            }
            // updateSyncButton(); // No longer needed
        }

        // --- Inventory Query Functions (using frontend cached data) ---
        function queryInventory() {
            const selectedLocationId = document.getElementById('queryLocation').value;
            const selectedBrand = document.getElementById('queryProductBrand').value;
            const selectedCategory = document.getElementById('queryProductCategory').value;

            const tableBody = document.getElementById('inventoryTableBody');
            tableBody.innerHTML = ''; 

            const filteredInventory = appData.inventory.filter(inv => {
                const locationMatch = !selectedLocationId || inv.LocationID === selectedLocationId;
                const product = appData.products.find(p => p.ProductID === inv.ProductID);
                const brandMatch = !selectedBrand || (product && product.Brand === selectedBrand);
                const categoryMatch = !selectedCategory || (product && product.Category === selectedCategory);
                return locationMatch && brandMatch && categoryMatch;
            });

            if (filteredInventory.length > 0) {
                filteredInventory.forEach(inv => {
                    const locationName = appData.locations.find(loc => loc.LocationID === inv.LocationID)?.LocationName || '未知地點';
                    const product = appData.products.find(p => p.ProductID === inv.ProductID);
                    const productName = product?.ProductName || '未知產品';
                    const productBrand = product?.Brand || 'N/A';
                    const productCategory = product?.Category || 'N/A';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${inv.ProductID}</td>
                        <td>${productName}</td>
                        <td>${productBrand}</td>
                        <td>${productCategory}</td>
                        <td>${locationName}</td>
                        <td>${inv.Quantity}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">沒有找到符合條件的庫存記錄。</td></tr>`;
            }
        }

        // --- Location Management Functions ---
        function openAddLocationModal() {
            modalPendingLocations = []; // Clear previous modal session's data
            renderModalLocations(); // Render empty table
            document.getElementById('addLocationModal').style.display = 'flex';
            document.getElementById('modalNewLocationName').value = ''; 
            document.getElementById('modalLocationMessage').textContent = ''; 
        }
        function closeAddLocationModal() {
            modalPendingLocations = []; // Discard data
            document.getElementById('addLocationModal').style.display = 'none';
            document.getElementById('modalNewLocationName').value = ''; 
            document.getElementById('modalLocationMessage').textContent = ''; 
        }

        function addLocationToModalList() {
            const name = document.getElementById('modalNewLocationName').value.trim();
            if (!name) {
                document.getElementById('modalLocationMessage').textContent = '地點名稱不能為空。';
                return;
            }

            if (modalPendingLocations.some(loc => loc.locationName === name)) {
                document.getElementById('modalLocationMessage').textContent = '此地點名稱已在暫存列表中。';
                return;
            }

            const tempId = generateFrontendTempId('L'); 
            modalPendingLocations.push({ locationName: name, tempId: tempId });
            
            document.getElementById('modalNewLocationName').value = ''; 
            document.getElementById('modalLocationMessage').textContent = '地點已新增到暫存列表。';
            renderModalLocations();
        }

        function deleteModalLocation(tempId) {
            modalPendingLocations = modalPendingLocations.filter(loc => loc.tempId !== tempId);
            renderModalLocations();
        }

        function renderModalLocations() {
            const tableBody = document.getElementById('modalLocationsTableBody');
            tableBody.innerHTML = '';

            if (modalPendingLocations.length > 0) {
                modalPendingLocations.forEach(loc => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${loc.locationName}</td>
                        <td><button onclick="deleteModalLocation('${loc.tempId}')" class="bg-red-500 hover:bg-red-700 text-white delete-btn-modal">刪除</button></td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="2" style="text-align: center;">目前沒有暫存地點。</td></tr>`;
            }
        }

        function confirmModalLocations() {
            if (modalPendingLocations.length === 0) {
                alert('沒有任何地點可以新增。');
                return;
            }

            document.getElementById('modalLocationMessage').textContent = '正在新增地點，請稍候...';
            document.getElementById('addLocationModal').querySelector('button[onclick="confirmModalLocations()"]').disabled = true;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        initializeAppData(response.data); 
                        document.getElementById('modalLocationMessage').textContent = '地點已成功新增並同步。';
                        closeAddLocationModal(); 
                    } else {
                        document.getElementById('modalLocationMessage').textContent = `新增失敗: ${response.message}`;
                    }
                    document.getElementById('addLocationModal').querySelector('button[onclick="confirmModalLocations()"]').disabled = false;
                })
                .withFailureHandler(function(error) {
                    document.getElementById('modalLocationMessage').textContent = `新增時發生錯誤: ${error.message}`;
                    document.getElementById('addLocationModal').querySelector('button[onclick="confirmModalLocations()"]').disabled = false;
                })
                .processModalBatchOperations({ addLocations: modalPendingLocations });
        }


        // Filter function for locations (displays all locations)
        function filterLocations() {
            const searchTerm = document.getElementById('locationSearch').value.toLowerCase();
            const tableBody = document.getElementById('locationsTableBody');
            tableBody.innerHTML = '';

            const filtered = appData.locations.filter(loc => {
                return loc.LocationName.toLowerCase().includes(searchTerm) ||
                       loc.LocationID.toLowerCase().includes(searchTerm);
            });

            if (filtered.length > 0) {
                const sortedLocations = [...filtered].sort((a, b) => a.LocationID.localeCompare(b.LocationID));

                sortedLocations.forEach(row => {
                    const tr = document.createElement('tr');
                    // Add highlight for pending delete items
                    if (pendingOperations.deleteLocationIds.includes(row.LocationID)) {
                        tr.classList.add('bg-red-200');
                    }
                    
                    // Conditionally show checkbox or empty cell
                    tr.innerHTML = `
                        <td class="checkbox-cell">
                            <input type="checkbox" data-id="${row.LocationID}" ${pendingOperations.deleteLocationIds.includes(row.LocationID) ? 'checked' : ''}>
                        </td>
                        <td>${row.LocationID}</td>
                        <td>${row.LocationName}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="3" style="text-align: center;">沒有找到符合條件的地點記錄。</td></tr>`;
            }
        }
        
        // --- Product Management Functions ---
        function openAddProductModal() {
            modalPendingProducts = []; 
            renderModalProducts(); 
            document.getElementById('addProductModal').style.display = 'flex';
            document.getElementById('modalNewProductName').value = '';
            document.getElementById('modalNewProductBrand').value = '';
            document.getElementById('modalNewProductCategory').value = '';
            document.getElementById('modalProductMessage').textContent = '';
        }
        function closeAddProductModal() {
            modalPendingProducts = []; 
            document.getElementById('addProductModal').style.display = 'none';
            document.getElementById('modalNewProductName').value = '';
            document.getElementById('modalNewProductBrand').value = '';
            document.getElementById('modalNewProductCategory').value = '';
            document.getElementById('modalProductMessage').textContent = '';
        }

        function addProductToModalList() {
            const name = document.getElementById('modalNewProductName').value.trim();
            const brand = document.getElementById('modalNewProductBrand').value.trim();
            const category = document.getElementById('modalNewProductCategory').value.trim();

            if (!name) {
                document.getElementById('modalProductMessage').textContent = '產品名稱不能為空。';
                return;
            }

            if (modalPendingProducts.some(p => p.productName === name && p.brand === brand && p.category === category)) {
                document.getElementById('modalProductMessage').textContent = '此產品已在暫存列表中。';
                return;
            }

            const tempId = generateFrontendTempId('P');
            modalPendingProducts.push({ 
                productName: name, 
                brand: brand, 
                category: category, 
                tempId: tempId 
            });

            document.getElementById('modalNewProductName').value = '';
            document.getElementById('modalNewProductBrand').value = '';
            document.getElementById('modalNewProductCategory').value = '';
            document.getElementById('modalProductMessage').textContent = '產品已新增到暫存列表。';
            renderModalProducts();
        }

        function deleteModalProduct(tempId) {
            modalPendingProducts = modalPendingProducts.filter(prod => prod.tempId !== tempId);
            renderModalProducts();
        }

        function renderModalProducts() {
            const tableBody = document.getElementById('modalProductsTableBody');
            tableBody.innerHTML = '';

            if (modalPendingProducts.length > 0) {
                modalPendingProducts.forEach(prod => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${prod.productName}</td>
                        <td>${prod.brand || 'N/A'}</td>
                        <td>${prod.category || 'N/A'}</td>
                        <td><button onclick="deleteModalProduct('${prod.tempId}')" class="bg-red-500 hover:bg-red-700 text-white delete-btn-modal">刪除</button></td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center;">目前沒有暫存產品。</td></tr>`;
            }
        }

        function confirmModalProducts() {
            if (modalPendingProducts.length === 0) {
                alert('沒有任何產品可以新增。');
                return;
            }

            document.getElementById('modalProductMessage').textContent = '正在新增產品，請稍候...';
            document.getElementById('addProductModal').querySelector('button[onclick="confirmModalProducts()"]').disabled = true;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        initializeAppData(response.data); 
                        document.getElementById('modalProductMessage').textContent = '產品已成功新增並同步。';
                        closeAddProductModal(); 
                    } else {
                        document.getElementById('modalProductMessage').textContent = `新增失敗: ${response.message}`;
                    }
                    document.getElementById('addProductModal').querySelector('button[onclick="confirmModalProducts()"]').disabled = false;
                })
                .withFailureHandler(function(error) {
                    document.getElementById('modalProductMessage').textContent = `新增時發生錯誤: ${error.message}`;
                    document.getElementById('addProductModal').querySelector('button[onclick="confirmModalProducts()"]').disabled = false;
                })
                .processModalBatchOperations({ addProducts: modalPendingProducts });
        }

        // Filter function for products (displays all products)
        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const tableBody = document.getElementById('productsTableBody');
            tableBody.innerHTML = '';

            const filtered = appData.products.filter(prod => {
                return prod.ProductName.toLowerCase().includes(searchTerm) ||
                       (prod.Brand && prod.Brand.toLowerCase().includes(searchTerm)) ||
                       (prod.Category && prod.Category.toLowerCase().includes(searchTerm)) ||
                       prod.ProductID.toLowerCase().includes(searchTerm);
            });

            if (filtered.length > 0) {
                const sortedProducts = [...filtered].sort((a, b) => a.ProductID.localeCompare(b.ProductID));

                sortedProducts.forEach(row => {
                    const tr = document.createElement('tr');
                    // Add highlight for pending delete items
                    if (pendingOperations.deleteProductIds.includes(row.ProductID)) {
                        tr.classList.add('bg-red-200');
                    }

                    tr.innerHTML = `
                        <td class="checkbox-cell">
                            <input type="checkbox" data-id="${row.ProductID}" ${pendingOperations.deleteProductIds.includes(row.ProductID) ? 'checked' : ''}>
                        </td>
                        <td>${row.ProductID}</td>
                        <td>${row.ProductName}</td>
                        <td>${row.Brand || 'N/A'}</td>
                        <td>${row.Category || 'N/A'}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">沒有找到符合條件的產品記錄。</td></tr>`;
            }
        }


        // --- Batch Delete Logic ---
        function toggleEditMode(type) { // type can be 'location' or 'product'
            let tableElement, toggleButton, confirmButton, cancelButton, isEditModeVar;
            let currentPendingIds;

            if (type === 'location') {
                tableElement = document.getElementById('locationsTable');
                toggleButton = document.getElementById('toggleLocationEditButton');
                confirmButton = document.getElementById('confirmLocationDeleteButton');
                cancelButton = document.getElementById('cancelLocationEditButton');
                isEditModeVar = isLocationEditMode;
                currentPendingIds = pendingOperations.deleteLocationIds;
            } else if (type === 'product') {
                tableElement = document.getElementById('productsTable');
                toggleButton = document.getElementById('toggleProductEditButton');
                confirmButton = document.getElementById('confirmProductDeleteButton');
                cancelButton = document.getElementById('cancelProductEditButton');
                isEditModeVar = isProductEditMode;
                currentPendingIds = pendingOperations.deleteProductIds;
            }

            if (!isEditModeVar) { // Enter edit mode
                tableElement.classList.add('edit-mode');
                toggleButton.classList.add('hidden');
                confirmButton.classList.remove('hidden');
                cancelButton.classList.remove('hidden');

                // Check previously selected items (if any from current session)
                tableElement.querySelectorAll('.checkbox-cell input[type="checkbox"]').forEach(checkbox => {
                    if (currentPendingIds.includes(checkbox.dataset.id)) {
                        checkbox.checked = true;
                    } else {
                        checkbox.checked = false; // Uncheck any that were unchecked/unselected before
                    }
                });
                if (type === 'location') isLocationEditMode = true;
                else if (type === 'product') isProductEditMode = true;
            } else { // Exit edit mode without confirming (toggle button now confirms)
                // This path should ideally not be hit directly by toggle button anymore, but by confirm/cancel
            }
        }

        function cancelEditMode(type) {
            let tableElement, toggleButton, confirmButton, cancelButton;
            if (type === 'location') {
                tableElement = document.getElementById('locationsTable');
                toggleButton = document.getElementById('toggleLocationEditButton');
                confirmButton = document.getElementById('confirmLocationDeleteButton');
                cancelButton = document.getElementById('cancelLocationEditButton');
                isLocationEditMode = false;
            } else if (type === 'product') {
                tableElement = document.getElementById('productsTable');
                toggleButton = document.getElementById('toggleProductEditButton');
                confirmButton = document.getElementById('confirmProductDeleteButton');
                cancelButton = document.getElementById('cancelProductEditButton');
                isProductEditMode = false;
            }
            
            tableElement.classList.remove('edit-mode');
            toggleButton.classList.remove('hidden');
            confirmButton.classList.add('hidden');
            cancelButton.classList.add('hidden');

            // Re-render table to clear highlights and checkboxes
            if (type === 'location') filterLocations();
            else if (type === 'product') filterProducts();

            // updateSyncButton(); // No longer needed
        }

        function confirmBatchDelete(type) {
            let tableElement, pendingIdsArray;
            if (type === 'location') {
                tableElement = document.getElementById('locationsTable');
                pendingIdsArray = pendingOperations.deleteLocationIds;
            } else if (type === 'product') {
                tableElement = document.getElementById('productsTable');
                pendingIdsArray = pendingOperations.deleteProductIds;
            }

            const selectedIds = Array.from(tableElement.querySelectorAll('.checkbox-cell input[type="checkbox"]:checked'))
                                    .map(checkbox => checkbox.dataset.id);

            if (selectedIds.length === 0) {
                alert('請至少選擇一個項目進行刪除。');
                return;
            }

            // Clear previous selections and add new ones
            pendingIdsArray.length = 0; // Clear the array
            selectedIds.forEach(id => pendingIdsArray.push(id));
            
            // Exit edit mode and refresh table
            if (type === 'location') isLocationEditMode = false;
            else if (type === 'product') isProductEditMode = false;
            
            // Trigger the sync directly here
            syncDeleteOperations(type, selectedIds.length); // Pass type and count for messaging
        }

        // --- Transaction Entry Functions ---
        function openAddTransactionModal() {
            modalPendingTransactions = []; 
            renderModalTransactions(); 
            document.getElementById('addTransactionModal').style.display = 'flex';
            document.getElementById('modalTransactionQuantity').value = '1';
            document.getElementById('modalTransactionNotes').value = '';
            document.getElementById('modalTransactionMessage').textContent = '';

            populateSelect(document.getElementById('modalTransactionProduct'), appData.products, 'ProductID', 'ProductName', '-- 請選擇產品 --');
            populateSelect(document.getElementById('modalTransactionLocation'), appData.locations, 'LocationID', 'LocationName', '-- 請選擇地點 --');
        }
        function closeAddTransactionModal() {
            modalPendingTransactions = []; 
            document.getElementById('addTransactionModal').style.display = 'none';
            document.getElementById('modalTransactionQuantity').value = '1';
            document.getElementById('modalTransactionNotes').value = '';
            document.getElementById('modalTransactionMessage').textContent = '';
        }

        function addTransactionToModalList() {
            const type = document.getElementById('modalTransactionType').value;
            const productId = document.getElementById('modalTransactionProduct').value;
            const locationId = document.getElementById('modalTransactionLocation').value;
            const quantity = parseInt(document.getElementById('modalTransactionQuantity').value);
            const notes = document.getElementById('modalTransactionNotes').value.trim();

            if (!productId || !locationId || isNaN(quantity) || quantity <= 0) {
                document.getElementById('modalTransactionMessage').textContent = '請填寫所有必填欄位並確保數量有效。';
                return;
            }

            const productName = appData.products.find(p => p.ProductID === productId)?.ProductName || '未知產品';
            const locationName = appData.locations.find(l => l.LocationID === locationId)?.LocationName || '未知地點';
            const tempTransId = generateFrontendTempId('T'); 
            const timestamp = new Date().toLocaleString(); 

            modalPendingTransactions.push({ 
                type, 
                productId, 
                locationId, 
                quantity, 
                notes,
                tempTransId: tempTransId,
                productName: productName, 
                locationName: locationName, 
                timestamp: timestamp 
            });

            document.getElementById('modalTransactionQuantity').value = '1';
            document.getElementById('modalTransactionNotes').value = '';
            document.getElementById('modalTransactionMessage').textContent = '交易已新增到暫存列表。';
            renderModalTransactions();
        }

        function deleteModalTransaction(tempTransId) {
            modalPendingTransactions = modalPendingTransactions.filter(trans => trans.tempTransId !== tempTransId);
            renderModalTransactions();
        }

        function renderModalTransactions() {
            const tableBody = document.getElementById('modalTransactionsTableBody');
            tableBody.innerHTML = '';

            if (modalPendingTransactions.length > 0) {
                modalPendingTransactions.forEach(trans => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${trans.type}</td>
                        <td>${trans.productName}</td>
                        <td>${trans.locationName}</td>
                        <td>${trans.quantity}</td>
                        <td>${trans.notes || ''}</td>
                        <td><button onclick="deleteModalTransaction('${trans.tempTransId}')" class="bg-red-500 hover:bg-red-700 text-white delete-btn-modal">刪除</button></td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">目前沒有暫存交易。</td></tr>`;
            }
        }

        function confirmModalTransactions() {
            if (modalPendingTransactions.length === 0) {
                alert('沒有任何交易可以新增。');
                return;
            }

            document.getElementById('modalTransactionMessage').textContent = '正在新增交易，請稍候...';
            document.getElementById('addTransactionModal').querySelector('button[onclick="confirmModalTransactions()"]').disabled = true;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        initializeAppData(response.data); 
                        document.getElementById('modalTransactionMessage').textContent = '交易已成功新增並同步。';
                        closeAddTransactionModal(); 
                    } else {
                        document.getElementById('modalTransactionMessage').textContent = `新增失敗: ${response.message}`;
                    }
                    document.getElementById('addTransactionModal').querySelector('button[onclick="confirmModalTransactions()"]').disabled = false;
                })
                .withFailureHandler(function(error) {
                    document.getElementById('modalTransactionMessage').textContent = `新增時發生錯誤: ${error.message}`;
                    document.getElementById('addTransactionModal').querySelector('button[onclick="confirmModalTransactions()"]').disabled = false;
                })
                .processModalBatchOperations({ addTransactions: modalPendingTransactions });
        }

        // --- Transaction History Functions ---
        function filterTransactions() {
            const searchTerm = document.getElementById('transactionHistorySearch').value.toLowerCase();
            const tableBody = document.getElementById('transactionsTableBody');
            tableBody.innerHTML = '';

            const filtered = appData.transactions.filter(trans => {
                const productName = appData.products.find(p => p.ProductID === trans.ProductID)?.ProductName || '未知產品';
                const locationName = appData.locations.find(l => l.LocationID === trans.LocationID)?.LocationName || '未知地點';

                return trans.Type.toLowerCase().includes(searchTerm) ||
                       (trans.TransactionID && trans.TransactionID.toLowerCase().includes(searchTerm)) || 
                       productName.toLowerCase().includes(searchTerm) ||
                       locationName.toLowerCase().includes(searchTerm) ||
                       (trans.Notes && trans.Notes.toLowerCase().includes(searchTerm));
            });


            if (filtered.length > 0) {
                const sortedTransactions = [...filtered].sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));


                sortedTransactions.forEach(row => {
                    const tr = document.createElement('tr');

                    const productName = appData.products.find(p => p.ProductID === row.ProductID)?.ProductName || '未知產品';
                    const locationName = appData.locations.find(l => l.LocationID === row.LocationID)?.LocationName || '未知地點';

                    tr.innerHTML = `
                        <td>${row.TransactionID}</td>
                        <td>${row.Type}</td>
                        <td>${productName}</td>
                        <td>${locationName}</td>
                        <td>${row.Quantity}</td>
                        <td>${row.Timestamp}</td>
                        <td>${row.Notes || ''}</td>
                    `;
                    tableBody.appendChild(tr);
                });
            } else {
                tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">沒有找到符合條件的交易記錄。</td></tr>`;
            }
        }

        // --- Core Sync Function (now only handles delete and called internally) ---
        function syncDeleteOperations(type, count) {
            let messageDivId, messagePrefix;
            let currentTabId = document.querySelector('.tab-content.active').id;

            if (type === 'location') {
                messageDivId = 'location-management'; // Display message in the current tab's message area
                messagePrefix = `正在刪除 ${count} 個地點，請稍候...`;
            } else if (type === 'product') {
                messageDivId = 'product-management'; // Display message in the current tab's message area
                messagePrefix = `正在刪除 ${count} 個產品，請稍候...`;
            } else {
                return; // Should not happen
            }

            // Temporarily disable buttons in the current tab for feedback
            const currentTabElement = document.getElementById(currentTabId);
            currentTabElement.querySelectorAll('button').forEach(btn => btn.disabled = true);
            
            // Add a temporary message area for feedback within the tab
            let tempMessageDiv = document.createElement('p');
            tempMessageDiv.id = 'tempSyncMessage';
            tempMessageDiv.className = 'mt-4 text-center text-sm text-gray-600';
            tempMessageDiv.textContent = messagePrefix;
            currentTabElement.querySelector('h2').after(tempMessageDiv);


            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.success) {
                        tempMessageDiv.textContent = `${count} 個項目已成功刪除並同步到 Google Sheet！`;
                        pendingOperations.deleteLocationIds = []; // Clear all pending deletes after success
                        pendingOperations.deleteProductIds = []; // Clear all pending deletes after success
                        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData(); // Reload all data
                        
                        // Hide the message after a short delay
                        setTimeout(() => {
                            if (tempMessageDiv && tempMessageDiv.parentNode) {
                                tempMessageDiv.parentNode.removeChild(tempMessageDiv);
                            }
                            // Re-enable buttons
                            currentTabElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
                            cancelEditMode(type); // Ensure we exit edit mode and clear checkboxes
                        }, 2000); 

                    } else {
                        tempMessageDiv.textContent = `刪除失敗: ${response.message}`;
                        currentTabElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
                    }
                })
                .withFailureHandler(function(error) {
                    tempMessageDiv.textContent = `刪除時發生錯誤: ${error.message}`;
                    currentTabElement.querySelectorAll('button').forEach(btn => btn.disabled = false);
                })
                .processBatchOperations(pendingOperations); 
        }
    </script>
</body>
</html>
```

---

希望這份詳盡的總結和規格表，以及完整的程式碼能幫助您繼續推進項目！接下來的階段可能需要更多地著重於調試和完善現有功能，特別是您提到的「功能不正常」的部分。祝您一切順利！


是的，我對這次的對話有幾點建議：

更明確的錯誤情境和預期行為： 當您提到「功能不正常」時，如果能提供更具體的細節，例如：

「我點擊了『確認刪除』，但 Google Sheet 裡的數據沒有變。」（錯誤情境）
「我期望 Google Sheet 裡的相關行被刪除，並且前端表格立刻刷新。」（預期行為）
「控制台裡有沒有任何錯誤訊息？」(如果可以提供，會大大加速診斷)
這樣可以讓我更快地定位問題，並提供精確的解決方案，而不是泛泛的整理和回顧。
分階段的驗證與反饋： 在我們引入了模態框新增、批量刪除、以及移除全域同步按鈕等功能時，如果在每個主要改動後都能進行一次簡單的驗證並給予反饋（例如：「新增地點功能正常工作！」，或者「批量刪除後前端沒有刷新」），這樣我可以針對性地修復問題，避免問題堆積。

對「複雜度」的認知同步： 庫存管理雖然表面簡單，但涉及數據之間的關聯性（例如：刪除產品後，庫存表中的相關記錄如何處理？交易記錄如何處理？），這些業務邏輯的複雜性會逐步顯現。我們這次的對話主要側重於 UI/UX 和 CRUD (增刪查改) 的實現，對於業務邏輯的聯動性探討較少。在未來，如果需要更完整的系統，這部分會是討論的重點。

提供完整的執行環境資訊： 當出現問題時，除了前端行為，如果能提供 Google Apps Script 項目端的任何錯誤日誌 (在 Apps Script 編輯器中，點擊 執行 > 所有執行，或在 Stackdriver Logging 中查看)，這對診斷後端問題至關重要。

總結來說，我非常樂意提供詳細的程式碼和解釋，但在調試和功能完善階段，更精確的問題描述和實時的反饋將會是提高效率的關鍵。
