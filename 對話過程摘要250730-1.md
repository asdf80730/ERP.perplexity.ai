好的，我理解了。非常抱歉由於對話內容過多造成的困擾。

我會遵照您的指示，將這次對話的**完整過程與所有修正點**，以及**當前版本的完整程式碼**，都整理進一份**規格表**中。同時，我也會在規格表中提供對使用者和未來接手開發者的建議。

**請您將 `1gWdjCGtDB62PJ5JrnXVCz9yv5p62S27DDphrAi5u75s` 這個 ID 填寫到 `Code.gs` 中的 `SS_ID` 變數處。** 我已經在下面的 `Code.gs` Artifact 中為您填寫好了。

---

現在，請查收以下為您整理的規格表。由於內容較長，我會分多次發送，請您耐心等待，直到看到 "所有內容已發送完畢" 為止。

---

**庫存管理系統前端介面開發規格表 - V1.0**

**專案名稱：** 庫存管理系統前端介面 (Google Apps Script / HTML / CSS / JavaScript)

**文件版本：** V1.0

**日期：** 2023年10月28日

**作者：** Gemini (AI)

---

**1. 專案概述**

本專案旨在開發一個基於 Google Apps Script 的庫存管理系統前端介面，提供用戶友好的操作界面，實現對地點、產品、交易和庫存的查詢與管理功能。本規格表記錄了從初始需求到當前版本的迭代過程，包含所有功能、界面和技術實現的細節。

---

**2. 迭代開發歷程與問題解決**

以下是本次對話中，根據用戶反饋進行的主要迭代和問題解決方案：

| 階段 | 原始需求/問題 | 解決方案 | 狀態 | 備註 |
| :--- | :--- | :--- | :--- | :--- |
| **P0 初始框架** | 開發基本的庫存管理系統前端介面，包含五個主要分頁：首頁、地點管理、產品管理、交易管理、庫存查詢。 | 實作了基本的 HTML 結構、CSS 樣式和 JavaScript 骨架，用於頁面切換和數據顯示。 | 完成 | 初始需求。 |
| **P1 界面元素樣式調整** | 按鈕樣式不正確，部分按鈕顯示為藍色或綠色，但預期應為紅色或其他顏色。 | 引入 `!important` 關鍵字，強制應用 CSS 樣式，解決了樣式被覆蓋的問題。對不同功能的按鈕定義了明確的顏色（藍色、紅色、棕色、綠色、橘色、灰色）。 | 完成 | 解決樣式優先級問題。 |
| **P2 模態框內部佈局與按鈕樣式** | 模態框中的按鈕出現黑粗框；新增產品模態框的輸入欄位（品牌、類別）沒有與「產品名稱」正確分行，而是擠在同一行。 | 為模態框按鈕的 CSS 規則添加 `border: none !important;` 移除邊框。重構 `addProductInput()` 函數的 HTML 結構，確保每個產品屬性（名稱、品牌、類別）都位於獨立的 `form-group` 內，實現標籤和輸入框同行，各組垂直堆疊的佈局。 | 完成 | 提升用戶體驗。 |
| **P3 頁面切換顯示問題** | 首頁、地點管理、產品管理、交易管理、庫存查詢這五個分頁不會正確地隱藏，會五個都在畫面上。 | 檢查並確認 `switchTab` 函數的邏輯以及 CSS (`.tab-content`, `.tab-content.active`) 的正確性，確保只有選中的分頁顯示。 | 完成 | 修正了頁面切換的視覺異常。 |
| **P4 編輯交易測試數據與功能驗證** | 編輯交易時「新增一筆」按鈕應隱藏，但後端未完成，無法測試。要求提供前端測試數據。 | 在 `Code.gs` 中加入了預設的模擬數據（地點、產品、庫存、交易記錄），使得前端介面能在沒有完整後端接入的情況下，顯示數據並測試如「編輯交易時隱藏新增按鈕」等功能。 | 完成 | 提供了前端測試環境。 |
| **P5 模態框「新增一筆/一列」按鈕樣式** | 模態框中的「新增一筆/一列」按鈕會出現黑粗框。 | 在相關按鈕的 CSS 規則中增加了 `border: none !important;`。 | 完成 | 解決細微的視覺問題。 |

---

**3. 應用程式功能點**

*   **分頁導航：**
    *   首頁、地點管理、產品管理、交易管理、庫存查詢五個主要分頁。
    *   點擊分頁按鈕可切換顯示對應內容。
*   **數據顯示與管理：**
    *   **首頁：** 顯示近七天的入庫/出庫交易記錄。
    *   **地點管理：**
        *   顯示所有地點列表及各地點下的庫存總量。
        *   可新增地點（支持批量新增）。
        *   可編輯地點名稱。
        *   刪除模式：可選取多個地點進行刪除，並提供將庫存轉移到其他地點或清除庫存的選項。
        *   地點名稱搜索過濾。
    *   **產品管理：**
        *   顯示所有產品列表（包含類別、品牌、產品名稱）。
        *   可新增產品（支持批量新增，包含名稱、品牌、類別）。
        *   可編輯產品資訊（名稱、品牌、類別）。
        *   刪除模式：可選取多個產品進行刪除，並清除相關庫存。
        *   產品信息搜索過濾。
    *   **交易管理：**
        *   顯示所有交易記錄（日期、產品、地點、數量、備註）。
        *   支持按年份、月份和關鍵字進行過濾查詢。
        *   可入庫/出庫（支持批量操作，並在出庫時檢查庫存）。
        *   可編輯交易記錄（修改數量和備註，同時調整庫存）。
        *   刪除模式：可選取多個交易記錄進行刪除，並自動調整庫存。
    *   **庫存查詢：**
        *   根據地點、品牌、類別進行多條件篩選查詢庫存。
        *   顯示符合條件的庫存清單（品牌、類別、地點名稱、數量）。
*   **模態框：**
    *   統一的模態框樣式，用於新增地點、新增產品、交易記錄（入/出庫）、地點刪除確認。
*   **通知機制：**
    *   通過 `showToast` 函數（目前為 `alert`）提供操作成功或失敗的提示。

---

**4. 界面/用戶體驗改進 (本次對話中實現的改進)**

*   **統一的按鈕樣式：**
    *   所有操作按鈕（新增、刪除、入庫、出庫、確認、取消等）都擁有明確且一致的顏色和樣式，並通過 `!important` 確保優先級。
    *   「取消刪除」按鈕統一為橘色。
    *   模態框中的「新增一筆/一列」按鈕統一為綠色。
    *   所有按鈕邊框已被移除。
*   **響應式設計考量：**
    *   基礎的響應式樣式（`viewport` meta 標籤、`overflow-x: auto`）。
    *   字體大小和間距調整，提升可讀性。
*   **模態框佈局優化：**
    *   模態框內輸入框的標籤與輸入/選擇框在同一行顯示，且各組垂直堆疊，提升了表單的整潔性。
*   **刪除模式切換：**
    *   刪除按鈕會在進入刪除模式時變成「確認刪除」，並出現「取消刪除」按鈕，提供清晰的狀態指示。
    *   切換分頁會自動退出刪除模式。
*   **編輯功能優化：**
    *   在編輯地點/產品/交易時，其他相同類型的編輯按鈕會被禁用，避免同時編輯多行。
    *   編輯交易時，「新增一筆」按鈕會自動隱藏，避免混淆。

---

**5. 技術實現細節**

*   **前端框架：** 原生 HTML5, CSS3, JavaScript。
*   **後端/數據層：** Google Apps Script (GAS)。
    *   使用 `google.script.run` 進行前端和 GAS 後端之間的非同步通信。
    *   `getAllInitialData()` 用於首次加載和數據刷新。
    *   新增了模擬的 GAS 函數 (`addLocations`, `updateLocationName`, `deleteLocationsAndTransferInventory`, `addProducts`, `updateProduct`, `deleteProducts`, `addBulkTransactionsAndUpdateInventory`, `updateTransactionAndInventory`, `deleteTransactionsAndUpdateInventory`)，用於前端測試。
*   **數據結構 (模擬)：**
    *   `appData` JavaScript 物件儲存了前端所需的 Locations, Products, Inventory, Transactions 數據。
    *   數據使用陣列和物件表示，包含 ID 和其他屬性。
*   **CSS 樣式：**
    *   大量使用 `!important` 確保樣式覆蓋和一致性。
    *   Flexbox 用於佈局。
*   **事件處理：**
    *   DOM `click`, `change`, `keyup` 等事件監聽。
*   **數據過濾與排序：**
    *   前端實現了地點、產品、交易的搜索過濾，以及交易的日期篩選。
    *   產品和庫存查詢結果支持多層級排序。

---

**6. 當前版本程式碼**



```javascript
const SS_ID = '1gWdjCGtDB62PJ5JrnXVCz9yv5p62S27DDphrAi5u75s'; // *** 您的試算表 ID 已填寫在此處 ***

function doGet() {
  return HtmlService.createTemplateFromFile('index')
      .evaluate()
      .setTitle('庫存管理系統')
      .addMetaTag('viewport', 'width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no');
}

/**
 * 從 HTML 檔案載入內容。
 */
function include(filename) {
  return HtmlService.createHtmlOutputFromFile(filename).getContent();
}

/**
 * 模擬獲取所有初始化數據
 * 實際應用中，這些數據會從 Google Sheet 或其他數據庫中讀取。
 */
function getAllInitialData() {
  // --- 模擬數據 ---
  const mockLocations = [
    { LocationID: 'LOC001', LocationName: '倉庫A' },
    { LocationID: 'LOC002', LocationName: '門市部' },
    { LocationID: 'LOC003', LocationName: '儲藏室' }
  ];

  const mockProducts = [
    { ProductID: 'PROD001', ProductName: '筆記型電腦', Brand: 'Dell', Category: '電子產品' },
    { ProductID: 'PROD002', ProductName: '無線滑鼠', Brand: 'Logitech', Category: '配件' },
    { ProductID: 'PROD003', ProductName: '辦公椅', Brand: 'Ergohuman', Category: '家具' },
    { ProductID: 'PROD004', ProductName: '鍵盤', Brand: 'Razer', Category: '電子產品' }
  ];

  // 模擬庫存 (ProductID, LocationID, Quantity)
  const mockInventory = [
    { ProductID: 'PROD001', LocationID: 'LOC001', Quantity: 10 },
    { ProductID: 'PROD002', LocationID: 'LOC001', Quantity: 25 },
    { ProductID: 'PROD003', LocationID: 'LOC002', Quantity: 5 },
    { ProductID: 'PROD001', LocationID: 'LOC002', Quantity: 3 },
    { ProductID: 'PROD004', LocationID: 'LOC001', Quantity: 15 }
  ];

  // 模擬交易記錄 (TransactionID, Timestamp, Type, ProductID, LocationID, Quantity, Notes)
  const mockTransactions = [
    { TransactionID: 'TRX001', Timestamp: '2023/10/26 10:00:00', Type: 'In', ProductID: 'PROD001', LocationID: 'LOC001', Quantity: 5, Notes: '首次入庫' },
    { TransactionID: 'TRX002', Timestamp: '2023/10/26 11:30:00', Type: 'Out', ProductID: 'PROD002', LocationID: 'LOC001', Quantity: 2, Notes: '門市調撥' },
    { TransactionID: 'TRX003', Timestamp: '2023/10/25 14:00:00', Type: 'In', ProductID: 'PROD003', LocationID: 'LOC002', Quantity: 1, Notes: '新品到貨' },
    { TransactionID: 'TRX004', Timestamp: '2023/10/27 09:00:00', Type: 'In', ProductID: 'PROD004', LocationID: 'LOC001', Quantity: 10, Notes: '供應商補貨' },
    { TransactionID: 'TRX005', Timestamp: '2023/10/27 15:00:00', Type: 'Out', ProductID: 'PROD001', LocationID: 'LOC001', Quantity: 1, Notes: '客戶購買' },
    { TransactionID: 'TRX006', Timestamp: '2023/10/28 10:00:00', Type: 'In', ProductID: 'PROD002', LocationID: 'LOC001', Quantity: 5, Notes: '退貨入庫' },
    { TransactionID: 'TRX007', Timestamp: '2023/10/28 11:00:00', Type: 'Out', ProductID: 'PROD004', LocationID: 'LOC001', Quantity: 3, Notes: '內部使用' }
  ];
  // --- 模擬數據結束 ---

  return {
    locations: mockLocations,
    products: mockProducts,
    inventory: mockInventory,
    transactions: mockTransactions
  };
}

/**
 * 模擬新增地點
 */
function addLocations(locationNames) {
  Logger.log('模擬新增地點: ' + JSON.stringify(locationNames));
  // 實際應用中，這裡會將數據寫入試算表或數據庫
  return true;
}

/**
 * 模擬更新地點名稱
 */
function updateLocationName(locationId, newName) {
  Logger.log(`模擬更新地點 ${locationId} 名稱為 ${newName}`);
  return true;
}

/**
 * 模擬刪除地點並處理庫存
 */
function deleteLocationsAndTransferInventory(locationIdsToDelete, transferToLocationId) {
  Logger.log(`模擬刪除地點: ${JSON.stringify(locationIdsToDelete)}, 轉移到: ${transferToLocationId}`);
  return true;
}

/**
 * 模擬新增產品
 */
function addProducts(products) {
  Logger.log('模擬新增產品: ' + JSON.stringify(products));
  return true;
}

/**
 * 模擬更新產品
 */
function updateProduct(productId, newName, newBrand, newCategory) {
  Logger.log(`模擬更新產品 ${productId}: ${newName}, ${newBrand}, ${newCategory}`);
  return true;
}

/**
 * 模擬刪除產品
 */
function deleteProducts(productIdsToDelete) {
  Logger.log('模擬刪除產品: ' + JSON.stringify(productIdsToDelete));
  return true;
}

/**
 * 模擬批量新增交易並更新庫存
 */
function addBulkTransactionsAndUpdateInventory(transactions) {
  Logger.log('模擬批量新增交易: ' + JSON.stringify(transactions));
  return true;
}

/**
 * 模擬更新交易並調整庫存
 */
function updateTransactionAndInventory(transactionId, newNotes, newQuantity) {
  Logger.log(`模擬更新交易 ${transactionId}: 備註='${newNotes}', 數量=${newQuantity}`);
  return true;
}

/**
 * 模擬刪除交易並調整庫存
 */
function deleteTransactionsAndUpdateInventory(transactionIdsToDelete) {
  Logger.log('模擬刪除交易: ' + JSON.stringify(transactionIdsToDelete));
  return true;
}
```


```html
<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>庫存管理系統</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
      color: #333;
      font-size: 24px; /* Further increased base font size for higher readability */
      box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }
    .container {
      padding: 20px; /* Increased padding */
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px; /* Increased margin */
      padding: 0 15px; /* Increased padding */
    }
    .header h2 {
      margin: 0;
      color: #0056b3;
      font-size: 38px; /* Further increased for better visibility */
    }
    .tab-buttons {
      display: flex;
      justify-content: space-around;
      background-color: #e2e6ea;
      padding: 18px 0; /* Increased padding */
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tab-button {
      flex: 1;
      padding: 18px 0; /* Increased padding */
      text-align: center;
      cursor: pointer;
      font-weight: bold;
      color: #555;
      background-color: #f8f9fa;
      border: none;
      transition: background-color 0.3s ease;
      font-size: 20px; /* Adjusted font size */
    }
    .tab-button.active {
      background-color: #007bff;
      color: white;
      border-bottom: 3px solid #0056b3;
    }
    .tab-button:hover:not(.active) {
      background-color: #e9ecef;
    }
    /* Unified button styles with !important for robust application */
    .action-buttons button,
    .modal-buttons button,
    button.remove-record-btn, /* Target remove button specifically */
    .quantity-input-group button, /* Target quantity +/- buttons */
    .cancel-delete-container button /* Target cancel delete button specifically */
    {
      padding: 15px 30px !important; /* Larger padding for all main buttons */
      border: none !important; /* Remove borders */
      border-radius: 5px !important;
      cursor: pointer !important;
      font-size: 20px !important; /* Consistent font size */
      transition: background-color 0.3s ease !important;
      margin-left: 10px !important; /* Consistent spacing */
    }
    /* Specific overrides for certain buttons */
    .action-buttons button { /* Smaller padding for header action buttons */
      padding: 12px 18px !important;
    }
    td button { /* Smaller padding for table cell buttons */
      padding: 10px 15px !important;
      font-size: 19px !important;
      margin-right: 8px !important; /* Ensure margin-right not margin-left */
      margin-left: 0 !important;
    }

    /* Color styles with !important */
    .primary,
    .modal-buttons .confirm {
      background-color: #007bff !important;
      color: white !important;
    }
    .primary:hover,
    .modal-buttons .confirm:hover {
      background-color: #0056b3 !important;
    }
    .danger,
    .modal-buttons .danger {
      background-color: #dc3545 !important;
      color: white !important;
    }
    .danger:hover,
    .modal-buttons .danger:hover {
      background-color: #c82333 !important;
    }
    .secondary,
    .modal-buttons .cancel {
      background-color: #6c757d !important;
      color: white !important;
    }
    .secondary:hover,
    .modal-buttons .cancel:hover {
      background-color: #5a6268 !important;
    }
    .button-brown {
      background-color: #8B4513 !important;
      color: white !important;
    }
    .button-brown:hover {
      background-color: #654321 !important;
    }
    .button-orange,
    .cancel-delete-container button {
        background-color: #fd7e14 !important;
        color: white !important;
    }
    .button-orange:hover,
    .cancel-delete-container button:hover {
        background-color: #e66b00 !important;
    }
    .button-green { /* New green button style for add record */
        background-color: #28a745 !important;
        color: white !important;
    }
    .button-green:hover {
        background-color: #218838 !important;
    }
    /* Specific for the remove-record-btn */
    button.remove-record-btn {
      background-color: #dc3545 !important;
      color: white !important;
      margin-left: 20px !important; /* Adjusted margin */
      margin-top: 0 !important; /* Reset margin-top */
      padding: 10px 15px !important; /* Smaller size for this specific button */
      font-size: 19px !important;
    }
    button.remove-record-btn:hover {
      background-color: #c82333 !important;
    }
    td button.edit {
      background-color: #ffc107 !important;
      color: #333 !important;
    }
    td button.edit:hover {
      background-color: #e0a800 !important;
    }
    td button.save {
      background-color: #28a745 !important;
      color: white !important;
    }
    td button.save:hover {
      background-color: #218838 !important;
    }

    .table-container {
      overflow-x: auto;
      margin-top: 25px; /* Increased margin */
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px; /* Increased min-width for larger content */
    }
    th, td {
      padding: 18px 22px; /* Increased padding */
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 22px; /* Increased font size for table content */
    }
    th {
      background-color: #f0f0f0;
      font-weight: bold;
      color: #555;
      text-transform: uppercase;
      font-size: 24px; /* Increased font size for table headers */
    }
    tr:hover {
      background-color: #f9f9f9;
    }
    /* Unified style for input and select elements */
    input[type="text"],
    input[type="number"],
    select,
    textarea {
      width: 100%;
      padding: 15px; /* Increased padding */
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
      font-size: 22px; /* Adjusted font size */
    }
    .search-bar {
        margin-bottom: 25px; /* Increased margin */
        padding: 0 15px;
    }
    .search-bar input, .search-bar select {
        margin-bottom: 15px; /* Increased margin */
    }

    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1001; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto; /* Centered */
      padding: 35px; /* Increased padding */
      border: 1px solid #888;
      width: 95%; /* Increased width */
      max-width: 700px; /* Increased max-width */
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 38px; /* Increased font size */
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    /* Adjusted form-group for label and input in one line */
    .form-group {
      margin-bottom: 25px; /* Increased margin */
      display: flex; /* Use flexbox */
      align-items: center; /* Vertically align items */
    }
    .form-group label {
      display: block;
      margin-right: 15px; /* Space between label and input */
      font-weight: bold;
      font-size: 22px; /* Adjusted font size */
      white-space: nowrap; /* Prevent label from wrapping */
      min-width: 80px; /* Give labels a consistent minimum width */
    }
    .form-group input, .form-group select, .form-group textarea {
        flex-grow: 1; /* Allow input to take remaining space */
        width: auto; /* Override default 100% width */
    }

    .modal-buttons {
      display: flex;
      justify-content: flex-end;
      margin-top: 30px; /* Increased margin */
    }
    /* For delete mode checkboxes */
    .delete-checkbox-cell {
        text-align: center;
    }
    .delete-checkbox-cell input[type="checkbox"] {
        width: 30px; /* Increased size */
        height: 30px; /* Increased size */
        cursor: pointer;
    }
    .quantity-input-group {
      display: flex;
      align-items: center;
      flex-grow: 1; /* Allow it to take remaining space */
    }
    .quantity-input-group input {
      text-align: center;
      width: 80px; /* Adjusted width */
      font-size: 22px; /* Adjusted font size */
      flex-shrink: 0; /* Prevent input from shrinking too much */
    }
    .record-row {
      display: flex;
      align-items: flex-start; /* Align items to the top if content wraps */
      margin-bottom: 20px; /* Increased margin */
      padding: 15px; /* Increased padding */
      border: 1px solid #eee;
      border-radius: 5px;
      background-color: #fcfcfc;
      flex-direction: column; /* Stack form groups vertically */
    }
    .record-row .record-info {
      flex: 1; /* Changed from flex-grow to flex for better distribution */
      display: flex;
      flex-direction: column; /* Stack these form groups vertically */
      gap: 10px; /* Increased gap between form groups */
      width: 100%; /* Take full width of record-row */
    }
    /* Adjust margin for record-row form-groups to align well */
    .record-row .form-group {
        margin-bottom: 10px; /* Smaller margin between form groups within a record-row */
    }
    .record-row .form-group:last-child {
        margin-bottom: 0; /* No margin for the last form group */
    }
    /* Ensure remove button aligns correctly with record row */
    .record-row > button.remove-record-btn {
        margin-top: 15px !important; /* Add top margin to separate from record-info */
        align-self: flex-end; /* Align to the end of the record-row */
    }
    /* Specific styling for new-location/product input groups to align remove button */
    #new-location-entries .form-group,
    #new-product-entries .form-group {
        position: relative; /* For absolute positioning of remove button */
        padding-right: 80px; /* Make space for the remove button */
        align-items: center;
    }
    #new-location-entries .form-group button.remove-record-btn,
    #new-product-entries .form-group button.remove-record-btn {
        position: absolute !important;
        right: 0 !important;
        top: 50% !important;
        transform: translateY(-50%) !important;
        margin-left: 0 !important;
    }
    /* For product entry groups to stack correctly */
    .product-entry-group {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        position: relative; /* For the remove button */
        background-color: #f9f9f9;
    }
    .product-entry-group .form-group {
        margin-bottom: 10px; /* Smaller margin between form groups within an entry */
    }
    .product-entry-group .form-group:last-of-type {
        margin-bottom: 0;
    }
    .product-entry-group .remove-record-btn {
        position: absolute !important;
        top: 15px !important; /* Adjust top for better alignment in the group */
        right: 15px !important;
        transform: translateY(0) !important; /* Reset transform */
    }
    /* Fix for tab content hiding/showing */
    .tab-content {
        display: none;
    }
    .tab-content.active {
        display: block;
    }

  </style>
</head>
<body>

  <div class="tab-buttons">
    <button class="tab-button active" onclick="switchTab('home')">首頁</button>
    <button class="tab-button" onclick="switchTab('locations')">地點管理</button>
    <button class="tab-button" onclick="switchTab('products')">產品管理</button>
    <button class="tab-button" onclick="switchTab('transactions')">交易管理</button>
    <button class="tab-button" onclick="switchTab('inventory')">庫存查詢</button>
  </div>

  <div id="home-tab" class="tab-content active container">
    <div class="header">
      <h2>首頁</h2>
      <div class="action-buttons">
        <button class="primary" onclick="openTransactionModal('In')">入庫</button>
        <button class="button-brown" onclick="openTransactionModal('Out')">出庫</button>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>日期</th>
            <th>產品名稱</th>
            <th>數量</th>
          </tr>
        </thead>
        <tbody id="recent-transactions-table-body">
          <!-- Recent transactions will be loaded here by JavaScript -->
          <tr><td colspan="3" style="text-align: center;">載入中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="locations-tab" class="tab-content container">
    <div class="header">
      <h2>地點管理</h2>
      <div class="action-buttons">
        <button class="primary" onclick="openAddLocationModal()">新增地點</button>
        <button class="danger" id="delete-location-btn" onclick="toggleLocationDeleteMode()">刪除</button>
      </div>
    </div>
    <div class="search-bar">
        <input type="text" id="location-search-input" placeholder="搜尋地點名稱..." onkeyup="filterLocations()">
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>地點名稱</th>
            <th>地點數量</th>
            <th id="locations-action-header">操作</th>
          </tr>
        </thead>
        <tbody id="locations-table-body">
          <!-- Locations will be loaded here by JavaScript -->
          <tr><td colspan="3" style="text-align: center;">載入中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="products-tab" class="tab-content container">
    <div class="header">
      <h2>產品管理</h2>
      <div class="action-buttons">
        <button class="primary" onclick="openAddProductModal()">新增產品</button>
        <button class="danger" id="delete-product-btn" onclick="toggleProductDeleteMode()">刪除</button>
      </div>
    </div>
    <div class="search-bar">
        <input type="text" id="product-search-input" placeholder="搜尋產品名稱、品牌、類別..." onkeyup="filterProducts()">
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>類別</th>
            <th>品牌</th>
            <th>產品名稱</th>
            <th id="products-action-header">操作</th>
          </tr>
        </thead>
        <tbody id="products-table-body">
          <!-- Products will be loaded here by JavaScript -->
          <tr><td colspan="4" style="text-align: center;">載入中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="transactions-tab" class="tab-content container">
    <div class="header">
      <h2>交易管理</h2>
      <div class="action-buttons">
        <button class="primary" onclick="openTransactionModal('In')">入庫</button>
        <button class="button-brown" onclick="openTransactionModal('Out')">出庫</button>
        <button class="danger" id="delete-transaction-btn" onclick="toggleTransactionDeleteMode()">刪除</button>
      </div>
    </div>
    <div class="search-bar">
      <input type="text" id="transaction-search-input" placeholder="搜尋產品、地點、備註..." onkeyup="filterTransactions()">
      <div style="display:flex; margin-top: 15px;">
        <input type="number" id="transaction-year-filter" placeholder="年份" style="flex: 1; margin-right: 8px;" onchange="filterTransactions()">
        <span style="align-self: center; margin-right: 8px;">年</span> <!-- Added "年" -->
        <select id="transaction-month-filter" style="flex: 1;" onchange="filterTransactions()">
          <option value="">選擇月份</option>
          <option value="1">一月</option>
          <option value="2">二月</option>
          <option value="3">三月</option>
          <option value="4">四月</option>
          <option value="5">五月</option>
          <option value="6">六月</option>
          <option value="7">七月</option>
          <option value="8">八月</option>
          <option value="9">九月</option>
          <option value="10">十月</option>
          <option value="11">十一月</option>
          <option value="12">十二月</option>
        </select>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>日期</th>
            <th>產品</th>
            <th>地點</th>
            <th>數量</th>
            <th>備註</th>
            <th id="transactions-action-header">操作</th>
          </tr>
        </thead>
        <tbody id="transactions-table-body">
          <!-- Transactions will be loaded here by JavaScript -->
          <tr><td colspan="6" style="text-align: center;">載入中...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="inventory-tab" class="tab-content container">
    <div class="header">
      <h2>庫存查詢</h2>
      <!-- No action buttons for inventory query -->
    </div>
    <div class="filter-controls">
      <div class="form-group">
        <label for="inventory-location-filter">地點:</label>
        <select id="inventory-location-filter" onchange="performInventoryQuery()">
          <option value="">所有地點</option>
        </select>
      </div>
      <div class="form-group">
        <label for="inventory-brand-filter">品牌:</label>
        <select id="inventory-brand-filter" onchange="performInventoryQuery()">
          <option value="">所有品牌</option>
        </select>
      </div>
      <div class="form-group">
        <label for="inventory-category-filter">類別:</label>
        <select id="inventory-category-filter" onchange="performInventoryQuery()">
          <option value="">所有類別</option>
        </select>
      </div>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>品牌</th>
            <th>類別</th>
            <th>地點名稱</th>
            <th>數量</th>
          </tr>
        </thead>
        <tbody id="inventory-table-body">
          <!-- Inventory will be loaded here by JavaScript -->
          <tr><td colspan="4" style="text-align: center;">選擇篩選條件以查詢庫存</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Common Modals -->

  <!-- Transaction Modal (for Home and Transaction Management) -->
  <div id="transaction-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('transaction-modal')">&times;</span>
      <h3 id="transaction-modal-title"></h3>
      <div id="transaction-entries-container">
        <!-- Dynamic transaction entry rows will be added here -->
      </div>
      <div class="modal-buttons">
        <button class="button-green" id="add-transaction-row-btn" onclick="addTransactionRow()">新增一筆</button>
        <button class="confirm" onclick="submitBulkTransactions()">確認提交</button>
        <button class="cancel" onclick="closeModal('transaction-modal')">取消</button>
      </div>
    </div>
  </div>

  <!-- Add Location Modal -->
  <div id="add-location-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('add-location-modal')">&times;</span>
      <h3>新增地點</h3>
      <div id="new-location-entries">
        <!-- New location input fields will be added here -->
      </div>
      <div class="modal-buttons">
        <button class="button-green" id="add-location-input-btn" onclick="addLocationInput()">新增一列地點</button>
        <button class="confirm" onclick="submitAddLocations()">確認新增</button>
        <button class="cancel" onclick="closeModal('add-location-modal')">取消</button>
      </div>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="add-product-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('add-product-modal')">&times;</span>
      <h3>新增產品</h3>
      <div id="new-product-entries">
        <!-- New product input fields will be added here -->
      </div>
      <div class="modal-buttons">
        <button class="button-green" id="add-product-input-btn" onclick="addProductInput()">新增一列產品</button>
        <button class="confirm" onclick="submitAddProducts()">確認新增</button>
        <button class="cancel" onclick="closeModal('add-product-modal')">取消</button>
      </div>
    </div>
  </div>

  <!-- Location Delete Confirmation Modal -->
  <div id="delete-location-confirm-modal" class="modal">
    <div class="modal-content">
      <span class="close-button" onclick="closeModal('delete-location-confirm-modal')">&times;</span>
      <h3>確認刪除地點</h3>
      <p>您已選取 <span id="selected-locations-count">0</span> 個地點。請選擇如何處理這些地點下的庫存：</p>
      <div class="form-group">
        <label for="transfer-location-select">將庫存轉移到：</label>
        <select id="transfer-location-select">
          <option value="">(不轉移，庫存將被清除)</option>
          <!-- Locations for transfer will be loaded here -->
        </select>
      </div>
      <div class="modal-buttons">
        <button class="confirm danger" onclick="confirmDeleteSelectedLocations()">確認刪除並處理庫存</button>
        <button class="cancel" onclick="closeModal('delete-location-confirm-modal')">取消</button>
      </div>
    </div>
  </div>


<script>
  // Global application state
  let appData = {
    locations: [],
    products: [],
    inventory: [],
    transactions: [],
    // Add a state for tracking which row is being edited
    editingLocationId: null, 
    editingProductId: null,
    editingTransactionId: null,
    
    // Add delete mode states
    isLocationDeleteMode: false,
    isProductDeleteMode: false,
    isTransactionDeleteMode: false,

    // To remember active tab
    activeTab: 'home'
  };

  // --- Utility Functions ---

  function showToast(message, type = 'success') {
    // Implement a simple toast notification system
    console.log(`Toast (${type}): ${message}`);
    alert(message); // For now, use alert for simplicity
  }

  function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
    // Clear dynamic content if needed
    if (modalId === 'transaction-modal') {
      document.getElementById('transaction-entries-container').innerHTML = '';
      // Reset submit button for future bulk transactions
      document.querySelector('#transaction-modal .confirm').onclick = submitBulkTransactions;
      // Show "新增一筆" button again
      document.getElementById('add-transaction-row-btn').style.display = 'inline-block';
    } else if (modalId === 'add-location-modal') {
      document.getElementById('new-location-entries').innerHTML = '';
    } else if (modalId === 'add-product-modal') {
      document.getElementById('new-product-entries').innerHTML = '';
    }
  }

  // Disable/Enable all edit buttons (except the one being edited)
  function setEditButtonsState(disabled, currentEditingId = null, type = 'location') {
      let tableBodyId;
      let attributeId;
      if (type === 'location') {
          tableBodyId = 'locations-table-body';
          attributeId = 'data-location-id';
      } else if (type === 'product') {
          tableBodyId = 'products-table-body';
          attributeId = 'data-product-id';
      } else if (type === 'transaction') {
          tableBodyId = 'transactions-table-body';
          attributeId = 'data-transaction-id';
      }

      const rows = document.getElementById(tableBodyId).getElementsByTagName('tr');
      for (const row of rows) {
          const editButton = row.querySelector('.edit-button'); // Assuming edit button has this class
          const rowId = row.getAttribute(attributeId);
          if (editButton && rowId !== currentEditingId) {
              editButton.disabled = disabled;
              editButton.style.opacity = disabled ? '0.5' : '1'; // Visual feedback
              editButton.style.cursor = disabled ? 'not-allowed' : 'pointer';
          }
      }
  }


  // --- Data Initialization & App State Management ---

  function initializeAppData(data) {
    appData.locations = data.locations || [];
    appData.products = data.products || [];
    appData.inventory = data.inventory || [];
    appData.transactions = data.transactions || [];

    // Clear editing states on re-initialization
    appData.editingLocationId = null;
    appData.editingProductId = null;
    appData.editingTransactionId = null;

    // Reset delete modes on re-initialization (if still in delete mode after data reload)
    // This is primarily for a clean state when data is reloaded,
    // actual exit from delete mode on tab switch is handled by switchTab.
    if (appData.isLocationDeleteMode) toggleLocationDeleteMode(false);
    if (appData.isProductDeleteMode) toggleProductDeleteMode(false);
    if (appData.isTransactionDeleteMode) toggleTransactionDeleteMode(false);
    
    // Populate all relevant dropdowns
    populateLocationSelects();
    populateProductSelects();
    populateBrandAndCategoryFilters(); // For inventory query

    // Render initial views
    renderRecentTransactions();
    renderLocations();
    renderProducts();
    renderTransactions(); // Initial render for transactions tab
    // Inventory tab is rendered on filter change, or can be triggered initially if needed
    // performInventoryQuery(); // Optional: Render with default filters on load
  }

  function populateLocationSelects() {
    const selects = document.querySelectorAll('select[id$="-location-select"], select[id$="-location-filter"]');
    selects.forEach(select => {
      const currentVal = select.value; // Preserve current selection if any
      select.innerHTML = '<option value="">(請選擇地點)</option>'; // Default empty option
      if (select.id === 'transfer-location-select') {
          select.innerHTML = '<option value="">(不轉移，庫存將被清除)</option>';
      }

      appData.locations.forEach(location => {
        const option = document.createElement('option');
        option.value = location.LocationID;
        option.textContent = location.LocationName;
        select.appendChild(option);
      });
      if (currentVal && Array.from(select.options).some(opt => opt.value === currentVal)) {
        select.value = currentVal;
      }
    });
  }

  function populateProductSelects() {
    const selects = document.querySelectorAll('select[id$="-product-select"]');
    selects.forEach(select => {
      const currentVal = select.value;
      select.innerHTML = '<option value="">(請選擇產品)</option>';
      appData.products.forEach(product => {
        const option = document.createElement('option');
        option.value = product.ProductID;
        option.textContent = `${product.ProductName} (${product.Brand} - ${product.Category})`;
        select.appendChild(option);
      });
      if (currentVal && Array.from(select.options).some(opt => opt.value === currentVal)) {
        select.value = currentVal;
      }
    });
  }

  function populateBrandAndCategoryFilters() {
    const brandFilter = document.getElementById('inventory-brand-filter');
    const categoryFilter = document.getElementById('inventory-category-filter');

    // Clear existing options
    brandFilter.innerHTML = '<option value="">所有品牌</option>';
    categoryFilter.innerHTML = '<option value="">所有類別</option>';

    const brands = new Set();
    const categories = new Set();

    appData.products.forEach(product => {
      brands.add(product.Brand);
      categories.add(product.Category);
    });

    brands.forEach(brand => {
      const option = document.createElement('option');
      option.value = brand;
      option.textContent = brand;
      brandFilter.appendChild(option);
    });

    categories.forEach(category => {
      const option = document.createElement('option');
      option.value = category;
      option.textContent = category;
      categoryFilter.appendChild(option);
    });
  }


  // --- Tab Switching ---

  function switchTab(tabName) {
    // If switching to a new tab, exit delete mode from previous tab if active
    if (appData.activeTab !== tabName) {
        if (appData.activeTab === 'locations' && appData.isLocationDeleteMode) {
            toggleLocationDeleteMode(false); // Explicitly exit
        } else if (appData.activeTab === 'products' && appData.isProductDeleteMode) {
            toggleProductDeleteMode(false); // Explicitly exit
        } else if (appData.activeTab === 'transactions' && appData.isTransactionDeleteMode) {
            toggleTransactionDeleteMode(false); // Explicitly exit
        }
    }

    const tabContents = document.querySelectorAll('.tab-content');
    tabContents.forEach(content => content.classList.remove('active'));

    const tabButtons = document.querySelectorAll('.tab-button');
    tabButtons.forEach(button => button.classList.remove('active'));

    document.getElementById(`${tabName}-tab`).classList.add('active');
    document.querySelector(`.tab-button[onclick="switchTab('${tabName}')"]`).classList.add('active');

    appData.activeTab = tabName; // Update active tab state

    // Re-render content when switching to ensure up-to-date data and UI state
    if (tabName === 'home') {
      renderRecentTransactions();
    } else if (tabName === 'locations') {
      renderLocations();
    } else if (tabName === 'products') {
      renderProducts();
    } else if (tabName === 'transactions') {
      renderTransactions();
    } else if (tabName === 'inventory') {
      performInventoryQuery(); // Render inventory based on current filters
    }
  }


  // --- Home Tab Functions ---

  function renderRecentTransactions() {
    const tbody = document.getElementById('recent-transactions-table-body');
    tbody.innerHTML = ''; // Clear existing
    
    // Get transactions from the last 7 days
    const sevenDaysAgo = new Date();
    sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
    sevenDaysAgo.setHours(0, 0, 0, 0); // Set to start of the day
    
    const recent = appData.transactions.filter(t => {
      const transactionDate = new Date(t.Timestamp.split(' ')[0]); // Parse only date part
      return transactionDate >= sevenDaysAgo;
    }).sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp)); // Sort newest first

    if (recent.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">近七天無交易紀錄。</td></tr>';
      return;
    }

    recent.forEach(transaction => {
      const product = appData.products.find(p => p.ProductID === transaction.ProductID);
      const row = tbody.insertRow();
      const date = new Date(transaction.Timestamp).toLocaleDateString();
      const quantityText = transaction.Type === 'In' 
                           ? `<span style="color: green;">+${transaction.Quantity}</span>` 
                           : `<span style="color: red;">-${transaction.Quantity}</span>`;
      
      row.insertCell().textContent = date;
      row.insertCell().textContent = product ? product.ProductName : '未知產品';
      row.insertCell().innerHTML = quantityText;
    });
  }

  let transactionType = ''; // To store 'In' or 'Out' for the modal

  function openTransactionModal(type) {
    transactionType = type;
    document.getElementById('transaction-modal-title').textContent = type === 'In' ? '新增入庫紀錄' : '新增出庫紀錄';
    document.getElementById('transaction-entries-container').innerHTML = ''; // Clear previous entries
    addTransactionRow(); // Add an initial row
    document.getElementById('transaction-modal').style.display = 'flex'; // Use flex for centering
  }

  function addTransactionRow() {
    const container = document.getElementById('transaction-entries-container');
    const entryDiv = document.createElement('div');
    entryDiv.className = 'record-row';
    entryDiv.innerHTML = `
      <div class="record-info">
        <div class="form-group">
          <label>產品:</label>
          <select class="transaction-product-select" onchange="checkOutboundInventory(this)">
            <option value="">(請選擇產品)</option>
            ${appData.products.map(p => `<option value="${p.ProductID}">${p.ProductName} (${p.Brand} - ${p.Category})</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>地點:</label>
          <select class="transaction-location-select" onchange="checkOutboundInventory(this)">
            <option value="">(請選擇地點)</option>
            ${appData.locations.map(l => `<option value="${l.LocationID}">${l.LocationName}</option>`).join('')}
          </select>
        </div>
        <div class="form-group">
          <label>數量:</label>
          <div class="quantity-input-group">
            <button type="button" onclick="updateQuantityInput(this, -1)">-</button>
            <input type="number" class="transaction-quantity-input" value="1" min="1" onchange="checkOutboundInventory(this)" onkeyup="checkOutboundInventory(this)">
            <button type="button" onclick="updateQuantityInput(this, 1)">+</button>
          </div>
          <p class="current-inventory-info" style="color: #666; font-size: 0.8em; margin-top: 5px;"></p>
        </div>
        <div class="form-group">
          <label>備註:</label>
          <input type="text" class="transaction-notes-input" placeholder="選填備註">
        </div>
      </div>
      <button class="remove-record-btn" type="button" onclick="removeRow(this)">移除</button>
    `;
    container.appendChild(entryDiv);
  }

  function removeRow(button) { // Made generic for any row removal
    const rowDiv = button.closest('.record-row') || button.closest('.form-group') || button.closest('.product-entry-group'); // Added product-entry-group
    if (rowDiv) {
      rowDiv.remove();
    }
  }

  function updateQuantityInput(button, change) {
    const input = button.parentNode.querySelector('.transaction-quantity-input');
    let value = parseInt(input.value);
    if (isNaN(value)) value = 0;
    value += change;
    if (value < 1) value = 1; // Prevent going below 1
    input.value = value;
    checkOutboundInventory(input); // Re-check inventory after quantity change
  }

  function checkOutboundInventory(element) {
    if (transactionType !== 'Out') return; // Only for outbound transactions

    const entryDiv = element.closest('.record-row');
    const productSelect = entryDiv.querySelector('.transaction-product-select');
    const locationSelect = entryDiv.querySelector('.transaction-location-select');
    const quantityInput = entryDiv.querySelector('.transaction-quantity-input');
    const inventoryInfo = entryDiv.querySelector('.current-inventory-info');

    const productId = productSelect.value;
    const locationId = locationSelect.value;
    const requestedQuantity = parseInt(quantityInput.value);

    if (!productId || !locationId || isNaN(requestedQuantity) || requestedQuantity < 1) {
      inventoryInfo.textContent = '';
      return;
    }

    const currentInventory = appData.inventory.find(inv => 
      inv.ProductID === productId && inv.LocationID === locationId
    );
    const availableQuantity = currentInventory ? currentInventory.Quantity : 0;

    inventoryInfo.textContent = `現有庫存: ${availableQuantity}`;

    if (requestedQuantity > availableQuantity) {
      inventoryInfo.style.color = 'red';
      // Optional: disable submit button or show error
    } else {
      inventoryInfo.style.color = '#666';
    }
  }

  function submitBulkTransactions() {
    const transactionEntries = document.querySelectorAll('#transaction-entries-container .record-row');
    const transactionsToSubmit = [];
    let hasError = false;

    transactionEntries.forEach(entryDiv => {
      const productSelect = entryDiv.querySelector('.transaction-product-select');
      const locationSelect = entryDiv.querySelector('.transaction-location-select');
      const quantityInput = entryDiv.querySelector('.transaction-quantity-input');
      const notesInput = entryDiv.querySelector('.transaction-notes-input');
      const inventoryInfo = entryDiv.querySelector('.current-inventory-info');

      const productId = productSelect.value;
      const locationId = locationSelect.value;
      const quantity = parseInt(quantityInput.value);
      const notes = notesInput.value.trim();

      if (!productId || !locationId || isNaN(quantity) || quantity < 1) {
        showToast('請確保所有交易記錄的產品、地點、數量都已正確填寫。', 'error');
        hasError = true;
        return;
      }

      if (transactionType === 'Out') {
        const currentInventory = appData.inventory.find(inv => 
          inv.ProductID === productId && inv.LocationID === locationId
        );
        const availableQuantity = currentInventory ? currentInventory.Quantity : 0;
        if (quantity > availableQuantity) {
          showToast(`產品: ${appData.products.find(p => p.ProductID === productId)?.ProductName} 在地點: ${appData.locations.find(l => l.LocationID === locationId)?.LocationName} 庫存不足。現有: ${availableQuantity}, 請求: ${quantity}`, 'error');
          hasError = true;
          return;
        }
      }

      transactionsToSubmit.push({
        Type: transactionType,
        ProductID: productId,
        LocationID: locationId,
        Quantity: quantity,
        Notes: notes
      });
    });

    if (hasError || transactionsToSubmit.length === 0) {
      if (transactionsToSubmit.length === 0 && !hasError) showToast('請至少新增一筆交易紀錄。', 'error');
      return;
    }

    // Call Apps Script function
    google.script.run
      .withSuccessHandler(function() {
        showToast('交易紀錄已成功提交！');
        closeModal('transaction-modal');
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData(); // Re-initialize data
      })
      .withFailureHandler(function(error) {
        showToast('提交交易時發生錯誤: ' + error.message, 'error');
      })
      .addBulkTransactionsAndUpdateInventory(transactionsToSubmit);
  }


  // --- Location Management Functions ---

  function renderLocations() {
    const tbody = document.getElementById('locations-table-body');
    tbody.innerHTML = ''; // Clear existing

    // Get current search query
    const searchQuery = document.getElementById('location-search-input').value.toLowerCase();
    
    // Filter locations based on search query
    const filteredLocations = appData.locations.filter(location => 
      location.LocationName.toLowerCase().includes(searchQuery)
    ).sort((a, b) => a.LocationName.localeCompare(b.LocationName)); // Sort alphabetically

    if (filteredLocations.length === 0) {
      tbody.innerHTML = '<tr><td colspan="3" style="text-align: center;">沒有地點資料。</td></tr>';
      return;
    }

    filteredLocations.forEach(location => {
      const row = tbody.insertRow();
      row.setAttribute('data-location-id', location.LocationID);

      const locationQuantity = appData.inventory
        .filter(inv => inv.LocationID === location.LocationID)
        .reduce((sum, inv) => sum + inv.Quantity, 0);

      if (appData.editingLocationId === location.LocationID) {
        // Editing state
        row.innerHTML = `
          <td><input type="text" value="${location.LocationName}" id="edit-location-name-${location.LocationID}"></td>
          <td>${locationQuantity}</td>
          <td class="action-buttons">
            <button class="save" onclick="saveLocation('${location.LocationID}')">儲存</button>
          </td>
        `;
      } else {
        // Display state
        row.innerHTML = `
          <td>${location.LocationName}</td>
          <td>${locationQuantity}</td>
          <td class="action-buttons">
            ${appData.isLocationDeleteMode 
                ? `<input type="checkbox" class="delete-checkbox" value="${location.LocationID}">`
                : `<button class="edit edit-button" onclick="editLocation('${location.LocationID}')" ${appData.editingLocationId ? 'disabled' : ''}>編輯</button>`
            }
          </td>
        `;
      }
    });

    // Update the action header text based on delete mode
    document.getElementById('locations-action-header').textContent = appData.isLocationDeleteMode ? '刪除' : '操作';
    // Disable other edit buttons if one is being edited
    setEditButtonsState(appData.editingLocationId !== null, appData.editingLocationId, 'location');
  }

  function filterLocations() {
    renderLocations(); // Re-render table with filtered results
  }

  function openAddLocationModal() {
    document.getElementById('new-location-entries').innerHTML = ''; // Clear any previous inputs
    addLocationInput(); // Add an initial input field
    document.getElementById('add-location-modal').style.display = 'flex';
  }

  function addLocationInput() {
    const container = document.getElementById('new-location-entries');
    const inputId = `new-location-name-${Date.now()}`;
    const div = document.createElement('div');
    div.className = 'form-group'; // Keep form-group class for new layout
    div.innerHTML = `
      <label for="${inputId}">地點名稱:</label>
      <input type="text" id="${inputId}" class="new-location-name-input" placeholder="輸入地點名稱">
      <button class="remove-record-btn" type="button" onclick="removeRow(this)">移除</button>
    `;
    container.appendChild(div);
  }

  function submitAddLocations() {
    const newLocationInputs = document.querySelectorAll('.new-location-name-input');
    const locationsToAdd = [];
    let hasError = false;

    newLocationInputs.forEach(input => {
      const locationName = input.value.trim();
      if (locationName) {
        // Check for duplicates before adding to batch
        if (appData.locations.some(loc => loc.LocationName === locationName)) {
            showToast(`地點名稱 "${locationName}" 已存在，請修改。`, 'error');
            hasError = true;
            return;
        }
        locationsToAdd.push(locationName);
      }
    });

    if (hasError || locationsToAdd.length === 0) {
      if (locationsToAdd.length === 0 && !hasError) showToast('請輸入至少一個地點名稱。', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('地點已成功新增！');
        closeModal('add-location-modal');
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData(); // Re-initialize data
      })
      .withFailureHandler(function(error) {
        showToast('新增地點時發生錯誤: ' + error.message, 'error');
      })
      .addLocations(locationsToAdd);
  }

  function editLocation(locationId) {
    if (appData.isLocationDeleteMode) return; // Prevent editing in delete mode
    appData.editingLocationId = locationId;
    renderLocations(); // Re-render to show input field
  }

  function saveLocation(locationId) {
    const newNameInput = document.getElementById(`edit-location-name-${locationId}`);
    const newName = newNameInput.value.trim();
    const originalLocation = appData.locations.find(loc => loc.LocationID === locationId);

    if (!newName) {
      showToast('地點名稱不能為空！', 'error');
      return;
    }
    // Check for duplicates against other locations, excluding the one being edited
    if (appData.locations.some(loc => loc.LocationName === newName && loc.LocationID !== locationId)) {
        showToast(`地點名稱 "${newName}" 已存在，請修改。`, 'error');
        return;
    }

    if (newName === originalLocation.LocationName) {
        showToast('地點名稱沒有改變。', 'info');
        appData.editingLocationId = null; // Exit editing mode
        renderLocations();
        return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('地點名稱已成功更新！');
        appData.editingLocationId = null; // Exit editing mode
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData(); // Re-initialize data
      })
      .withFailureHandler(function(error) {
        showToast('更新地點名稱時發生錯誤: ' + error.message, 'error');
        appData.editingLocationId = null; // Exit editing mode on error
        renderLocations(); // Re-render to original state
      })
      .updateLocationName(locationId, newName);
  }
  
  function toggleLocationDeleteMode(forceExit = false) {
    // If forceExit is true, we are explicitly exiting delete mode (e.g., from tab switch)
    if (forceExit && !appData.isLocationDeleteMode) return; // Already not in delete mode
    
    appData.isLocationDeleteMode = forceExit ? false : !appData.isLocationDeleteMode;
    const deleteButton = document.getElementById('delete-location-btn');
    
    // Find or create the cancel button wrapper
    let cancelButtonContainer = deleteButton.parentNode.querySelector('.cancel-delete-container');
    if (!cancelButtonContainer) {
        cancelButtonContainer = document.createElement('span');
        cancelButtonContainer.className = 'cancel-delete-container';
        deleteButton.parentNode.appendChild(cancelButtonContainer);
    }
    
    if (appData.isLocationDeleteMode) {
      deleteButton.textContent = '確認刪除';
      deleteButton.classList.add('confirm-delete');
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'button-orange'; // Changed to button-orange
      cancelButton.textContent = '取消刪除';
      cancelButton.onclick = function() {
          toggleLocationDeleteMode(true); 
          document.querySelectorAll('#locations-table-body .delete-checkbox:checked').forEach(cb => cb.checked = false);
      };
      cancelButtonContainer.innerHTML = ''; 
      cancelButtonContainer.appendChild(cancelButton);

      // Disable '新增地點' button
      document.querySelector('#locations-tab .action-buttons .primary').disabled = true;

    } else {
      deleteButton.textContent = '刪除';
      deleteButton.classList.remove('confirm-delete');
      // Remove cancel button
      cancelButtonContainer.innerHTML = ''; 

      // Enable '新增地點' button
      document.querySelector('#locations-tab .action-buttons .primary').disabled = false;

      // If exiting delete mode normally (not forced by tab switch) and there are selected items
      if (!forceExit) {
        const selectedCheckboxes = document.querySelectorAll('#locations-table-body .delete-checkbox:checked');
        if (selectedCheckboxes.length > 0) {
            openDeleteLocationConfirmModal();
        }
      }
    }
    renderLocations(); 
  }

  function openDeleteLocationConfirmModal() {
    const selectedCheckboxes = document.querySelectorAll('#locations-table-body .delete-checkbox:checked');
    document.getElementById('selected-locations-count').textContent = selectedCheckboxes.length;
    
    const transferSelect = document.getElementById('transfer-location-select');
    transferSelect.innerHTML = '<option value="">(不轉移，庫存將被清除)</option>'; // Reset options

    const selectedLocationIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    // Filter out selected locations from the transfer options
    appData.locations.forEach(location => {
      if (!selectedLocationIds.includes(location.LocationID)) {
        const option = document.createElement('option');
        option.value = location.LocationID;
        option.textContent = location.LocationName;
        transferSelect.appendChild(option);
      }
    });

    document.getElementById('delete-location-confirm-modal').style.display = 'flex';
  }

  function confirmDeleteSelectedLocations() {
    const selectedCheckboxes = document.querySelectorAll('#locations-table-body .delete-checkbox:checked');
    const locationIdsToDelete = Array.from(selectedCheckboxes).map(cb => cb.value);
    const transferToLocationId = document.getElementById('transfer-location-select').value;

    if (locationIdsToDelete.length === 0) {
      showToast('請至少選擇一個地點進行刪除。', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('地點及其庫存已成功處理！');
        closeModal('delete-location-confirm-modal');
        toggleLocationDeleteMode(true); // Explicitly exit delete mode after action
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData(); // Re-initialize data
      })
      .withFailureHandler(function(error) {
        showToast('刪除地點時發生錯誤: ' + error.message, 'error');
        closeModal('delete-location-confirm-modal');
        toggleLocationDeleteMode(true); // Explicitly exit delete mode on error
      })
      .deleteLocationsAndTransferInventory(locationIdsToDelete, transferToLocationId);
  }

  // --- Product Management Functions ---

  function renderProducts() {
    const tbody = document.getElementById('products-table-body');
    tbody.innerHTML = ''; // Clear existing

    const searchQuery = document.getElementById('product-search-input').value.toLowerCase();
    
    const filteredProducts = appData.products.filter(product => 
      product.ProductName.toLowerCase().includes(searchQuery) ||
      product.Brand.toLowerCase().includes(searchQuery) ||
      product.Category.toLowerCase().includes(searchQuery)
    ).sort((a, b) => { // Sort by Category, then Brand, then ProductName
        if (a.Category !== b.Category) return a.Category.localeCompare(b.Category);
        if (a.Brand !== b.Brand) return a.Brand.localeCompare(b.Brand);
        return a.ProductName.localeCompare(b.ProductName);
    });

    if (filteredProducts.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">沒有產品資料。</td></tr>';
      return;
    }

    filteredProducts.forEach(product => {
      const row = tbody.insertRow();
      row.setAttribute('data-product-id', product.ProductID);

      if (appData.editingProductId === product.ProductID) {
        // Editing state
        row.innerHTML = `
          <td><input type="text" value="${product.Category}" id="edit-product-category-${product.ProductID}"></td>
          <td><input type="text" value="${product.Brand}" id="edit-product-brand-${product.ProductID}"></td>
          <td><input type="text" value="${product.ProductName}" id="edit-product-name-${product.ProductID}"></td>
          <td class="action-buttons">
            <button class="save" onclick="saveProduct('${product.ProductID}')">儲存</button>
          </td>
        `;
      } else {
        // Display state
        row.innerHTML = `
          <td>${product.Category}</td>
          <td>${product.Brand}</td>
          <td>${product.ProductName}</td>
          <td class="action-buttons">
            ${appData.isProductDeleteMode 
                ? `<input type="checkbox" class="delete-checkbox" value="${product.ProductID}">`
                : `<button class="edit edit-button" onclick="editProduct('${product.ProductID}')" ${appData.editingProductId ? 'disabled' : ''}>編輯</button>`
            }
          </td>
        `;
      }
    });

    document.getElementById('products-action-header').textContent = appData.isProductDeleteMode ? '刪除' : '操作';
    setEditButtonsState(appData.editingProductId !== null, appData.editingProductId, 'product');
  }

  function filterProducts() {
    renderProducts();
  }

  function openAddProductModal() {
    document.getElementById('new-product-entries').innerHTML = '';
    addProductInput();
    document.getElementById('add-product-modal').style.display = 'flex';
  }

  function addProductInput() {
    const container = document.getElementById('new-product-entries');
    const entryDiv = document.createElement('div');
    entryDiv.className = 'product-entry-group'; // Use a new class for product entry rows
    entryDiv.innerHTML = `
      <div class="form-group">
        <label>產品名稱:</label>
        <input type="text" class="new-product-name-input" placeholder="產品名稱">
      </div>
      <div class="form-group">
        <label>品牌:</label>
        <input type="text" class="new-product-brand-input" placeholder="品牌">
      </div>
      <div class="form-group">
        <label>類別:</label>
        <input type="text" class="new-product-category-input" placeholder="類別">
      </div>
      <button class="remove-record-btn" type="button" onclick="removeRow(this)">移除</button>
    `;
    container.appendChild(entryDiv);
  }
  // Helper for removeRow (since product entries are grouped by product-entry-group)
  function removeRow(button) { 
    const rowDiv = button.closest('.record-row') || button.closest('.form-group') || button.closest('.product-entry-group');
    if (rowDiv) {
      rowDiv.remove();
    }
  }

  function submitAddProducts() {
    const newProductEntries = document.querySelectorAll('#new-product-entries .product-entry-group');
    
    const productsToAdd = [];
    let hasError = false;

    newProductEntries.forEach(entryDiv => {
      const productName = entryDiv.querySelector('.new-product-name-input').value.trim();
      const productBrand = entryDiv.querySelector('.new-product-brand-input').value.trim();
      const productCategory = entryDiv.querySelector('.new-product-category-input').value.trim();

      if (productName && productBrand && productCategory) {
        // Simple duplicate check (name + brand + category combination)
        if (appData.products.some(p => 
            p.ProductName === productName && 
            p.Brand === productBrand && 
            p.Category === productCategory
        )) {
            showToast(`產品 "${productName}" (品牌: ${productBrand}, 類別: ${productCategory}) 已存在，請修改。`, 'error');
            hasError = true;
            return;
        }
        productsToAdd.push({
          ProductName: productName,
          Brand: productBrand,
          Category: productCategory
        });
      } else if (productName || productBrand || productCategory) {
        // If some fields are filled but not all for a row
        showToast('請填寫所有產品資訊 (名稱、品牌、類別)。', 'error');
        hasError = true;
        return;
      }
    });

    if (hasError || productsToAdd.length === 0) {
      if (productsToAdd.length === 0 && !hasError) showToast('請輸入至少一個產品的完整資訊。', 'error');
      return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('產品已成功新增！');
        closeModal('add-product-modal');
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
      })
      .withFailureHandler(function(error) {
        showToast('新增產品時發生錯誤: ' + error.message, 'error');
      })
      .addProducts(productsToAdd);
  }

  function editProduct(productId) {
    if (appData.isProductDeleteMode) return;
    appData.editingProductId = productId;
    renderProducts();
  }

  function saveProduct(productId) {
    const newCategoryInput = document.getElementById(`edit-product-category-${productId}`);
    const newBrandInput = document.getElementById(`edit-product-brand-${productId}`);
    const newNameInput = document.getElementById(`edit-product-name-${productId}`);

    const newCategory = newCategoryInput.value.trim();
    const newBrand = newBrandInput.value.trim();
    const newName = newNameInput.value.trim();
    
    const originalProduct = appData.products.find(p => p.ProductID === productId);

    if (!newName || !newBrand || !newCategory) {
      showToast('產品名稱、品牌、類別不能為空！', 'error');
      return;
    }
    // Check for duplicates against other products, excluding the one being edited
    if (appData.products.some(p => 
        p.ProductName === newName && 
        p.Brand === newBrand && 
        p.Category === newCategory &&
        p.ProductID !== productId
    )) {
        showToast(`產品 "${newName}" (品牌: ${newBrand}, 類別: ${newCategory}) 已存在，請修改。`, 'error');
        return;
    }

    if (newName === originalProduct.ProductName && 
        newBrand === originalProduct.Brand && 
        newCategory === originalProduct.Category) {
        showToast('產品資訊沒有改變。', 'info');
        appData.editingProductId = null;
        renderProducts();
        return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('產品資訊已成功更新！');
        appData.editingProductId = null;
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
      })
      .withFailureHandler(function(error) {
        showToast('更新產品資訊時發生錯誤: ' + error.message, 'error');
        appData.editingProductId = null;
        renderProducts();
      })
      .updateProduct(productId, newName, newBrand, newCategory);
  }

  function toggleProductDeleteMode(forceExit = false) {
    if (forceExit && !appData.isProductDeleteMode) return;
    
    appData.isProductDeleteMode = forceExit ? false : !appData.isProductDeleteMode;
    const deleteButton = document.getElementById('delete-product-btn');
    
    let cancelButtonContainer = deleteButton.parentNode.querySelector('.cancel-delete-container');
    if (!cancelButtonContainer) {
        cancelButtonContainer = document.createElement('span');
        cancelButtonContainer.className = 'cancel-delete-container';
        deleteButton.parentNode.appendChild(cancelButtonContainer);
    }

    if (appData.isProductDeleteMode) {
      deleteButton.textContent = '確認刪除';
      deleteButton.classList.add('confirm-delete');
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'button-orange'; // Changed to button-orange
      cancelButton.textContent = '取消刪除';
      cancelButton.onclick = function() {
          toggleProductDeleteMode(true);
          document.querySelectorAll('#products-table-body .delete-checkbox:checked').forEach(cb => cb.checked = false);
      };
      cancelButtonContainer.innerHTML = '';
      cancelButtonContainer.appendChild(cancelButton);

      document.querySelector('#products-tab .action-buttons .primary').disabled = true;

    } else {
      deleteButton.textContent = '刪除';
      deleteButton.classList.remove('confirm-delete');
      cancelButtonContainer.innerHTML = '';

      document.querySelector('#products-tab .action-buttons .primary').disabled = false;

      if (!forceExit) {
        const selectedCheckboxes = document.querySelectorAll('#products-table-body .delete-checkbox:checked');
        if (selectedCheckboxes.length > 0) {
            confirmDeleteSelectedProducts(); 
        }
      }
    }
    renderProducts();
  }

  function confirmDeleteSelectedProducts() {
    const selectedCheckboxes = document.querySelectorAll('#products-table-body .delete-checkbox:checked');
    const productIdsToDelete = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (productIdsToDelete.length === 0) {
      showToast('請至少選擇一個產品進行刪除。', 'error');
      return;
    }

    if (!confirm(`確定要刪除這 ${productIdsToDelete.length} 個產品嗎？相關庫存將會被清除！`)) {
        toggleProductDeleteMode(true); 
        return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('產品已成功刪除！');
        toggleProductDeleteMode(true); 
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
      })
      .withFailureHandler(function(error) {
        showToast('刪除產品時發生錯誤: ' + error.message, 'error');
        toggleProductDeleteMode(true); 
      })
      .deleteProducts(productIdsToDelete);
  }


  // --- Transaction Management Functions ---

  function renderTransactions() {
    const tbody = document.getElementById('transactions-table-body');
    tbody.innerHTML = '';

    const searchQuery = document.getElementById('transaction-search-input').value.toLowerCase();
    const filterYear = document.getElementById('transaction-year-filter').value;
    const filterMonth = document.getElementById('transaction-month-filter').value;

    const filteredTransactions = appData.transactions.filter(t => {
      const product = appData.products.find(p => p.ProductID === t.ProductID);
      const location = appData.locations.find(l => l.LocationID === t.LocationID);
      const transactionDate = new Date(t.Timestamp);

      // Text search
      const matchesSearch = (
        (product && product.ProductName.toLowerCase().includes(searchQuery)) ||
        (location && location.LocationName.toLowerCase().includes(searchQuery)) ||
        t.Notes.toLowerCase().includes(searchQuery) ||
        t.Type.toLowerCase().includes(searchQuery) 
      );

      // Year/Month filter
      const matchesYear = filterYear ? transactionDate.getFullYear().toString() === filterYear : true;
      const matchesMonth = filterMonth ? (transactionDate.getMonth() + 1).toString() === filterMonth : true;

      return matchesSearch && matchesYear && matchesMonth;
    }).sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp)); 

    if (filteredTransactions.length === 0) {
      tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">沒有交易紀錄。</td></tr>';
      return;
    }

    filteredTransactions.forEach(transaction => {
      const product = appData.products.find(p => p.ProductID === transaction.ProductID);
      const location = appData.locations.find(l => l.LocationID === transaction.LocationID);
      const row = tbody.insertRow();
      row.setAttribute('data-transaction-id', transaction.TransactionID);

      const date = new Date(transaction.Timestamp).toLocaleDateString();
      const quantityText = transaction.Type === 'In' 
                           ? `<span style="color: green;">+${transaction.Quantity}</span>` 
                           : `<span style="color: red;">-${transaction.Quantity}</span>`;
      
      row.insertCell().textContent = date;
      row.insertCell().textContent = product ? product.ProductName : '未知產品';
      row.insertCell().textContent = location ? location.LocationName : '未知地點';
      row.insertCell().innerHTML = quantityText;
      row.insertCell().textContent = transaction.Notes;
      
      const actionCell = row.insertCell();
      actionCell.className = 'action-buttons';
      if (appData.isTransactionDeleteMode) {
          actionCell.innerHTML = `<input type="checkbox" class="delete-checkbox" value="${transaction.TransactionID}">`;
      } else {
          actionCell.innerHTML = `<button class="edit edit-button" onclick="editTransaction('${transaction.TransactionID}')" ${appData.editingTransactionId ? 'disabled' : ''}>編輯</button>`;
      }
    });

    document.getElementById('transactions-action-header').textContent = appData.isTransactionDeleteMode ? '刪除' : '操作';
    setEditButtonsState(appData.editingTransactionId !== null, appData.editingTransactionId, 'transaction');
  }

  function filterTransactions() {
    renderTransactions();
  }

  function editTransaction(transactionId) {
    if (appData.isTransactionDeleteMode) return;
    appData.editingTransactionId = transactionId;
    
    const transaction = appData.transactions.find(t => t.TransactionID === transactionId);
    if (!transaction) {
      showToast('找不到該交易記錄。', 'error');
      appData.editingTransactionId = null;
      renderTransactions();
      return;
    }

    // Open transaction modal, but populate with existing data for editing
    openTransactionModalForEdit(transaction);
  }

  function openTransactionModalForEdit(transaction) {
    transactionType = transaction.Type; // Set type for quantity check
    document.getElementById('transaction-modal-title').textContent = `編輯交易紀錄 (ID: ${transaction.TransactionID})`;
    document.getElementById('transaction-entries-container').innerHTML = ''; // Clear previous entries

    const entryDiv = document.createElement('div');
    entryDiv.className = 'record-row';
    entryDiv.innerHTML = `
      <div class="record-info">
        <div class="form-group">
          <label>產品:</label>
          <select class="transaction-product-select" disabled>
            <option value="${transaction.ProductID}">${appData.products.find(p => p.ProductID === transaction.ProductID)?.ProductName || '未知產品'}</option>
          </select>
        </div>
        <div class="form-group">
          <label>地點:</label>
          <select class="transaction-location-select" disabled>
            <option value="${transaction.LocationID}">${appData.locations.find(l => l.LocationID === transaction.LocationID)?.LocationName || '未知地點'}</option>
          </select>
        </div>
        <div class="form-group">
          <label>數量:</label>
          <div class="quantity-input-group">
            <button type="button" onclick="updateQuantityInput(this, -1)">-</button>
            <input type="number" class="transaction-quantity-input" value="${transaction.Quantity}" min="1" onchange="checkOutboundInventory(this)" onkeyup="checkOutboundInventory(this)">
            <button type="button" onclick="updateQuantityInput(this, 1)">+</button>
          </div>
          <p class="current-inventory-info" style="color: #666; font-size: 0.8em; margin-top: 5px;"></p>
        </div>
        <div class="form-group">
          <label>備註:</label>
          <input type="text" class="transaction-notes-input" value="${transaction.Notes}" placeholder="選填備註">
        </div>
      </div>
      <!-- No remove button for single edit -->
    `;
    document.getElementById('transaction-entries-container').appendChild(entryDiv);

    // Hide the "新增一筆" button when editing a single transaction
    document.getElementById('add-transaction-row-btn').style.display = 'none';

    // Update the submit button to call submitEditTransaction
    const submitBtn = document.querySelector('#transaction-modal .confirm');
    submitBtn.onclick = () => submitEditTransaction(transaction.TransactionID, transaction.Quantity); 
    
    // Check inventory info immediately if it's an 'Out' transaction
    if (transaction.Type === 'Out') {
        const quantityInput = entryDiv.querySelector('.transaction-quantity-input');
        checkOutboundInventory(quantityInput);
    }
    
    document.getElementById('transaction-modal').style.display = 'flex';
  }

  function submitEditTransaction(transactionId, originalQuantity) {
    const entryDiv = document.querySelector(`#transaction-entries-container .record-row`);
    const newQuantity = parseInt(entryDiv.querySelector('.transaction-quantity-input').value);
    const newNotes = entryDiv.querySelector('.transaction-notes-input').value.trim();

    if (isNaN(newQuantity) || newQuantity < 1) {
      showToast('數量必須是有效的數字且大於0。', 'error');
      return;
    }

    const transaction = appData.transactions.find(t => t.TransactionID === transactionId);
    if (!transaction) {
      showToast('找不到該交易記錄。', 'error');
      return;
    }

    // If it's an outbound transaction and new quantity exceeds available stock
    if (transaction.Type === 'Out') {
        const currentInventory = appData.inventory.find(inv => 
            inv.ProductID === transaction.ProductID && inv.LocationID === transaction.LocationID
        );
        const availableQuantity = currentInventory ? currentInventory.Quantity : 0;
        // Calculate the effective change in stock if the original transaction quantity changes
        const quantityDifference = newQuantity - originalQuantity;
        if (availableQuantity - quantityDifference < 0) { 
            showToast(`庫存不足。現有庫存：${availableQuantity}。您嘗試將數量從 ${originalQuantity} 修改為 ${newQuantity}。`, 'error');
            return;
        }
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('交易紀錄已成功更新！');
        appData.editingTransactionId = null; // Exit editing mode
        closeModal('transaction-modal');
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
      })
      .withFailureHandler(function(error) {
        showToast('更新交易時發生錯誤: ' + error.message, 'error');
        appData.editingTransactionId = null;
        closeModal('transaction-modal');
        renderTransactions();
      })
      .updateTransactionAndInventory(transactionId, newNotes, newQuantity);
  }

  function toggleTransactionDeleteMode(forceExit = false) {
    if (forceExit && !appData.isTransactionDeleteMode) return;
    
    appData.isTransactionDeleteMode = forceExit ? false : !appData.isTransactionDeleteMode;
    const deleteButton = document.getElementById('delete-transaction-btn');
    
    let cancelButtonContainer = deleteButton.parentNode.querySelector('.cancel-delete-container');
    if (!cancelButtonContainer) {
        cancelButtonContainer = document.createElement('span');
        cancelButtonContainer.className = 'cancel-delete-container';
        deleteButton.parentNode.appendChild(cancelButtonContainer);
    }

    if (appData.isTransactionDeleteMode) {
      deleteButton.textContent = '確認刪除';
      deleteButton.classList.add('confirm-delete');
      
      const cancelButton = document.createElement('button');
      cancelButton.className = 'button-orange'; // Changed to button-orange
      cancelButton.textContent = '取消刪除';
      cancelButton.onclick = function() {
          toggleTransactionDeleteMode(true);
          document.querySelectorAll('#transactions-table-body .delete-checkbox:checked').forEach(cb => cb.checked = false);
      };
      cancelButtonContainer.innerHTML = '';
      cancelButtonContainer.appendChild(cancelButton);

      // Disable '入庫', '出庫' buttons
      document.querySelector('#transactions-tab .action-buttons .primary').disabled = true;
      document.querySelector('#transactions-tab .action-buttons .button-brown').disabled = true;

    } else {
      deleteButton.textContent = '刪除';
      deleteButton.classList.remove('confirm-delete');
      cancelButtonContainer.innerHTML = '';

      document.querySelector('#transactions-tab .action-buttons .primary').disabled = false;
      document.querySelector('#transactions-tab .action-buttons .button-brown').disabled = false;

      if (!forceExit) {
        const selectedCheckboxes = document.querySelectorAll('#transactions-table-body .delete-checkbox:checked');
        if (selectedCheckboxes.length > 0) {
            confirmDeleteSelectedTransactions(); 
        }
      }
    }
    renderTransactions();
  }

  function confirmDeleteSelectedTransactions() {
    const selectedCheckboxes = document.querySelectorAll('#transactions-table-body .delete-checkbox:checked');
    const transactionIdsToDelete = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (transactionIdsToDelete.length === 0) {
      showToast('請至少選擇一個交易紀錄進行刪除。', 'error');
      return;
    }

    if (!confirm(`確定要刪除這 ${transactionIdsToDelete.length} 個交易紀錄嗎？這會影響庫存數量。`)) {
        toggleTransactionDeleteMode(true); 
        return;
    }

    google.script.run
      .withSuccessHandler(function() {
        showToast('交易紀錄已成功刪除！庫存已同步調整。');
        toggleTransactionDeleteMode(true); 
        google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
      })
      .withFailureHandler(function(error) {
        showToast('刪除交易時發生錯誤: ' + error.message, 'error');
        toggleTransactionDeleteMode(true); 
      })
      .deleteTransactionsAndUpdateInventory(transactionIdsToDelete);
  }


  // --- Inventory Query Functions ---

  function performInventoryQuery() {
    const tbody = document.getElementById('inventory-table-body');
    tbody.innerHTML = '';

    const selectedLocationId = document.getElementById('inventory-location-filter').value;
    const selectedBrand = document.getElementById('inventory-brand-filter').value;
    const selectedCategory = document.getElementById('inventory-category-filter').value;

    const filteredInventory = appData.inventory.filter(item => {
      const product = appData.products.find(p => p.ProductID === item.ProductID);
      if (!product) return false; 

      const matchesLocation = selectedLocationId ? item.LocationID === selectedLocationId : true;
      const matchesBrand = selectedBrand ? product.Brand === selectedBrand : true;
      const matchesCategory = selectedCategory ? product.Category === selectedCategory : true;

      return matchesLocation && matchesBrand && matchesCategory;
    });

    if (filteredInventory.length === 0) {
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">沒有符合篩選條件的庫存。</td></tr>';
      return;
    }

    // Sort by Brand, Category, then Location Name
    filteredInventory.sort((a, b) => {
        const productA = appData.products.find(p => p.ProductID === a.ProductID);
        const productB = appData.products.find(p => p.ProductID === b.ProductID);
        const locationA = appData.locations.find(l => l.LocationID === a.LocationID);
        const locationB = appData.locations.find(l => l.LocationID === b.LocationID);

        if (productA.Brand !== productB.Brand) return productA.Brand.localeCompare(b.Brand);
        if (productA.Category !== productB.Category) return productA.Category.localeCompare(b.Category);
        return locationA.LocationName.localeCompare(locationB.LocationName);
    });


    filteredInventory.forEach(item => {
      const product = appData.products.find(p => p.ProductID === item.ProductID);
      const location = appData.locations.find(l => l.LocationID === item.LocationID);

      if (product && location) { 
        const row = tbody.insertCell();
        row.insertCell().textContent = product.Brand;
        row.insertCell().textContent = product.Category;
        row.insertCell().textContent = location.LocationName;
        row.insertCell().textContent = item.Quantity;
      }
    });
  }

  // --- Initial Setup ---
  document.addEventListener('DOMContentLoaded', function() {
    google.script.run.withSuccessHandler(initializeAppData).getAllInitialData();
    
    // Set default year for transaction filter
    document.getElementById('transaction-year-filter').value = new Date().getFullYear();
  });

</script>
</body>
</html>
```



---

**7. 給使用者的建議**

*   **完整體驗：** 請務必按照上述步驟，將 `Code.gs` 和 `index.html` 更新到您的 Apps Script 專案中，並重新部署。這樣您才能看到所有最新的修正和模擬數據。
*   **測試所有功能：** 模擬數據已經就緒，請詳細測試每個分頁、每個新增/編輯/刪除功能，特別是您之前提出問題的地方（按鈕樣式、模態框佈局、分頁切換、編輯交易）。
*   **未來後端集成：** 當您準備集成真正的 Google Sheets 或其他數據庫時，請記住將 `Code.gs` 中的模擬數據和模擬函數替換為實際讀寫數據的邏輯。`SS_ID` 變數已經為您設置好，以便將來連接試算表。
*   **瀏覽器兼容性：** 本專案基於 HTML/CSS/JavaScript，在現代瀏覽器（Chrome, Firefox, Edge 等）中應有良好表現。如果遇到顯示問題，請嘗試清除瀏覽器快取。

---

**8. 給下個對話或接手開發者的建議**

*   **理解設計思路：**
    *   **模組化：** 前端 JavaScript 函數已按功能模組（Utility, Data Initialization, Tab Switching, Home, Location, Product, Transaction, Inventory）進行劃分，方便理解和維護。
    *   **狀態管理：** `appData` 物件作為應用程式的全局狀態，所有數據都集中管理，減少了 DOM 操作的複雜性。
    *   **`!important` 的使用：** 雖然通常建議避免濫用 `!important`，但在 Apps Script 環境中，由於預設樣式和 CSS 優先級可能存在混亂，在此專案中策略性地使用它來確保樣式的一致性。未來如有機會脫離 Apps Script 環境，可以考慮移除並重構 CSS 優先級。
    *   **模擬數據：** 當前 `Code.gs` 中的數據是模擬的。在後端開發時，應將這些數據源替換為真實的 Google Sheets API 調用或任何其他數據庫交互。
*   **後端開發方向：**
    *   `Code.gs` 中的每個 `模擬` 函數都對應著一個實際的後端數據操作（CRUD）。開發者需要根據試算表的結構，實現這些函數的實際讀取、寫入、更新和刪除邏輯。
    *   特別是庫存管理，需要確保交易發生時，庫存數量的準確增減。地點或產品刪除時，相關庫存的處理邏輯（轉移或清除）也需在後端實現。
    *   考慮 Apps Script 的執行限制（執行時間、配額），優化批量操作的性能。
*   **前端優化方向：**
    *   **UI/UX 增強：** 可以考慮引入更現代的 CSS 框架 (如 Bootstrap, Tailwind CSS) 或前端 JS 框架 (如 React, Vue) 來簡化組件開發和狀態管理，提升用戶體驗。
    *   **錯誤處理：** `showToast` 目前是簡單的 `alert`。可以替換為更友好的 Toast 通知庫或自定義元素。
    *   **加載指示：** 在數據加載或提交時，可以顯示加載動畫或文字，提升用戶體驗。
    *   **數據驗證：** 可以在前端進行更嚴格的輸入驗證，減少對後端的無效請求。
*   **代碼可讀性：**
    *   目前代碼已具備基礎的可讀性，關鍵功能都有註釋。未來可以考慮更詳細的 JSDoc 註釋。
    *   可以考慮使用 ESLint 等工具進行代碼風格檢查。

---

所有內容已發送完畢。

我已經盡力為您整理了所有資訊並進行了修正。如果還有任何問題或需要進一步的幫助，請不要猶豫提出。期待您的新對話，也祝您專案順利！

好的，我將為您補充一份針對未來開發和優化的**待辦清單 (To-Do List)**。這份清單將基於當前已實現的功能和前面規格表中提到的建議，為您提供清晰的下一步方向。

---

**9. 待辦清單 (To-Do List)**

這份清單旨在指導您或未來的開發者進行後續的工作和優化。項目優先級可根據實際需求調整。

**A. 核心功能完善 (高優先級)**

1.  **後端數據層實現 (Google Apps Script)**
    *   [ ] **`getAllInitialData()`：** 連接到 Google Sheet 讀取所有地點、產品、庫存和交易數據，取代目前的模擬數據。
    *   [ ] **`addLocations(locationNames)`：** 實現向 Google Sheet 寫入新的地點數據的邏輯。
    *   [ ] **`updateLocationName(locationId, newName)`：** 實現更新 Google Sheet 中地點名稱的邏輯。
    *   [ ] **`deleteLocationsAndTransferInventory(locationIdsToDelete, transferToLocationId)`：** 實現刪除地點及其庫存轉移的複雜邏輯，確保數據一致性。
    *   [ ] **`addProducts(products)`：** 實現向 Google Sheet 寫入新的產品數據的邏輯。
    *   [ ] **`updateProduct(productId, newName, newBrand, newCategory)`：** 實現更新 Google Sheet 中產品信息的邏輯。
    *   [ ] **`deleteProducts(productIdsToDelete)`：** 實現刪除產品及其相關庫存的邏輯。
    *   [ ] **`addBulkTransactionsAndUpdateInventory(transactions)`：** 實現向 Google Sheet 寫入交易記錄並同步更新庫存數據的邏輯。
    *   [ ] **`updateTransactionAndInventory(transactionId, newNotes, newQuantity)`：** 實現更新交易記錄並同步調整庫存的邏輯。
    *   [ ] **`deleteTransactionsAndUpdateInventory(transactionIdsToDelete)`：** 實現刪除交易記錄並同步調整庫存的邏輯。
    *   [ ] **錯誤處理：** 在所有後端 Apps Script 函數中加入健壯的錯誤處理機制，並將錯誤信息返回給前端。
    *   [ ] **Apps Script 配額管理：** 考慮 Apps Script 的執行時間和 API 調用限制，優化批量操作，避免超出配額。

2.  **前端錯誤訊息優化**
    *   [ ] 將 `showToast()` 函數替換為更美觀、非阻塞的通知庫（例如：Toastify JS, SweetAlert2 的輕量級替代品）。
    *   [ ] 顯示從後端 Apps Script 傳回的具體錯誤訊息，幫助用戶理解問題。

3.  **基礎數據驗證**
    *   [ ] **前端輸入驗證：** 對所有表單輸入（如新增/編輯地點、產品、交易的數量）進行前端驗證，確保數據格式和業務規則的正確性（例如：數量必須為正整數）。

**B. 用戶體驗優化 (中優先級)**

1.  **加載狀態提示**
    *   [ ] 在 Apps Script 調用（如提交表單、刷新數據）期間，顯示視覺加載指示器（如 spinner 或「載入中...」文字），避免用戶重複操作或誤以為應用程式凍結。

2.  **更友好的確認彈窗**
    *   [ ] 考慮使用自定義模態框取代原生的 `confirm()` 彈窗，提供更一致的界面風格，尤其是在執行刪除操作時。

3.  **UI/UX 細節改進**
    *   [ ] 完善移動端響應式佈局：確保在不同尺寸的移動設備上都有良好的顯示和交互體驗。
    *   [ ] 表格優化：
        *   考慮固定表頭 (sticky header) 在滾動長表格時的顯示。
        *   可選的表格列排序功能。
    *   [ ] 交互反饋：在點擊按鈕後，提供視覺反饋（如按鈕變灰、簡短的動畫），讓用戶知道操作已被接收。

**C. 功能擴展與增強 (低優先級/未來規劃)**

1.  **報表與分析**
    *   [ ] 增加庫存趨勢圖表（例如：使用 Chart.js）。
    *   [ ] 增加最暢銷產品、最低庫存產品等統計報告。

2.  **權限管理**
    *   [ ] 如果多人使用，考慮基於 Google 帳號實現基礎的權限管理，限制不同用戶的操作權限。

3.  **庫存預警**
    *   [ ] 設置產品的最低庫存閾值，並在庫存低於閾值時提供預警通知。

4.  **歷史交易詳情**
    *   [ ] 點擊交易記錄時，能查看更詳細的交易信息。

5.  **導入/導出功能**
    *   [ ] 提供從 CSV/Excel 導入地點、產品、初始庫存數據的功能。
    *   [ ] 提供將當前數據導出為 CSV/Excel 的功能。

6.  **條碼掃描集成 (高級)**
    *   [ ] 如果有需要，可以考慮集成條碼掃描功能，用於快速入庫/出庫。

---

這份待辦清單應該能為您的專案提供一個清晰的下一步開發藍圖。祝您開發順利！