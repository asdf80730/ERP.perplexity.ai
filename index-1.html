<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>簡易庫存管理系統</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Microsoft JhengHei',Arial,sans-serif;font-size:34px;line-height:1.6;color:#333;background-color:#f5f5f5;min-height:100vh}body{padding-top:80px}.container{max-width:100%;margin:0 auto;background-color:white;min-height:100vh;box-shadow:0 0 10px rgba(0,0,0,0.1)}@media (min-width:1024px){.container{max-width:1600px}}.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:8px 20px;text-align:center;position:fixed;top:0;left:0;right:0;z-index:1000;height:40px;display:flex;align-items:center;justify-content:center}.header h1{font-size:32px;font-weight:bold;margin:0}.nav-container{background-color:#4a5568;padding:8px 0;position:fixed;top:40px;left:0;right:0;z-index:999;height:40px}.nav-tabs{display:flex;justify-content:space-around;overflow-x:auto;padding:0 20px;height:100%;align-items:center}.tab-button{background:none;border:none;color:#a0aec0;padding:8px 16px;cursor:pointer;transition:all 0.3s ease;white-space:nowrap;font-size:24px;border-radius:4px;min-width:100px;height:32px;display:flex;align-items:center;justify-content:center}.tab-button.active{background-color:#667eea;color:white;font-weight:bold}.tab-button:hover{background-color:#5a67d8;color:white}.content{padding:15px 20px;min-height:calc(100vh - 80px)}.tab-content{display:none}.tab-content.active{display:block}.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;flex-wrap:wrap;gap:8px;min-height:50px}.page-title{font-size:36px;font-weight:bold;color:#2d3748;margin:0}.header-buttons{display:flex;gap:8px;flex-wrap:wrap}.btn{padding:12px 40px;border:none;border-radius:8px;cursor:pointer;font-size:32px;font-weight:600;transition:all 0.3s ease;display:inline-flex;align-items:center;justify-content:center;min-height:44px;white-space:nowrap}.btn:disabled{opacity:0.4;cursor:not-allowed;background-color:#a0aec0!important;color:#ffffff!important;transform:none!important}.btn-primary{background-color:#667eea;color:white}.btn-primary:hover:not(:disabled){background-color:#5a67d8;transform:translateY(-1px)}.btn-secondary{background-color:#718096;color:white}.btn-secondary:hover:not(:disabled){background-color:#4a5568}.btn-outbound{background-color:#8B4513;color:white}.btn-outbound:hover:not(:disabled){background-color:#654321}.btn-danger{background-color:#e53e3e;color:white}.btn-danger:hover:not(:disabled){background-color:#c53030}.btn-cancel-delete{background-color:#FF8C00;color:white}.btn-cancel-delete:hover:not(:disabled){background-color:#FF7F00}.btn-success{background-color:#38a169;color:white}.btn-success:hover:not(:disabled){background-color:#2f855a}.btn-small{padding:8px 24px;font-size:28px;min-height:36px}.quick-actions{display:flex;gap:15px;margin-bottom:25px}.quick-actions .btn{flex:1;font-size:36px;padding:16px;min-height:60px}.filters{background-color:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px}.filter-group{display:flex;gap:10px;align-items:center;margin-bottom:10px;flex-wrap:wrap}.filter-group:last-child{margin-bottom:0}.filter-group label{font-weight:600;min-width:120px;font-size:32px}.filter-input,.filter-select{flex:1;padding:10px;border:2px solid #e2e8f0;border-radius:6px;font-size:32px;background-color:white;min-height:44px}.filter-input:focus,.filter-select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.table-container{overflow-x:auto;background-color:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.1)}table{width:100%;border-collapse:collapse;font-size:30px}th{background-color:#f7fafc;color:#2d3748;font-weight:bold;padding:12px 16px;text-align:left;border-bottom:2px solid #e2e8f0;font-size:30px;position:sticky;top:0;z-index:10}td{padding:12px 16px;border-bottom:1px solid #e2e8f0;vertical-align:middle}tr:hover{background-color:#f8f9fa}.table-button{padding:6px 24px;font-size:28px;border:none;border-radius:4px;cursor:pointer;transition:all 0.2s ease;min-height:32px}.table-button:disabled{opacity:0.3;cursor:not-allowed;background-color:#cbd5e0!important;color:#718096!important}.edit-btn{background-color:#667eea;color:white}.edit-btn:hover:not(:disabled){background-color:#5a67d8}.save-btn{background-color:#38a169;color:white}.save-btn:hover{background-color:#2f855a}.edit-input{width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;font-size:28px}.checkbox-cell{text-align:center;width:240px}.action-cell{text-align:center;width:240px}.delete-checkbox{width:20px;height:20px;cursor:pointer}.recent-transactions{margin-top:30px}.transaction-list{background-color:white;border-radius:8px;overflow:hidden;box-shadow:0 2px 4px rgba(0,0,0,0.1)}.transaction-item{padding:12px 30px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;font-size:30px}.transaction-item:last-child{border-bottom:none}.transaction-info{display:flex;gap:30px;align-items:center;flex:1}.transaction-date{font-weight:600;color:#2d3748;min-width:160px}.transaction-product{font-weight:500;color:#4a5568;min-width:200px}.transaction-location{font-weight:500;color:#718096;min-width:160px}.transaction-quantity{font-weight:bold;font-size:32px;padding:4px 16px;border-radius:4px;min-width:120px;text-align:center}.quantity-in{color:#38a169;background-color:#f0fff4}.quantity-out{color:#e53e3e;background-color:#fff5f5}.modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,0.5);overflow-y:auto}.modal.active{display:flex;align-items:center;justify-content:center;padding:20px}.modal-content{background-color:white;margin:auto;padding:0;border-radius:12px;width:90%;max-width:1000px;max-height:90vh;overflow-y:auto;box-shadow:0 10px 25px rgba(0,0,0,0.2);animation:modalSlideIn 0.3s ease}@keyframes modalSlideIn{from{transform:translateY(-50px);opacity:0}to{transform:translateY(0);opacity:1}}.modal-header{padding:20px;border-bottom:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center;background-color:#f8f9fa;border-radius:12px 12px 0 0}.modal-title{font-size:40px;font-weight:bold;color:#2d3748;margin:0}.close{color:#718096;font-size:56px;font-weight:bold;cursor:pointer;border:none;background:none;padding:0;width:30px;height:30px;display:flex;align-items:center;justify-content:center}.close:hover{color:#2d3748}.modal-body{padding:15px 20px}.modal-footer{padding:15px 20px;border-top:1px solid #e2e8f0;display:flex;justify-content:center;gap:10px;background-color:#f8f9fa;border-radius:0 0 12px 12px}.form-group{margin-bottom:20px}.form-label{display:block;margin-bottom:8px;font-weight:600;color:#2d3748;font-size:32px}.form-control{width:100%;padding:12px;border:2px solid #e2e8f0;border-radius:6px;font-size:32px;transition:border-color 0.3s ease;min-height:48px}.form-control:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.form-row{display:flex;gap:10px;align-items:center;margin-bottom:15px;padding:15px;background-color:#f8f9fa;border-radius:8px;border:1px solid #e2e8f0}.form-row .form-control{margin-bottom:0}.form-row-single{display:block;margin-bottom:15px}.form-row-single .form-group{margin-bottom:15px}.form-row-horizontal{display:flex;align-items:center;margin-bottom:15px;gap:10px}.form-label-inline{font-weight:600;color:#2d3748;font-size:32px;min-width:120px;text-align:right}.form-control-inline{flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:6px;font-size:32px;transition:border-color 0.3s ease;min-height:48px}.form-control-inline:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.quantity-controls-inline{display:flex;align-items:center;gap:10px;flex:1}.quantity-controls-inline .quantity-input{width:160px;text-align:center;font-weight:bold}.quantity-controls-inline .btn-small{margin-left:10px;white-space:nowrap}.add-item-row{display:flex;align-items:center;margin-bottom:15px;gap:10px}.add-item-label{font-weight:600;color:#2d3748;font-size:32px;min-width:160px}.add-item-input{flex:1;padding:12px;border:2px solid #e2e8f0;border-radius:6px;font-size:32px;transition:border-color 0.3s ease;min-height:48px}.add-item-input:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}.add-item-btn{margin-left:auto}.button-row{display:flex;justify-content:space-between;align-items:center;gap:10px;margin-top:20px;flex-wrap:wrap}.button-row .btn{flex:1;min-width:200px}.quantity-controls{display:flex;align-items:center;gap:10px}.quantity-btn{width:40px;height:40px;border:2px solid #667eea;background-color:white;color:#667eea;border-radius:6px;cursor:pointer;font-size:36px;font-weight:bold;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease}.quantity-btn:hover{background-color:#667eea;color:white}.quantity-input{width:160px;text-align:center;font-weight:bold}.remove-btn{background-color:#e53e3e;color:white;border:none;border-radius:4px;padding:8px 24px;cursor:pointer;font-size:28px;min-height:36px}.remove-btn:hover{background-color:#c53030}.stock-display{background-color:#e6f3ff;border:2px solid #4299e1;border-radius:6px;padding:12px;margin-top:10px;text-align:center;font-weight:bold;color:#2c5282}.stock-display.low-stock{background-color:#fed7d7;border-color:#f56565;color:#c53030}.stock-display.no-stock{background-color:#feb2b2;border-color:#e53e3e;color:#9b2c2c}.batch-section{margin-top:20px;border-top:2px solid #e2e8f0;padding-top:20px}.batch-title-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}.batch-title{font-size:36px;font-weight:bold;color:#2d3748;margin:0}.batch-list{background-color:#f8f9fa;border-radius:8px;padding:15px;min-height:100px;border:2px dashed #cbd5e0}.batch-item{background-color:white;padding:12px;margin-bottom:10px;border-radius:6px;border:1px solid #e2e8f0;display:flex;justify-content:space-between;align-items:center}.batch-item:last-child{margin-bottom:0}.batch-empty{text-align:center;color:#718096;font-style:italic;padding:30px}.toast{position:fixed;top:100px;right:20px;padding:15px 20px;border-radius:8px;color:white;font-weight:600;z-index:2000;transform:translateX(400px);transition:transform 0.3s ease;max-width:600px;word-wrap:break-word;font-size:32px}.toast.show{transform:translateX(0)}.toast.success{background-color:#38a169}.toast.error{background-color:#e53e3e}.toast.info{background-color:#3182ce}.inventory-filters{background-color:#f8f9fa;padding:15px;border-radius:8px;margin-bottom:20px}.inventory-filters-row{display:flex;gap:30px;align-items:center;flex-wrap:wrap}.inventory-filter-item{display:flex;align-items:center;gap:8px}.inventory-filter-label{font-weight:600;color:#2d3748;font-size:32px;min-width:100px}.inventory-filter-select{padding:10px;border:2px solid #e2e8f0;border-radius:6px;font-size:32px;background-color:white;min-height:44px;min-width:300px}.inventory-filter-select:focus{outline:none;border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,0.1)}@media (max-width:480px){body{padding-top:80px}.header{padding:6px 10px;height:40px}.header h1{font-size:28px}.nav-container{height:40px}.content{padding:10px 15px}.page-header{flex-direction:column;align-items:stretch;gap:10px;min-height:40px}.header-buttons{justify-content:center}.quick-actions{flex-direction:column}.nav-tabs{padding:0 5px}.tab-button{padding:6px 8px;font-size:20px;min-width:80px;height:28px}.modal-content{width:95%;margin:10px}.form-row{flex-direction:column;align-items:stretch}.quantity-controls{justify-content:center}.table-container{font-size:28px}th,td{padding:8px 6px}.batch-title-row{flex-direction:column;align-items:stretch;gap:10px}.button-row{flex-direction:column}.button-row .btn{width:100%;margin-bottom:8px}.button-row .btn:last-child{margin-bottom:0}.form-row-horizontal{flex-direction:column;align-items:stretch;gap:5px}.form-label-inline{text-align:left;min-width:auto}.quantity-controls-inline{justify-content:center}.transaction-info{flex-direction:column;gap:5px;align-items:flex-start}.transaction-date,.transaction-product,.transaction-location{min-width:auto}.add-item-row{flex-direction:column;align-items:stretch;gap:5px}.add-item-label{min-width:auto}.add-item-btn{margin-left:0;align-self:center}.inventory-filters-row{flex-direction:column;gap:15px}.inventory-filter-item{flex-direction:column;align-items:stretch}.inventory-filter-label{text-align:left;min-width:auto}}.text-center{text-align:center}.text-danger{color:#e53e3e!important}.text-success{color:#38a169!important}.hidden{display:none!important}.loading{opacity:0.6;pointer-events:none}.mt-20{margin-top:20px}.mb-20{margin-bottom:20px}</style></head><body><div class="header"><h1>簡易庫存管理系統</h1></div><div class="nav-container"><div class="nav-tabs"><button class="tab-button active" onclick="switchTab('home')">首頁</button><button class="tab-button" onclick="switchTab('locations')">地點管理</button><button class="tab-button" onclick="switchTab('products')">產品管理</button><button class="tab-button" onclick="switchTab('transactions')">交易管理</button><button class="tab-button" onclick="switchTab('inventory')">庫存查詢</button></div></div><div class="container"><div id="content" class="content"><div id="home-tab" class="tab-content active"><div class="page-header"><h2 class="page-title">首頁</h2><div class="header-buttons"><button class="btn btn-primary" onclick="openTransactionModal('In')">入庫</button><button class="btn btn-outbound" onclick="openTransactionModal('Out')">出庫</button></div></div><div class="recent-transactions"><h3 style="margin-bottom:15px;color:#2d3748;font-size:36px">近七天交易記錄</h3><div id="recent-transactions-list" class="transaction-list"></div></div></div><div id="locations-tab" class="tab-content"><div class="page-header"><h2 class="page-title">地點管理</h2><div class="header-buttons"><button id="add-location-btn" class="btn btn-primary" onclick="openAddLocationModal()">新增地點</button><button id="delete-location-btn" class="btn btn-danger" onclick="toggleLocationDeleteMode()">刪除</button><button id="cancel-delete-location-btn" class="btn btn-cancel-delete hidden" onclick="toggleLocationDeleteMode()">取消刪除</button><button id="confirm-delete-location-btn" class="btn btn-danger hidden" onclick="confirmDeleteLocations()">確認刪除</button></div></div><div class="filters"><div class="filter-group"><label>搜尋:</label><input type="text" id="location-filter" class="filter-input" placeholder="輸入地點名稱..." oninput="filterLocations()"></div></div><div class="table-container"><table><thead><tr><th>地點名稱</th><th>地點數量</th><th id="location-action-header" class="action-cell">操作</th></tr></thead><tbody id="locations-table-body"></tbody></table></div></div><div id="products-tab" class="tab-content"><div class="page-header"><h2 class="page-title">產品管理</h2><div class="header-buttons"><button id="add-product-btn" class="btn btn-primary" onclick="openAddProductModal()">新增產品</button><button id="delete-product-btn" class="btn btn-danger" onclick="toggleProductDeleteMode()">刪除</button><button id="cancel-delete-product-btn" class="btn btn-cancel-delete hidden" onclick="toggleProductDeleteMode()">取消刪除</button><button id="confirm-delete-product-btn" class="btn btn-danger hidden" onclick="confirmDeleteProducts()">確認刪除</button></div></div><div class="filters"><div class="filter-group"><label>搜尋:</label><input type="text" id="product-filter" class="filter-input" placeholder="輸入產品名稱、品牌或類別..." oninput="filterProducts()"></div></div><div class="table-container"><table><thead><tr><th>類別</th><th>品牌</th><th>產品名稱</th><th id="product-action-header" class="action-cell">操作</th></tr></thead><tbody id="products-table-body"></tbody></table></div></div><div id="transactions-tab" class="tab-content"><div class="page-header"><h2 class="page-title">交易管理</h2><div class="header-buttons"><button class="btn btn-primary" onclick="openTransactionModal('In')">入庫</button><button class="btn btn-outbound" onclick="openTransactionModal('Out')">出庫</button><button id="delete-transaction-btn" class="btn btn-danger" onclick="toggleTransactionDeleteMode()">刪除</button><button id="cancel-delete-transaction-btn" class="btn btn-cancel-delete hidden" onclick="toggleTransactionDeleteMode()">取消刪除</button><button id="confirm-delete-transaction-btn" class="btn btn-danger hidden" onclick="confirmDeleteTransactions()">確認刪除</button></div></div><div class="filters"><div class="filter-group"><label>搜尋:</label><input type="text" id="transaction-filter" class="filter-input" placeholder="搜尋交易記錄..." oninput="filterTransactions()"></div><div class="filter-group"><label>年份:</label><input type="number" id="transaction-year" class="filter-input" style="width:100px" value="2023" min="2020" max="2030" onchange="filterTransactions()"><span style="margin:0 5px">年</span><select id="transaction-month" class="filter-select" style="width:120px" onchange="filterTransactions()"><option value="">全部月份</option><option value="1">1月</option><option value="2">2月</option><option value="3">3月</option><option value="4">4月</option><option value="5">5月</option><option value="6">6月</option><option value="7">7月</option><option value="8">8月</option><option value="9">9月</option><option value="10">10月</option><option value="11">11月</option><option value="12">12月</option></select></div></div><div class="table-container"><table><thead><tr><th>日期</th><th>產品名稱</th><th>地點名稱</th><th>數量</th><th>備註</th><th id="transaction-action-header" class="action-cell">操作</th></tr></thead><tbody id="transactions-table-body"></tbody></table></div></div><div id="inventory-tab" class="tab-content"><div class="page-header"><h2 class="page-title">庫存查詢</h2></div><div class="inventory-filters"><div class="inventory-filters-row"><div class="inventory-filter-item"><label class="inventory-filter-label">地點:</label><select id="inventory-location-filter" class="inventory-filter-select" onchange="performInventoryQuery()"><option value="">所有地點</option></select></div><div class="inventory-filter-item"><label class="inventory-filter-label">品牌:</label><select id="inventory-brand-filter" class="inventory-filter-select" onchange="performInventoryQuery()"><option value="">所有品牌</option></select></div><div class="inventory-filter-item"><label class="inventory-filter-label">類別:</label><select id="inventory-category-filter" class="inventory-filter-select" onchange="performInventoryQuery()"><option value="">所有類別</option></select></div></div></div><div class="table-container"><table><thead><tr><th>品牌</th><th>產品類別</th><th>產品名稱</th><th>地點名稱</th><th>數量</th></tr></thead><tbody id="inventory-table-body"></tbody></table></div></div></div><div id="add-location-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">新增地點</h3><button class="close" onclick="closeModal('add-location-modal')">&times;</button></div><div class="modal-body"><div class="add-item-row"><label class="add-item-label">地點名稱:</label><input type="text" id="new-location-name" class="add-item-input" placeholder="輸入地點名稱"><button class="btn btn-primary add-item-btn" onclick="addLocationToBatch()">加入地點</button></div><div class="batch-section"><div class="batch-title-row"><h3 class="batch-title">待新增地點列表</h3><button class="btn btn-success" onclick="submitAddLocations()">確認新增</button></div><div id="location-batch-list" class="batch-list"><div class="batch-empty">尚未新增任何地點</div></div></div></div></div></div><div id="add-product-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">新增產品</h3><button class="close" onclick="closeModal('add-product-modal')">&times;</button></div><div class="modal-body"><div class="add-item-row"><label class="add-item-label">產品名稱:</label><input type="text" id="new-product-name" class="add-item-input" placeholder="輸入產品名稱"></div><div class="add-item-row"><label class="add-item-label">品牌:</label><input type="text" id="new-product-brand" class="add-item-input" placeholder="輸入品牌"></div><div class="add-item-row"><label class="add-item-label">類別:</label><input type="text" id="new-product-category" class="add-item-input" placeholder="輸入類別"><button class="btn btn-primary add-item-btn" onclick="addProductToBatch()">加入產品</button></div><div class="batch-section"><div class="batch-title-row"><h3 class="batch-title">待新增產品列表</h3><button class="btn btn-success" onclick="submitAddProducts()">確認新增</button></div><div id="product-batch-list" class="batch-list"><div class="batch-empty">尚未新增任何產品</div></div></div></div></div></div><div id="transaction-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 id="transaction-modal-title" class="modal-title">交易</h3><button class="close" onclick="closeModal('transaction-modal')">&times;</button></div><div class="modal-body"><div class="form-row-horizontal"><label class="form-label-inline">品牌:</label><select id="transaction-brand-filter" class="form-control-inline" onchange="filterTransactionProducts()"><option value="">所有品牌</option></select></div><div class="form-row-horizontal"><label class="form-label-inline">類別:</label><select id="transaction-category-filter" class="form-control-inline" onchange="filterTransactionProducts()"><option value="">所有類別</option></select></div><div class="form-row-horizontal"><label class="form-label-inline">產品:</label><select id="transaction-product" class="form-control-inline" onchange="updateStockDisplay()"><option value="">選擇產品</option></select></div><div class="form-row-horizontal"><label class="form-label-inline">地點:</label><select id="transaction-location" class="form-control-inline" onchange="updateStockDisplay()"><option value="">選擇地點</option></select></div><div class="form-row-horizontal"><label class="form-label-inline">數量:</label><div class="quantity-controls-inline"><button type="button" class="quantity-btn" onclick="updateQuantityInput(-1)">-</button><input type="number" id="transaction-quantity" class="form-control quantity-input" value="1" min="1"><button type="button" class="quantity-btn" onclick="updateQuantityInput(1)">+</button><button class="btn btn-primary btn-small" onclick="addTransactionRow()">新增</button></div></div><div class="form-row-horizontal"><label class="form-label-inline">備註:</label><input type="text" id="transaction-notes" class="form-control-inline" placeholder="選填"></div><div id="stock-display" class="stock-display" style="display:none">當前庫存: <span id="current-stock-amount">0</span></div><div class="batch-section"><div class="batch-title-row"><h3 class="batch-title">待處理交易列表</h3><button class="btn btn-success" onclick="submitBulkTransactions()">確認提交</button></div><div id="transaction-batch-list" class="batch-list"><div class="batch-empty">尚未新增任何交易</div></div></div><div id="stock-warning" class="text-danger" style="margin-top:10px;display:none"></div></div></div></div><div id="location-delete-modal" class="modal"><div class="modal-content"><div class="modal-header"><h3 class="modal-title">確認刪除地點</h3><button class="close" onclick="closeModal('location-delete-modal')">&times;</button></div><div class="modal-body"><p style="font-size:32px">您確定要刪除選中的地點嗎？</p><div class="form-group"><label class="form-label">庫存轉移到:</label><select id="transfer-location" class="form-control"><option value="">不轉移（直接刪除庫存）</option></select></div></div><div class="modal-footer"><button class="btn btn-secondary" onclick="closeModal('location-delete-modal')">取消</button><button class="btn btn-danger" onclick="executeLocationDelete()">確認刪除</button></div></div></div></div><script>let appData={locations:[],products:[],inventory:[],transactions:[]};let currentEditingTransactionId=null;let transactionBatch=[];let locationBatch=[];let productBatch=[];let isLocationDeleteMode=false;let isProductDeleteMode=false;let isTransactionDeleteMode=false;function initializeApp(){console.log('開始初始化應用程式...');showToast('載入中...','info');document.getElementById('transaction-year').value=new Date().getFullYear();google.script.run.withSuccessHandler(function(data){console.log('成功接收資料:',data);initializeAppData(data);showToast('載入完成','success');}).withFailureHandler(function(error){console.error('載入失敗:',error);showToast('載入失敗: '+error.message,'error');document.getElementById('content').innerHTML=`<div style="padding:20px;text-align:center"><h3 style="color:red;font-size:48px">載入失敗</h3><p style="font-size:32px">錯誤訊息：${error.message}</p><button onclick="initializeApp()" style="margin-top:10px;padding:10px 20px;font-size:32px">重新載入</button></div>`;}).getAllInitialData();}function initializeAppData(data){console.log('接收到的原始資料:',data);if(!data||typeof data!=='object'){console.error('資料格式錯誤:',data);showToast('資料格式錯誤','error');return;}appData={locations:Array.isArray(data.locations)?data.locations:[],products:Array.isArray(data.products)?data.products:[],inventory:Array.isArray(data.inventory)?data.inventory:[],transactions:Array.isArray(data.transactions)?data.transactions:[]};console.log('處理後的資料:',appData);populateSelects();showHomePage();}function switchTab(tabName){if(isLocationDeleteMode)toggleLocationDeleteMode();if(isProductDeleteMode)toggleProductDeleteMode();if(isTransactionDeleteMode)toggleTransactionDeleteMode();appData.locations.forEach(location=>location.isEditing=false);appData.products.forEach(product=>product.isEditing=false);const tabs=document.querySelectorAll('.tab-content');tabs.forEach(tab=>tab.classList.remove('active'));const buttons=document.querySelectorAll('.tab-button');buttons.forEach(btn=>btn.classList.remove('active'));document.getElementById(tabName+'-tab').classList.add('active');event.target.classList.add('active');switch(tabName){case 'home':showHomePage();break;case 'locations':showLocationPage();break;case 'products':showProductPage();break;case 'transactions':showTransactionPage();break;case 'inventory':showInventoryPage();break;}}function showHomePage(){renderRecentTransactions();}function parseChineseDate(chineseDateStr){try{const regex=/(\d{4})\/(\d{1,2})\/(\d{1,2})\s*(上午|下午)(\d{1,2}):(\d{1,2}):(\d{1,2})/;const match=chineseDateStr.match(regex);if(match){const[_,year,month,day,period,hour,minute,second]=match;let hour24=parseInt(hour);if(period==='下午'&&hour24!==12){hour24+=12;}else if(period==='上午'&&hour24===12){hour24=0;}const date=new Date(parseInt(year),parseInt(month)-1,parseInt(day),hour24,parseInt(minute),parseInt(second));return date;}else{return new Date();}}catch(error){return new Date();}}function renderRecentTransactions(){const container=document.getElementById('recent-transactions-list');const now=new Date();const sevenDaysAgo=new Date(now.getTime()-7*24*60*60*1000);const recentTransactions=appData.transactions.filter(transaction=>{const transactionDate=parseChineseDate(transaction.Timestamp);return transactionDate>=sevenDaysAgo;});recentTransactions.sort((a,b)=>{const dateA=parseChineseDate(a.Timestamp);const dateB=parseChineseDate(b.Timestamp);return dateB.getTime()-dateA.getTime();});if(recentTransactions.length===0){container.innerHTML='<div class="text-center" style="padding:30px;color:#718096;font-size:32px">近七天內無交易記錄</div>';return;}let html='';recentTransactions.forEach(transaction=>{const product=appData.products.find(p=>p.ProductID===transaction.ProductID);const location=appData.locations.find(l=>l.LocationID===transaction.LocationID);const productName=product?product.ProductName:'未知產品';const locationName=location?location.LocationName:'未知地點';const displayDate=parseChineseDate(transaction.Timestamp).toLocaleDateString('zh-TW');const isInbound=transaction.Type==='In';const quantityClass=isInbound?'quantity-in':'quantity-out';const quantityText=isInbound?`+${transaction.Quantity}`:`-${transaction.Quantity}`;html+=`<div class="transaction-item"><div class="transaction-info"><div class="transaction-date">${displayDate}</div><div class="transaction-product">${productName}</div><div class="transaction-location">${locationName}</div></div><div class="transaction-quantity ${quantityClass}">${quantityText}</div></div>`;});container.innerHTML=html;}function showLocationPage(){renderLocationsTable();}function editLocation(locationId){appData.locations.forEach(location=>{location.isEditing=false;});const location=appData.locations.find(l=>l.LocationID===locationId);if(location){location.isEditing=true;}renderLocationsTable();}function saveLocation(locationId){const input=document.getElementById(`edit-location-${locationId}`);const newName=input.value.trim();if(!newName){showToast('地點名稱不能為空','error');return;}const duplicate=appData.locations.find(l=>l.LocationName===newName&&l.LocationID!==locationId);if(duplicate){showToast('地點名稱已存在','error');return;}showToast('正在儲存...','info');google.script.run.withSuccessHandler(function(){appData.locations.forEach(location=>{location.isEditing=false;});showToast('地點更新成功','success');refreshData();}).withFailureHandler(function(error){showToast('更新失敗: '+error.message,'error');}).updateLocationName(locationId,newName);}function renderLocationsTable(){const tbody=document.getElementById('locations-table-body');const filter=document.getElementById('location-filter').value.toLowerCase();const filteredLocations=appData.locations.filter(location=>location.LocationName.toLowerCase().includes(filter));if(filteredLocations.length===0){tbody.innerHTML='<tr><td colspan="3" class="text-center">無符合條件的地點</td></tr>';return;}const hasEditingRow=appData.locations.some(l=>l.isEditing);let html='';filteredLocations.forEach(location=>{const isEditing=location.isEditing;const isDeleteMode=isLocationDeleteMode;html+=`<tr>`;if(isEditing){html+=`<td><input type="text" class="edit-input" value="${location.LocationName}" id="edit-location-${location.LocationID}"></td>`;}else{html+=`<td>${location.LocationName}</td>`;}html+=`<td>${location.Count||0}</td>`;if(isDeleteMode){html+=`<td class="checkbox-cell"><input type="checkbox" class="delete-checkbox" value="${location.LocationID}"></td>`;}else if(isEditing){html+=`<td class="action-cell"><button class="table-button save-btn" onclick="saveLocation('${location.LocationID}')">儲存</button></td>`;}else{const buttonDisabled=hasEditingRow?'disabled':'';html+=`<td class="action-cell"><button class="table-button edit-btn" onclick="editLocation('${location.LocationID}')" ${buttonDisabled}>編輯</button></td>`;}html+=`</tr>`;});tbody.innerHTML=html;}function filterLocations(){renderLocationsTable();}function toggleLocationDeleteMode(){isLocationDeleteMode=!isLocationDeleteMode;const deleteBtn=document.getElementById('delete-location-btn');const cancelBtn=document.getElementById('cancel-delete-location-btn');const confirmBtn=document.getElementById('confirm-delete-location-btn');const headerElement=document.getElementById('location-action-header');if(isLocationDeleteMode){appData.locations.forEach(location=>location.isEditing=false);deleteBtn.classList.add('hidden');cancelBtn.classList.remove('hidden');confirmBtn.classList.remove('hidden');headerElement.textContent='刪除';}else{deleteBtn.classList.remove('hidden');cancelBtn.classList.add('hidden');confirmBtn.classList.add('hidden');headerElement.textContent='操作';}renderLocationsTable();}function confirmDeleteLocations(){const checkboxes=document.querySelectorAll('#locations-table-body input.delete-checkbox:checked');const selectedIds=Array.from(checkboxes).map(cb=>cb.value);if(selectedIds.length===0){showToast('請選擇要刪除的地點','error');return;}const transferSelect=document.getElementById('transfer-location');transferSelect.innerHTML='<option value="">不轉移（直接刪除庫存）</option>';appData.locations.forEach(location=>{if(!selectedIds.includes(location.LocationID)){transferSelect.innerHTML+=`<option value="${location.LocationID}">${location.LocationName}</option>`;}});document.getElementById('location-delete-modal').classList.add('active');}function executeLocationDelete(){const checkboxes=document.querySelectorAll('#locations-table-body input.delete-checkbox:checked');const selectedIds=Array.from(checkboxes).map(cb=>cb.value);const transferToLocationId=document.getElementById('transfer-location').value;closeModal('location-delete-modal');showToast('正在刪除地點...','info');google.script.run.withSuccessHandler(function(){showToast('地點刪除成功','success');toggleLocationDeleteMode();refreshData();}).withFailureHandler(function(error){showToast('刪除失敗: '+error.message,'error');}).deleteLocationsAndTransferInventory(selectedIds,transferToLocationId);}function showProductPage(){renderProductsTable();}function editProduct(productId){appData.products.forEach(product=>{product.isEditing=false;});const product=appData.products.find(p=>p.ProductID===productId);if(product){product.isEditing=true;}renderProductsTable();}function saveProduct(productId){const nameInput=document.getElementById(`edit-name-${productId}`);const brandInput=document.getElementById(`edit-brand-${productId}`);const categoryInput=document.getElementById(`edit-category-${productId}`);const newName=nameInput.value.trim();const newBrand=brandInput.value.trim();const newCategory=categoryInput.value.trim();if(!newName||!newBrand||!newCategory){showToast('所有欄位都不能為空','error');return;}showToast('正在儲存...','info');google.script.run.withSuccessHandler(function(){appData.products.forEach(product=>{product.isEditing=false;});showToast('產品更新成功','success');refreshData();}).withFailureHandler(function(error){showToast('更新失敗: '+error.message,'error');}).updateProduct(productId,newName,newBrand,newCategory);}function renderProductsTable(){const tbody=document.getElementById('products-table-body');const filter=document.getElementById('product-filter').value.toLowerCase();const filteredProducts=appData.products.filter(product=>product.ProductName.toLowerCase().includes(filter)||product.Brand.toLowerCase().includes(filter)||product.Category.toLowerCase().includes(filter));if(filteredProducts.length===0){tbody.innerHTML='<tr><td colspan="4" class="text-center">無符合條件的產品</td></tr>';return;}const hasEditingRow=appData.products.some(p=>p.isEditing);let html='';filteredProducts.forEach(product=>{const isEditing=product.isEditing;const isDeleteMode=isProductDeleteMode;html+=`<tr>`;if(isEditing){html+=`<td><input type="text" class="edit-input" value="${product.Category}" id="edit-category-${product.ProductID}"></td>`;}else{html+=`<td>${product.Category}</td>`;}if(isEditing){html+=`<td><input type="text" class="edit-input" value="${product.Brand}" id="edit-brand-${product.ProductID}"></td>`;}else{html+=`<td>${product.Brand}</td>`;}if(isEditing){html+=`<td><input type="text" class="edit-input" value="${product.ProductName}" id="edit-name-${product.ProductID}"></td>`;}else{html+=`<td>${product.ProductName}</td>`;}if(isDeleteMode){html+=`<td class="checkbox-cell"><input type="checkbox" class="delete-checkbox" value="${product.ProductID}"></td>`;}else if(isEditing){html+=`<td class="action-cell"><button class="table-button save-btn" onclick="saveProduct('${product.ProductID}')">儲存</button></td>`;}else{const buttonDisabled=hasEditingRow?'disabled':'';html+=`<td class="action-cell"><button class="table-button edit-btn" onclick="editProduct('${product.ProductID}')" ${buttonDisabled}>編輯</button></td>`;}html+=`</tr>`;});tbody.innerHTML=html;}function filterProducts(){renderProductsTable();}function toggleProductDeleteMode(){isProductDeleteMode=!isProductDeleteMode;const deleteBtn=document.getElementById('delete-product-btn');const cancelBtn=document.getElementById('cancel-delete-product-btn');const confirmBtn=document.getElementById('confirm-delete-product-btn');const headerElement=document.getElementById('product-action-header');if(isProductDeleteMode){appData.products.forEach(product=>product.isEditing=false);deleteBtn.classList.add('hidden');cancelBtn.classList.remove('hidden');confirmBtn.classList.remove('hidden');headerElement.textContent='刪除';}else{deleteBtn.classList.remove('hidden');cancelBtn.classList.add('hidden');confirmBtn.classList.add('hidden');headerElement.textContent='操作';}renderProductsTable();}function confirmDeleteProducts(){const checkboxes=document.querySelectorAll('#products-table-body input.delete-checkbox:checked');const selectedIds=Array.from(checkboxes).map(cb=>cb.value);if(selectedIds.length===0){showToast('請選擇要刪除的產品','error');return;}if(confirm(`確定要刪除 ${selectedIds.length} 個產品嗎？這將同時刪除相關的庫存記錄。`)){showToast('正在刪除產品...','info');google.script.run.withSuccessHandler(function(){showToast('產品刪除成功','success');toggleProductDeleteMode();refreshData();}).withFailureHandler(function(error){showToast('刪除失敗: '+error.message,'error');}).deleteProducts(selectedIds);}}function showTransactionPage(){renderTransactionsTable();}function renderTransactionsTable(){const tbody=document.getElementById('transactions-table-body');const filter=document.getElementById('transaction-filter').value.toLowerCase();const year=document.getElementById('transaction-year').value;const month=document.getElementById('transaction-month').value;let filteredTransactions=appData.transactions.filter(transaction=>{const product=appData.products.find(p=>p.ProductID===transaction.ProductID);const location=appData.locations.find(l=>l.LocationID===transaction.LocationID);const productName=product?product.ProductName:'';const locationName=location?location.LocationName:'';const textMatch=productName.toLowerCase().includes(filter)||locationName.toLowerCase().includes(filter)||transaction.Notes.toLowerCase().includes(filter);const transactionDate=parseChineseDate(transaction.Timestamp);const yearMatch=!year||transactionDate.getFullYear().toString()===year;const monthMatch=!month||(transactionDate.getMonth()+1).toString()===month;return textMatch&&yearMatch&&monthMatch;});filteredTransactions.sort((a,b)=>{const dateA=parseChineseDate(a.Timestamp);const dateB=parseChineseDate(b.Timestamp);return dateB.getTime()-dateA.getTime();});if(filteredTransactions.length===0){tbody.innerHTML='<tr><td colspan="6" class="text-center">無符合條件的交易記錄</td></tr>';return;}let html='';filteredTransactions.forEach(transaction=>{const product=appData.products.find(p=>p.ProductID===transaction.ProductID);const location=appData.locations.find(l=>l.LocationID===transaction.LocationID);const productName=product?product.ProductName:'未知產品';const locationName=location?location.LocationName:'未知地點';const displayDate=parseChineseDate(transaction.Timestamp).toLocaleDateString('zh-TW');const isInbound=transaction.Type==='In';const quantityClass=isInbound?'quantity-in':'quantity-out';const quantityText=isInbound?`+${transaction.Quantity}`:`-${transaction.Quantity}`;html+=`<tr>`;html+=`<td>${displayDate}</td>`;html+=`<td>${productName}</td>`;html+=`<td>${locationName}</td>`;html+=`<td><span class="${quantityClass}">${quantityText}</span></td>`;html+=`<td>${transaction.Notes||''}</td>`;if(isTransactionDeleteMode){html+=`<td class="checkbox-cell"><input type="checkbox" class="delete-checkbox" value="${transaction.TransactionID}"></td>`;}else{html+=`<td class="action-cell"><button class="table-button edit-btn" disabled>編輯</button></td>`;}html+=`</tr>`;});tbody.innerHTML=html;}function filterTransactions(){renderTransactionsTable();}function toggleTransactionDeleteMode(){isTransactionDeleteMode=!isTransactionDeleteMode;const deleteBtn=document.getElementById('delete-transaction-btn');const cancelBtn=document.getElementById('cancel-delete-transaction-btn');const confirmBtn=document.getElementById('confirm-delete-transaction-btn');const headerElement=document.getElementById('transaction-action-header');if(isTransactionDeleteMode){deleteBtn.classList.add('hidden');cancelBtn.classList.remove('hidden');confirmBtn.classList.remove('hidden');headerElement.textContent='刪除';}else{deleteBtn.classList.remove('hidden');cancelBtn.classList.add('hidden');confirmBtn.classList.add('hidden');headerElement.textContent='操作';}renderTransactionsTable();}function confirmDeleteTransactions(){const checkboxes=document.querySelectorAll('#transactions-table-body input.delete-checkbox:checked');const selectedIds=Array.from(checkboxes).map(cb=>cb.value);if(selectedIds.length===0){showToast('請選擇要刪除的交易記錄','error');return;}if(confirm(`確定要刪除 ${selectedIds.length} 筆交易記錄嗎？這將同時調整相關的庫存。`)){showToast('正在刪除交易記錄...','info');google.script.run.withSuccessHandler(function(){showToast('交易記錄刪除成功','success');toggleTransactionDeleteMode();refreshData();}).withFailureHandler(function(error){showToast('刪除失敗: '+error.message,'error');}).deleteTransactionsAndUpdateInventory(selectedIds);}}function showInventoryPage(){performInventoryQuery();}function performInventoryQuery(){const locationFilter=document.getElementById('inventory-location-filter').value;const brandFilter=document.getElementById('inventory-brand-filter').value;const categoryFilter=document.getElementById('inventory-category-filter').value;const tbody=document.getElementById('inventory-table-body');let filteredInventory=appData.inventory.filter(item=>{const product=appData.products.find(p=>p.ProductID===item.ProductID);const location=appData.locations.find(l=>l.LocationID===item.LocationID);if(!product||!location)return false;const locationMatch=!locationFilter||item.LocationID===locationFilter;const brandMatch=!brandFilter||product.Brand===brandFilter;const categoryMatch=!categoryFilter||product.Category===categoryFilter;return locationMatch&&brandMatch&&categoryMatch;});if(filteredInventory.length===0){tbody.innerHTML='<tr><td colspan="5" class="text-center">無符合條件的庫存記錄</td></tr>';return;}let html='';filteredInventory.forEach(item=>{const product=appData.products.find(p=>p.ProductID===item.ProductID);const location=appData.locations.find(l=>l.LocationID===item.LocationID);html+=`<tr>`;html+=`<td>${product.Brand}</td>`;html+=`<td>${product.Category}</td>`;html+=`<td>${product.ProductName}</td>`;html+=`<td>${location.LocationName}</td>`;html+=`<td>${item.Quantity}</td>`;html+=`</tr>`;});tbody.innerHTML=html;}function openAddLocationModal(){locationBatch=[];renderLocationBatch();document.getElementById('new-location-name').value='';document.getElementById('add-location-modal').classList.add('active');}function openAddProductModal(){productBatch=[];renderProductBatch();document.getElementById('new-product-name').value='';document.getElementById('new-product-brand').value='';document.getElementById('new-product-category').value='';document.getElementById('add-product-modal').classList.add('active');}function openTransactionModal(type){document.getElementById('transaction-modal-title').textContent=type==='In'?'入庫':'出庫';transactionBatch=[];renderTransactionBatch();document.getElementById('transaction-product').value='';document.getElementById('transaction-location').value='';document.getElementById('transaction-quantity').value='1';document.getElementById('transaction-notes').value='';document.getElementById('transaction-brand-filter').value='';document.getElementById('transaction-category-filter').value='';document.getElementById('stock-display').style.display='none';document.getElementById('transaction-modal').setAttribute('data-type',type);populateTransactionSelects();populateTransactionFilters();document.getElementById('transaction-modal').classList.add('active');}function closeModal(modalId){document.getElementById(modalId).classList.remove('active');}function populateTransactionFilters(){const brandFilter=document.getElementById('transaction-brand-filter');const categoryFilter=document.getElementById('transaction-category-filter');const brands=[...new Set(appData.products.map(p=>p.Brand))];brandFilter.innerHTML='<option value="">所有品牌</option>';brands.forEach(brand=>{brandFilter.innerHTML+=`<option value="${brand}">${brand}</option>`;});const categories=[...new Set(appData.products.map(p=>p.Category))];categoryFilter.innerHTML='<option value="">所有類別</option>';categories.forEach(category=>{categoryFilter.innerHTML+=`<option value="${category}">${category}</option>`;});}function filterTransactionProducts(){const brandFilter=document.getElementById('transaction-brand-filter').value;const categoryFilter=document.getElementById('transaction-category-filter').value;const productSelect=document.getElementById('transaction-product');const filteredProducts=appData.products.filter(product=>{const brandMatch=!brandFilter||product.Brand===brandFilter;const categoryMatch=!categoryFilter||product.Category===categoryFilter;return brandMatch&&categoryMatch;});productSelect.innerHTML='<option value="">選擇產品</option>';filteredProducts.forEach(product=>{productSelect.innerHTML+=`<option value="${product.ProductID}">${product.ProductName} (${product.Brand})</option>`;});document.getElementById('stock-display').style.display='none';}function updateStockDisplay(){const productId=document.getElementById('transaction-product').value;const locationId=document.getElementById('transaction-location').value;const stockDisplay=document.getElementById('stock-display');const stockAmount=document.getElementById('current-stock-amount');if(productId&&locationId){const currentStock=getCurrentStock(productId,locationId);stockAmount.textContent=currentStock;stockDisplay.className='stock-display';if(currentStock===0){stockDisplay.classList.add('no-stock');}else if(currentStock<=5){stockDisplay.classList.add('low-stock');}stockDisplay.style.display='block';}else{stockDisplay.style.display='none';}}function addLocationToBatch(){const name=document.getElementById('new-location-name').value.trim();if(!name){showToast('地點名稱不能為空','error');return;}const exists=locationBatch.includes(name)||appData.locations.some(l=>l.LocationName===name);if(exists){showToast('地點名稱已存在','error');return;}locationBatch.push(name);renderLocationBatch();document.getElementById('new-location-name').value='';}function addProductToBatch(){const name=document.getElementById('new-product-name').value.trim();const brand=document.getElementById('new-product-brand').value.trim();const category=document.getElementById('new-product-category').value.trim();if(!name||!brand||!category){showToast('所有欄位都不能為空','error');return;}const product={ProductName:name,Brand:brand,Category:category};const key=`${name}-${brand}-${category}`;const existsInBatch=productBatch.some(p=>`${p.ProductName}-${p.Brand}-${p.Category}`===key);const existsInData=appData.products.some(p=>`${p.ProductName}-${p.Brand}-${p.Category}`===key);if(existsInBatch||existsInData){showToast('產品已存在','error');return;}productBatch.push(product);renderProductBatch();document.getElementById('new-product-name').value='';document.getElementById('new-product-brand').value='';document.getElementById('new-product-category').value='';}function addTransactionRow(){const productId=document.getElementById('transaction-product').value;const locationId=document.getElementById('transaction-location').value;const quantity=parseInt(document.getElementById('transaction-quantity').value);const notes=document.getElementById('transaction-notes').value.trim();const type=document.getElementById('transaction-modal').getAttribute('data-type');if(!productId||!locationId||!quantity||quantity<=0){showToast('請填寫完整資訊','error');return;}if(type==='Out'){const currentStock=getCurrentStock(productId,locationId);const pendingOut=transactionBatch.filter(t=>t.Type==='Out'&&t.ProductID===productId&&t.LocationID===locationId).reduce((sum,t)=>sum+t.Quantity,0);if(currentStock<pendingOut+quantity){showToast(`庫存不足！當前庫存: ${currentStock}，已安排出庫: ${pendingOut}`,'error');return;}}const transaction={Type:type,ProductID:productId,LocationID:locationId,Quantity:quantity,Notes:notes};transactionBatch.push(transaction);renderTransactionBatch();document.getElementById('transaction-quantity').value='1';document.getElementById('transaction-notes').value='';}function renderLocationBatch(){const container=document.getElementById('location-batch-list');if(locationBatch.length===0){container.innerHTML='<div class="batch-empty">尚未新增任何地點</div>';return;}let html='';locationBatch.forEach((name,index)=>{html+=`<div class="batch-item"><span>${name}</span><button class="remove-btn" onclick="removeLocationFromBatch(${index})">移除</button></div>`;});container.innerHTML=html;}function renderProductBatch(){const container=document.getElementById('product-batch-list');if(productBatch.length===0){container.innerHTML='<div class="batch-empty">尚未新增任何產品</div>';return;}let html='';productBatch.forEach((product,index)=>{html+=`<div class="batch-item"><span>${product.ProductName} (${product.Brand} - ${product.Category})</span><button class="remove-btn" onclick="removeProductFromBatch(${index})">移除</button></div>`;});container.innerHTML=html;}function renderTransactionBatch(){const container=document.getElementById('transaction-batch-list');if(transactionBatch.length===0){container.innerHTML='<div class="batch-empty">尚未新增任何交易</div>';return;}let html='';transactionBatch.forEach((transaction,index)=>{const product=appData.products.find(p=>p.ProductID===transaction.ProductID);const location=appData.locations.find(l=>l.LocationID===transaction.LocationID);const typeText=transaction.Type==='In'?'入庫':'出庫';html+=`<div class="batch-item"><div><strong>${typeText}</strong> ${product.ProductName} 至 ${location.LocationName} × ${transaction.Quantity} ${transaction.Notes?`(${transaction.Notes})`:''}</div><button class="remove-btn" onclick="removeTransactionFromBatch(${index})">移除</button></div>`;});container.innerHTML=html;}function removeLocationFromBatch(index){locationBatch.splice(index,1);renderLocationBatch();}function removeProductFromBatch(index){productBatch.splice(index,1);renderProductBatch();}function removeTransactionFromBatch(index){transactionBatch.splice(index,1);renderTransactionBatch();}function submitAddLocations(){if(locationBatch.length===0){showToast('請先新增地點','error');return;}closeModal('add-location-modal');showToast('正在新增地點...','info');google.script.run.withSuccessHandler(function(){showToast('地點新增成功','success');refreshData();}).withFailureHandler(function(error){showToast('新增失敗: '+error.message,'error');}).addLocations(locationBatch);}function submitAddProducts(){if(productBatch.length===0){showToast('請先新增產品','error');return;}closeModal('add-product-modal');showToast('正在新增產品...','info');google.script.run.withSuccessHandler(function(){showToast('產品新增成功','success');refreshData();}).withFailureHandler(function(error){showToast('新增失敗: '+error.message,'error');}).addProducts(productBatch);}function submitBulkTransactions(){if(transactionBatch.length===0){showToast('請先新增交易','error');return;}closeModal('transaction-modal');showToast('正在處理交易...','info');google.script.run.withSuccessHandler(function(){showToast('交易處理成功','success');refreshData();}).withFailureHandler(function(error){showToast('交易失敗: '+error.message,'error');}).addBulkTransactionsAndUpdateInventory(transactionBatch);}function populateSelects(){populateTransactionSelects();populateInventoryFilters();}function populateTransactionSelects(){const productSelect=document.getElementById('transaction-product');const locationSelect=document.getElementById('transaction-location');productSelect.innerHTML='<option value="">選擇產品</option>';appData.products.forEach(product=>{productSelect.innerHTML+=`<option value="${product.ProductID}">${product.ProductName} (${product.Brand})</option>`;});locationSelect.innerHTML='<option value="">選擇地點</option>';appData.locations.forEach(location=>{locationSelect.innerHTML+=`<option value="${location.LocationID}">${location.LocationName}</option>`;});}function populateInventoryFilters(){const locationFilter=document.getElementById('inventory-location-filter');const brandFilter=document.getElementById('inventory-brand-filter');const categoryFilter=document.getElementById('inventory-category-filter');locationFilter.innerHTML='<option value="">所有地點</option>';appData.locations.forEach(location=>{locationFilter.innerHTML+=`<option value="${location.LocationID}">${location.LocationName}</option>`;});const brands=[...new Set(appData.products.map(p=>p.Brand))];brandFilter.innerHTML='<option value="">所有品牌</option>';brands.forEach(brand=>{brandFilter.innerHTML+=`<option value="${brand}">${brand}</option>`;});const categories=[...new Set(appData.products.map(p=>p.Category))];categoryFilter.innerHTML='<option value="">所有類別</option>';categories.forEach(category=>{categoryFilter.innerHTML+=`<option value="${category}">${category}</option>`;});}function updateQuantityInput(change){const input=document.getElementById('transaction-quantity');let currentValue=parseInt(input.value)||1;currentValue+=change;if(currentValue<1)currentValue=1;input.value=currentValue;}function getCurrentStock(productId,locationId){const inventoryItem=appData.inventory.find(item=>item.ProductID===productId&&item.LocationID===locationId);return inventoryItem?inventoryItem.Quantity:0;}function refreshData(){google.script.run.withSuccessHandler(function(data){initializeAppData(data);}).withFailureHandler(function(error){showToast('資料刷新失敗: '+error.message,'error');}).getAllInitialData();}function showToast(message,type='info'){const existingToast=document.querySelector('.toast');if(existingToast){existingToast.remove();}const toast=document.createElement('div');toast.className=`toast ${type}`;toast.textContent=message;document.body.appendChild(toast);setTimeout(()=>toast.classList.add('show'),100);setTimeout(()=>{toast.classList.remove('show');setTimeout(()=>toast.remove(),300);},3000);}document.addEventListener('DOMContentLoaded',function(){initializeApp();document.querySelectorAll('.modal').forEach(modal=>{modal.addEventListener('click',function(e){if(e.target===modal){modal.classList.remove('active');}});});document.getElementById('new-location-name').addEventListener('keypress',function(e){if(e.key==='Enter')addLocationToBatch();});});</script></body></html>
